rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {
    
    // Helper function to check if user is admin
    function isAdmin() {
      return request.auth != null && 
             exists(/databases/$(database)/documents/admins/$(request.auth.uid));
    }
    
    // Notices collection
    match /notices/{noticeId} {
      // Anyone can read notices
      allow read: if true;
      
      // Only admins can create, update (full), or delete notices
      allow create, delete: if isAdmin();
      
      // Admins can update any field
      allow update: if isAdmin();
      
      // Users can update ONLY the pollVotes field (for voting)
      allow update: if request.auth != null && 
                       request.resource.data.diff(resource.data).affectedKeys().hasOnly(['pollVotes']) &&
                       resource.data.get('isPoll', false) == true;
      
      // Comments subcollection
      match /comments/{commentId} {
        // Anyone can read comments
        allow read: if true;
        
        // Authenticated users can create comments
        allow create: if request.auth != null &&
                         request.resource.data.userId == request.auth.uid &&
                         request.resource.data.keys().hasAll(['text', 'userId', 'userName', 'time']);
        
        // Admins can delete any comment, or comment owner can delete their own
        allow delete: if isAdmin() || 
                         (request.auth != null && resource.data.userId == request.auth.uid);
      }
      
      // Votes subcollection
      match /votes/{userId} {
        // Anyone can read votes (for counting)
        allow read: if true;
        
        // Users can only create/update their own vote document
        allow create, update: if request.auth != null && 
                                 request.auth.uid == userId &&
                                 request.resource.data.keys().hasAll(['option', 'time']);
        
        // Admins can delete any vote document (for user cleanup)
        allow delete: if isAdmin();
      }
    }
    
    // Exams/Events collection
    match /exams/{examId} {
      allow read: if true;
      allow create, update, delete: if isAdmin();
    }
    
    // Routines collection
    match /routines/{routineId} {
      allow read: if true;
      allow create, update, delete: if isAdmin();
    }
    
    // Admins collection (read-only via Firestore, write via console)
    match /admins/{userId} {
      allow read: if request.auth != null && request.auth.uid == userId;
      allow write: if false; // Only set manually via Firebase Console
    }
    
    // Users collection
    match /users/{userId} {
      // Users can read their own profile, admins can read all
      allow read: if (request.auth != null && request.auth.uid == userId) || isAdmin();
      
      // Users can write/update their own profile
      // profilePicUrl now stores base64 data:image strings (no storage needed)
      allow write: if request.auth != null && 
                      request.auth.uid == userId &&
                      request.resource.data.keys().hasAny(['name', 'registrationId', 'department', 'bloodGroup', 'mobile', 'email', 'profilePicUrl', 'updatedAt']);
      
      // Admins can update any user (for deactivation, reactivation, deletion)
      allow update, delete: if isAdmin();
      
      // Settings subcollection
      match /settings/{doc} {
        allow read, write: if request.auth != null && request.auth.uid == userId;
        // Admins can delete user settings
        allow delete: if isAdmin();
      }
    }
  }
}
