// lib/main.dart
// Infyners - Batch Notice App
// Single-file: Firebase Auth, Firestore (notices, exams, routines), local notifications
// Keep firebase_options.dart generated by `flutterfire configure` in the same folder.

import 'dart:async';
import 'dart:convert';
import 'dart:typed_data';
import 'package:flutter/material.dart';
import 'package:flutter/services.dart';
import 'package:flutter/foundation.dart' show kIsWeb;
import 'package:google_fonts/google_fonts.dart';
import 'package:firebase_core/firebase_core.dart';
import 'package:firebase_auth/firebase_auth.dart';
import 'package:cloud_firestore/cloud_firestore.dart';
import 'package:flutter_local_notifications/flutter_local_notifications.dart';
import 'package:firebase_messaging/firebase_messaging.dart';
import 'package:fluttertoast/fluttertoast.dart';
import 'package:intl/intl.dart';
import 'package:timezone/data/latest.dart' as tz;
import 'package:timezone/timezone.dart' as tz;
import 'package:url_launcher/url_launcher.dart';
import 'package:image_picker/image_picker.dart';
import 'package:pdf/pdf.dart';
import 'package:pdf/widgets.dart' as pw;
import 'package:printing/printing.dart';
import 'firebase_options.dart';

// -------------------- Modern Glassmorphism Color Palette --------------------
const Color neonCyan = Color(0xFF00E5FF);
const Color electricPurple = Color(0xFF7C4DFF);
const Color darkBg = Color(0xFF0A0E27);
const Color darkCard = Color(0xFF1A1F3A);
const Color glassLight = Color(0xFFFFFFFF);
const Color accentPink = Color(0xFFFF006E);
const Color accentGreen = Color(0xFF00D084);

// Glassmorphism utility
class GlassmorphicContainer extends StatelessWidget {
  final Widget child;
  final EdgeInsets padding;
  final double opacity;
  final Color borderColor;
  final Color? backgroundColor;
  final double borderWidth;
  final BorderRadius borderRadius;

  const GlassmorphicContainer({
    required this.child,
    this.padding = const EdgeInsets.all(16),
    this.opacity = 0.1,
    this.borderColor = glassLight,
    this.backgroundColor,
    this.borderWidth = 1.5,
    this.borderRadius = const BorderRadius.all(Radius.circular(28)),
    super.key,
  });

  @override
  Widget build(BuildContext context) {
    return Container(
      padding: padding,
      decoration: BoxDecoration(
        color: backgroundColor ?? glassLight.withOpacity(opacity),
        borderRadius: borderRadius,
        border: Border.all(
          color: borderColor.withOpacity(0.2),
          width: borderWidth,
        ),
        boxShadow: [
          BoxShadow(
            color: Colors.black.withOpacity(0.1),
            blurRadius: 20,
            offset: const Offset(0, 8),
          ),
        ],
      ),
      child: child,
    );
  }
}

// -------------------- Notifications Setup --------------------
final FlutterLocalNotificationsPlugin flutterLocalNotificationsPlugin =
    FlutterLocalNotificationsPlugin();

// Background message handler for FCM
Future<void> _firebaseMessagingBackgroundHandler(RemoteMessage message) async {
  await Firebase.initializeApp(options: DefaultFirebaseOptions.currentPlatform);
  await showNotification(
    message.notification?.title ?? 'New Notification',
    message.notification?.body ?? 'You have a new message',
  );
}

Future<void> initializeNotifications() async {
  // Initialize timezone data
  tz.initializeTimeZones();

  // Remove FlutterNativeTimezone usage
  // Set your local timezone manually or default to UTC
  tz.setLocalLocation(
      tz.getLocation('UTC')); // <- just UTC or your preferred timezone

  const AndroidInitializationSettings androidInit =
      AndroidInitializationSettings('@mipmap/ic_launcher');

  const InitializationSettings initSettings = InitializationSettings(
    android: androidInit,
  );

  await flutterLocalNotificationsPlugin.initialize(initSettings);

  // Request permissions for iOS/macOS
  await flutterLocalNotificationsPlugin
      .resolvePlatformSpecificImplementation<
          IOSFlutterLocalNotificationsPlugin>()
      ?.requestPermissions(alert: true, badge: true, sound: true);

  await flutterLocalNotificationsPlugin
      .resolvePlatformSpecificImplementation<
          MacOSFlutterLocalNotificationsPlugin>()
      ?.requestPermissions(alert: true, badge: true, sound: true);

  // Firebase Cloud Messaging setup (Android/iOS only)
  if (!kIsWeb) {
    FirebaseMessaging.onBackgroundMessage(_firebaseMessagingBackgroundHandler);

    // Handle foreground messages
    FirebaseMessaging.onMessage.listen((RemoteMessage message) {
      showNotification(
        message.notification?.title ?? 'New Notification',
        message.notification?.body ?? 'You have a new message',
      );
    });

    // Request notification permissions for Android 13+
    await FirebaseMessaging.instance.requestPermission();

    // Subscribe to 'all_users' topic for broadcast notifications
    try {
      await FirebaseMessaging.instance.subscribeToTopic('all_users');
    } catch (e) {
      // Ignore subscription errors
    }
  }
}

Future<void> showNotification(String title, String body) async {
  const AndroidNotificationDetails androidDetails = AndroidNotificationDetails(
    'infyners_channel',
    'Infyners Notifications',
    channelDescription: 'Notifications for Infyners app',
    importance: Importance.max,
    priority: Priority.high,
    showWhen: true,
  );

  const NotificationDetails platformDetails =
      NotificationDetails(android: androidDetails);

  await flutterLocalNotificationsPlugin.show(
    DateTime.now().millisecond,
    title,
    body,
    platformDetails,
    payload: null,
  );
}

// -------------------- Admin Helper --------------------
// Checks two places: /admins/{uid} and /users/{uid} role/isAdmin flag.
// Returns false on error or if not signed-in.
Future<bool> isCurrentUserAdmin() async {
  final user = FirebaseAuth.instance.currentUser;
  if (user == null) return false;
  final uid = user.uid;

  try {
    // Preferred: admins collection
    final adminDoc =
        await FirebaseFirestore.instance.collection('admins').doc(uid).get();
    if (adminDoc.exists) return true;

    // Fallback: users collection with role/isAdmin
    final userDoc =
        await FirebaseFirestore.instance.collection('users').doc(uid).get();
    if (userDoc.exists) {
      final data = userDoc.data()!;
      if (data['role'] == 'admin' || data['isAdmin'] == true) return true;
    }
  } catch (e) {
    debugPrint('Admin check error: $e');
  }
  return false;
}

// -------------------- Main --------------------
Future<void> main() async {
  WidgetsFlutterBinding.ensureInitialized();
  await Firebase.initializeApp(options: DefaultFirebaseOptions.currentPlatform);
  await initializeNotifications();
  // Apply user theme preference if already signed in
  try {
    final uid = FirebaseAuth.instance.currentUser?.uid;
    if (uid != null) {
      final doc = await FirebaseFirestore.instance
          .collection('users')
          .doc(uid)
          .collection('settings')
          .doc('prefs')
          .get();
      final data = doc.data() ?? {};
      final dark = (data['darkMode'] ?? false) as bool;
      themeController.setMode(dark ? ThemeMode.dark : ThemeMode.light);
    }
  } catch (_) {}
  runApp(const InfynersApp());
}

// -------------------- Theme Controller --------------------
class ThemeController extends ChangeNotifier {
  // Default to light so the app isn't forced into dark
  // unless the user has explicitly enabled it in Settings.
  ThemeMode _mode = ThemeMode.light;
  ThemeMode get mode => _mode;
  void setMode(ThemeMode m) {
    if (_mode != m) {
      _mode = m;
      notifyListeners();
    }
  }
}

final ThemeController themeController = ThemeController();

class InfynersApp extends StatelessWidget {
  const InfynersApp({super.key});

  ThemeData _buildLightTheme() {
    final base = ThemeData(
      colorSchemeSeed: Colors.blue, // Changed from indigo to vibrant blue
      useMaterial3: true,
      brightness: Brightness.light,
      textTheme: GoogleFonts.poppinsTextTheme(),
      scaffoldBackgroundColor: const Color(0xFFFAFAFA),
    );
    return base.copyWith(
      cardTheme: const CardThemeData(
        elevation: 2,
        shape: RoundedRectangleBorder(
            borderRadius: BorderRadius.all(Radius.circular(16))),
        color: Colors.white,
      ),
      appBarTheme: const AppBarTheme(
        elevation: 0,
        centerTitle: false,
        backgroundColor: Colors.blue,
        foregroundColor: Colors.white,
      ),
      inputDecorationTheme: InputDecorationTheme(
        filled: true,
        fillColor: Colors.grey.shade50,
        labelStyle: const TextStyle(color: Colors.black87),
        hintStyle: TextStyle(color: Colors.grey.shade500),
        border: OutlineInputBorder(
          borderRadius: BorderRadius.circular(12),
          borderSide: BorderSide.none,
        ),
        enabledBorder: OutlineInputBorder(
          borderRadius: BorderRadius.circular(12),
          borderSide: BorderSide(color: Colors.grey.shade200),
        ),
        focusedBorder: OutlineInputBorder(
          borderRadius: BorderRadius.circular(12),
          borderSide: const BorderSide(color: Colors.blue, width: 2),
        ),
      ),
      elevatedButtonTheme: ElevatedButtonThemeData(
        style: ElevatedButton.styleFrom(
          elevation: 0,
          shape:
              RoundedRectangleBorder(borderRadius: BorderRadius.circular(12)),
          padding: const EdgeInsets.symmetric(vertical: 16, horizontal: 24),
        ),
      ),
    );
  }

  ThemeData _buildDarkTheme() {
    final base = ThemeData(
      colorSchemeSeed: Colors.blue,
      useMaterial3: true,
      brightness: Brightness.dark,
      textTheme: GoogleFonts.poppinsTextTheme(
          ThemeData(brightness: Brightness.dark).textTheme),
      scaffoldBackgroundColor: const Color(0xFF121212),
    );
    return base.copyWith(
      cardTheme: const CardThemeData(
        elevation: 2,
        shape: RoundedRectangleBorder(
            borderRadius: BorderRadius.all(Radius.circular(16))),
        color: Color(0xFF1E1E1E),
      ),
      appBarTheme: const AppBarTheme(
        elevation: 0,
        centerTitle: false,
        backgroundColor: Colors.blue,
        foregroundColor: Colors.white,
      ),
      navigationBarTheme: NavigationBarThemeData(
        labelTextStyle: WidgetStateProperty.resolveWith(
          (states) {
            if (states.contains(WidgetState.selected)) {
              return GoogleFonts.outfit(
                color: const Color(0xFF00E5FF),
                fontSize: 12,
                fontWeight: FontWeight.bold,
              );
            }
            return GoogleFonts.outfit(
              color: Colors.white,
              fontSize: 12,
              fontWeight: FontWeight.w500,
            );
          },
        ),
      ),
      inputDecorationTheme: InputDecorationTheme(
        filled: true,
        fillColor: const Color(0xFF2C2C2C),
        labelStyle: const TextStyle(color: Colors.white70),
        hintStyle: const TextStyle(color: Colors.white60),
        border: OutlineInputBorder(
          borderRadius: BorderRadius.circular(12),
          borderSide: BorderSide.none,
        ),
        enabledBorder: OutlineInputBorder(
          borderRadius: BorderRadius.circular(12),
          borderSide: const BorderSide(color: Colors.white24),
        ),
        focusedBorder: OutlineInputBorder(
          borderRadius: BorderRadius.circular(12),
          borderSide: const BorderSide(color: Colors.blueAccent, width: 2),
        ),
      ),
      elevatedButtonTheme: ElevatedButtonThemeData(
        style: ElevatedButton.styleFrom(
          elevation: 0,
          shape:
              RoundedRectangleBorder(borderRadius: BorderRadius.circular(12)),
          padding: const EdgeInsets.symmetric(vertical: 16, horizontal: 24),
        ),
      ),
    );
  }

  @override
  Widget build(BuildContext context) {
    return AnimatedBuilder(
      animation: themeController,
      builder: (context, _) {
        return MaterialApp(
          title: 'Infyners',
          debugShowCheckedModeBanner: false,
          theme: _buildLightTheme(),
          darkTheme: _buildDarkTheme(),
          themeMode: themeController.mode,
          home: const AuthGate(),
        );
      },
    );
  }
}

// -------------------- Auth Gate --------------------
class AuthGate extends StatefulWidget {
  const AuthGate({super.key});
  static bool _themeInitialized = false;

  @override
  State<AuthGate> createState() => _AuthGateState();
}

class _AuthGateState extends State<AuthGate> {
  Future<void> _applyUserThemePref() async {
    final uid = FirebaseAuth.instance.currentUser?.uid;
    if (uid == null) return;
    try {
      final doc = await FirebaseFirestore.instance
          .collection('users')
          .doc(uid)
          .collection('settings')
          .doc('prefs')
          .get();
      final data = doc.data() ?? {};
      final dark = (data['darkMode'] ?? false) as bool;
      themeController.setMode(dark ? ThemeMode.dark : ThemeMode.light);
    } catch (_) {}
  }

  @override
  Widget build(BuildContext context) {
    return StreamBuilder<User?>(
      stream: FirebaseAuth.instance.authStateChanges(),
      builder: (context, snapshot) {
        if (snapshot.connectionState == ConnectionState.waiting) {
          return const Scaffold(
              body: Center(child: CircularProgressIndicator()));
        }
        if (snapshot.hasData) {
          if (!AuthGate._themeInitialized) {
            AuthGate._themeInitialized = true;
            _applyUserThemePref();
            FirebaseFirestore.instance
                .collection('users')
                .doc(FirebaseAuth.instance.currentUser!.uid)
                .collection('settings')
                .doc('prefs')
                .snapshots()
                .listen((doc) {
              final data = doc.data() ?? {};
              final dark = (data['darkMode'] ?? false) as bool;
              themeController.setMode(dark ? ThemeMode.dark : ThemeMode.light);
            });
          }
          return const HomePage();
        } else {
          // Check if user has seen onboarding
          return const GetStartedPage();
        }
      },
    );
  }
}

// -------------------- Get Started Onboarding Page --------------------
class GetStartedPage extends StatefulWidget {
  const GetStartedPage({super.key});
  @override
  State<GetStartedPage> createState() => _GetStartedPageState();
}

class _GetStartedPageState extends State<GetStartedPage>
    with TickerProviderStateMixin {
  late PageController _pageController;
  int _currentPage = 0;
  late AnimationController _scaleAnimController;
  late AnimationController _slideAnimController;

  final onboardingSteps = [
    {
      'title': 'Welcome to INFYNERS',
      'subtitle': 'Batch Notices & Updates',
      'description':
          'Stay connected with your batch. Get real-time notifications for all important updates.',
      'icon': Icons.notifications_active,
      'color': neonCyan,
    },
    {
      'title': 'Smart Notices',
      'subtitle': 'Never Miss Important Updates',
      'description':
          'Receive instant notifications for class notices, exam schedules, and important announcements.',
      'icon': Icons.announcement,
      'color': electricPurple,
    },
    {
      'title': 'Interactive Polls',
      'subtitle': 'Voice Your Opinion',
      'description':
          'Participate in class polls and surveys. Your opinion matters to the community.',
      'icon': Icons.how_to_vote,
      'color': accentGreen,
    },
    {
      'title': 'Event Tracking',
      'subtitle': 'Never Miss Deadlines',
      'description':
          'Track exams, assignments, and class routines all in one place.',
      'icon': Icons.event,
      'color': accentPink,
    },
  ];

  @override
  void initState() {
    super.initState();
    _pageController = PageController();
    _scaleAnimController = AnimationController(
      duration: const Duration(milliseconds: 800),
      vsync: this,
    )..forward();
    _slideAnimController = AnimationController(
      duration: const Duration(milliseconds: 1000),
      vsync: this,
    )..forward();
  }

  @override
  void dispose() {
    _pageController.dispose();
    _scaleAnimController.dispose();
    _slideAnimController.dispose();
    super.dispose();
  }

  @override
  Widget build(BuildContext context) {
    return Scaffold(
      body: Stack(
        children: [
          // Animated Background Gradient
          AnimatedBuilder(
            animation: _slideAnimController,
            builder: (context, child) {
              return Container(
                decoration: BoxDecoration(
                  gradient: LinearGradient(
                    begin: Alignment.topLeft,
                    end: Alignment.bottomRight,
                    colors: [
                      Color.lerp(
                        darkBg,
                        const Color(0xFF1A0033),
                        _slideAnimController.value,
                      )!,
                      Color.lerp(
                        const Color(0xFF0A0E27),
                        electricPurple.withOpacity(0.3),
                        _slideAnimController.value,
                      )!,
                    ],
                  ),
                ),
              );
            },
          ),
          // Animated Circles
          Positioned(
            top: -100,
            right: -100,
            child: ScaleTransition(
              scale: Tween<double>(begin: 0.8, end: 1.0)
                  .animate(_scaleAnimController),
              child: Container(
                width: 300,
                height: 300,
                decoration: BoxDecoration(
                  shape: BoxShape.circle,
                  color: neonCyan.withOpacity(0.1),
                ),
              ),
            ),
          ),
          Positioned(
            bottom: -80,
            left: -80,
            child: ScaleTransition(
              scale: Tween<double>(begin: 0.8, end: 1.0)
                  .animate(_scaleAnimController),
              child: Container(
                width: 250,
                height: 250,
                decoration: BoxDecoration(
                  shape: BoxShape.circle,
                  color: electricPurple.withOpacity(0.1),
                ),
              ),
            ),
          ),
          // Content
          PageView.builder(
            controller: _pageController,
            onPageChanged: (index) => setState(() => _currentPage = index),
            itemCount: onboardingSteps.length,
            itemBuilder: (context, index) {
              final step = onboardingSteps[index];
              return _buildOnboardingScreen(
                title: step['title'].toString(),
                subtitle: step['subtitle'].toString(),
                description: step['description'].toString(),
                icon: step['icon'] as IconData,
                color: step['color'] as Color,
              );
            },
          ),
          // Bottom Navigation
          Positioned(
            bottom: 0,
            left: 0,
            right: 0,
            child: Container(
              padding: const EdgeInsets.all(24),
              decoration: BoxDecoration(
                gradient: LinearGradient(
                  begin: Alignment.topCenter,
                  end: Alignment.bottomCenter,
                  colors: [
                    Colors.transparent,
                    darkBg.withOpacity(0.8),
                  ],
                ),
              ),
              child: Column(
                children: [
                  // Dots Indicator
                  Row(
                    mainAxisAlignment: MainAxisAlignment.center,
                    children: List.generate(
                      onboardingSteps.length,
                      (index) => AnimatedContainer(
                        duration: const Duration(milliseconds: 300),
                        margin: const EdgeInsets.symmetric(horizontal: 4),
                        width: _currentPage == index ? 32 : 8,
                        height: 8,
                        decoration: BoxDecoration(
                          borderRadius: BorderRadius.circular(4),
                          color: _currentPage == index
                              ? neonCyan
                              : Colors.white.withOpacity(0.3),
                        ),
                      ),
                    ),
                  ),
                  const SizedBox(height: 32),
                  // Buttons
                  if (_currentPage < onboardingSteps.length - 1) ...[
                    SizedBox(
                      width: double.infinity,
                      height: 56,
                      child: Container(
                        decoration: BoxDecoration(
                          gradient: const LinearGradient(
                            colors: [neonCyan, electricPurple],
                          ),
                          borderRadius: BorderRadius.circular(16),
                          boxShadow: [
                            BoxShadow(
                              color: neonCyan.withOpacity(0.4),
                              blurRadius: 20,
                              offset: const Offset(0, 8),
                            ),
                          ],
                        ),
                        child: Material(
                          color: Colors.transparent,
                          child: InkWell(
                            onTap: () {
                              _pageController.nextPage(
                                duration: const Duration(milliseconds: 500),
                                curve: Curves.easeInOutCubic,
                              );
                            },
                            borderRadius: BorderRadius.circular(16),
                            child: Row(
                              mainAxisAlignment: MainAxisAlignment.center,
                              children: [
                                Text(
                                  'Next',
                                  style: GoogleFonts.outfit(
                                    fontSize: 18,
                                    fontWeight: FontWeight.bold,
                                    color: darkBg,
                                    letterSpacing: 1,
                                  ),
                                ),
                                const SizedBox(width: 8),
                                const Icon(Icons.arrow_forward,
                                    color: Colors.black87),
                              ],
                            ),
                          ),
                        ),
                      ),
                    ),
                    const SizedBox(height: 12),
                    SizedBox(
                      width: double.infinity,
                      height: 56,
                      child: Material(
                        color: Colors.transparent,
                        child: InkWell(
                          onTap: () {
                            Navigator.of(context).pushReplacement(
                              MaterialPageRoute(
                                  builder: (_) => const LoginPage()),
                            );
                          },
                          child: Container(
                            decoration: BoxDecoration(
                              border: Border.all(
                                  color: Colors.white.withOpacity(0.3),
                                  width: 1.5),
                              borderRadius: BorderRadius.circular(16),
                              color: Colors.white.withOpacity(0.05),
                            ),
                            child: Center(
                              child: Text(
                                'Skip',
                                style: GoogleFonts.outfit(
                                  fontSize: 16,
                                  fontWeight: FontWeight.w600,
                                  color: Colors.white,
                                  letterSpacing: 1,
                                ),
                              ),
                            ),
                          ),
                        ),
                      ),
                    ),
                  ] else ...[
                    SizedBox(
                      width: double.infinity,
                      height: 56,
                      child: Container(
                        decoration: BoxDecoration(
                          gradient: const LinearGradient(
                            colors: [neonCyan, electricPurple],
                          ),
                          borderRadius: BorderRadius.circular(16),
                          boxShadow: [
                            BoxShadow(
                              color: neonCyan.withOpacity(0.4),
                              blurRadius: 20,
                              offset: const Offset(0, 8),
                            ),
                          ],
                        ),
                        child: Material(
                          color: Colors.transparent,
                          child: InkWell(
                            onTap: () {
                              Navigator.of(context).pushReplacement(
                                MaterialPageRoute(
                                    builder: (_) => const LoginPage()),
                              );
                            },
                            borderRadius: BorderRadius.circular(16),
                            child: Row(
                              mainAxisAlignment: MainAxisAlignment.center,
                              children: [
                                Text(
                                  'Get Started',
                                  style: GoogleFonts.outfit(
                                    fontSize: 18,
                                    fontWeight: FontWeight.bold,
                                    color: darkBg,
                                    letterSpacing: 1,
                                  ),
                                ),
                                const SizedBox(width: 8),
                                const Icon(Icons.arrow_forward,
                                    color: Colors.black87),
                              ],
                            ),
                          ),
                        ),
                      ),
                    ),
                  ],
                ],
              ),
            ),
          ),
        ],
      ),
    );
  }

  Widget _buildOnboardingScreen({
    required String title,
    required String subtitle,
    required String description,
    required IconData icon,
    required Color color,
  }) {
    return Column(
      mainAxisAlignment: MainAxisAlignment.center,
      crossAxisAlignment: CrossAxisAlignment.center,
      children: [
        // Icon Container
        ScaleTransition(
          scale:
              Tween<double>(begin: 0.5, end: 1.0).animate(_scaleAnimController),
          child: Container(
            width: 120,
            height: 120,
            decoration: BoxDecoration(
              shape: BoxShape.circle,
              gradient: LinearGradient(
                begin: Alignment.topLeft,
                end: Alignment.bottomRight,
                colors: [
                  color.withOpacity(0.3),
                  color.withOpacity(0.08),
                ],
              ),
              border: Border.all(color: color.withOpacity(0.5), width: 2.5),
              boxShadow: [
                BoxShadow(
                  color: color.withOpacity(0.4),
                  blurRadius: 20,
                  offset: const Offset(0, 8),
                ),
              ],
            ),
            child: Icon(icon, size: 65, color: color),
          ),
        ),
        const SizedBox(height: 48),
        // Title
        Padding(
          padding: EdgeInsets.symmetric(
            horizontal: MediaQuery.of(context).size.width < 360 ? 16 : 24,
          ),
          child: Text(
            title,
            textAlign: TextAlign.center,
            style: GoogleFonts.outfit(
              fontSize: 32,
              fontWeight: FontWeight.bold,
              color: Colors.white,
              letterSpacing: -0.5,
            ),
          ),
        ),
        const SizedBox(height: 8),
        // Subtitle
        Text(
          subtitle,
          textAlign: TextAlign.center,
          style: GoogleFonts.outfit(
            fontSize: 17,
            fontWeight: FontWeight.w600,
            color: Colors.white,
            letterSpacing: 1,
            shadows: [
              Shadow(
                color: color.withOpacity(0.5),
                offset: const Offset(0, 2),
                blurRadius: 6,
              ),
            ],
          ),
        ),
        const SizedBox(height: 24),
        // Description
        Padding(
          padding: const EdgeInsets.symmetric(horizontal: 32),
          child: Text(
            description,
            textAlign: TextAlign.center,
            style: GoogleFonts.outfit(
              fontSize: 15,
              color: Colors.white.withOpacity(0.95),
              height: 1.6,
              fontWeight: FontWeight.w400,
              shadows: [
                Shadow(
                  color: Colors.black.withOpacity(0.4),
                  offset: const Offset(0, 1),
                  blurRadius: 3,
                ),
              ],
            ),
          ),
        ),
      ],
    );
  }
}

// -------------------- Login Page --------------------
class LoginPage extends StatefulWidget {
  const LoginPage({super.key});
  @override
  State<LoginPage> createState() => _LoginPageState();
}

class _LoginPageState extends State<LoginPage> {
  final email = TextEditingController();
  final password = TextEditingController();
  bool _loading = false;
  bool _obscurePassword = true;

  Future<void> login() async {
    final emailText = email.text.trim();
    final passwordText = password.text.trim();

    // Validate inputs
    if (emailText.isEmpty || passwordText.isEmpty) {
      Fluttertoast.showToast(msg: 'Please fill in all fields');
      return;
    }

    setState(() => _loading = true);
    try {
      final credential = await FirebaseAuth.instance.signInWithEmailAndPassword(
        email: emailText,
        password: passwordText,
      );

      final userId = credential.user?.uid;
      if (userId != null) {
        final userDoc = await FirebaseFirestore.instance
            .collection('users')
            .doc(userId)
            .get();

        if (userDoc.exists) {
          final userData = userDoc.data();
          final isActive = userData?['isActive'] ?? true;

          if (!isActive) {
            await FirebaseAuth.instance.signOut();
            if (mounted) setState(() => _loading = false);
            Fluttertoast.showToast(
              msg: 'Your account has been deactivated. Please contact admin.',
              toastLength: Toast.LENGTH_LONG,
            );
            return;
          }
        }
      }

      // Login successful
      Fluttertoast.showToast(msg: "Login successful!");

      // Small delay to ensure Firebase updates auth state
      await Future.delayed(const Duration(milliseconds: 800));

      if (mounted) {
        setState(() => _loading = false);
        // Navigate to HomePage directly
        Navigator.of(context).pushReplacement(
          MaterialPageRoute(builder: (_) => const HomePage()),
        );
      }
    } on FirebaseAuthException catch (e) {
      if (mounted) setState(() => _loading = false);
      String message = 'Login failed';
      if (e.code == 'user-not-found') {
        message = 'No account found with this email';
      } else if (e.code == 'wrong-password') {
        message = 'Incorrect password';
      } else if (e.code == 'invalid-email') {
        message = 'Invalid email address';
      } else if (e.code == 'user-disabled') {
        message = 'This account has been disabled';
      }
      Fluttertoast.showToast(msg: message);
    } catch (e) {
      if (mounted) setState(() => _loading = false);
      Fluttertoast.showToast(msg: "Error: ${e.toString()}");
    }
  }

  Future<void> _forgotPassword() async {
    final emailText = email.text.trim();
    if (emailText.isEmpty) {
      Fluttertoast.showToast(msg: 'Please enter your email');
      return;
    }

    try {
      await FirebaseAuth.instance.sendPasswordResetEmail(email: emailText);
      if (mounted) {
        showDialog(
          context: context,
          builder: (context) => AlertDialog(
            title: const Text('Email Sent'),
            content: Text(
                'Password reset link has been sent to $emailText\n\nCheck your inbox and follow the link to reset your password.'),
            actions: [
              TextButton(
                onPressed: () => Navigator.pop(context),
                child: const Text('OK'),
              ),
            ],
          ),
        );
      }
    } on FirebaseAuthException catch (e) {
      String message = 'Failed to send reset email';
      if (e.code == 'user-not-found') {
        message = 'No account found with this email';
      } else if (e.code == 'invalid-email') {
        message = 'Invalid email address';
      }
      Fluttertoast.showToast(msg: message);
    }
  }

  @override
  void dispose() {
    email.dispose();
    password.dispose();
    super.dispose();
  }

  @override
  Widget build(BuildContext context) {
    return Scaffold(
      body: Stack(
        children: [
          // Animated Blur Background with Gradient
          Container(
            decoration: BoxDecoration(
              gradient: LinearGradient(
                begin: Alignment.topLeft,
                end: Alignment.bottomRight,
                colors: [
                  darkBg,
                  const Color(0xFF1A1F3A),
                  electricPurple.withOpacity(0.2),
                ],
              ),
            ),
          ),
          // Animated decorative circles
          Positioned(
            top: -100,
            right: -100,
            child: Container(
              width: 300,
              height: 300,
              decoration: BoxDecoration(
                shape: BoxShape.circle,
                color: neonCyan.withOpacity(0.1),
              ),
            ),
          ),
          Positioned(
            bottom: -80,
            left: -80,
            child: Container(
              width: 250,
              height: 250,
              decoration: BoxDecoration(
                shape: BoxShape.circle,
                color: electricPurple.withOpacity(0.1),
              ),
            ),
          ),
          // Main Content
          SafeArea(
            child: Center(
              child: SingleChildScrollView(
                padding: EdgeInsets.symmetric(
                  horizontal: MediaQuery.of(context).size.width < 360 ? 16 : 24,
                ),
                child: Column(
                  mainAxisAlignment: MainAxisAlignment.center,
                  children: [
                    // Animated Logo
                    TweenAnimationBuilder<double>(
                      tween: Tween(begin: 0.8, end: 1.0),
                      duration: const Duration(milliseconds: 800),
                      builder: (context, value, child) {
                        return Transform.scale(
                          scale: value,
                          child: child,
                        );
                      },
                      child: Container(
                        width: 100,
                        height: 100,
                        decoration: BoxDecoration(
                          shape: BoxShape.circle,
                          gradient: LinearGradient(
                            colors: [
                              neonCyan.withOpacity(0.3),
                              electricPurple.withOpacity(0.3),
                            ],
                          ),
                          border: Border.all(color: neonCyan, width: 2),
                          boxShadow: [
                            BoxShadow(
                              color: neonCyan.withOpacity(0.3),
                              blurRadius: 30,
                              offset: const Offset(0, 10),
                            ),
                          ],
                        ),
                        child: const Icon(
                          Icons.school,
                          size: 60,
                          color: neonCyan,
                        ),
                      ),
                    ),
                    const SizedBox(height: 24),
                    Text(
                      "INFYNERS",
                      style: GoogleFonts.outfit(
                        fontSize: 40,
                        fontWeight: FontWeight.bold,
                        color: Colors.white,
                        letterSpacing: 3,
                      ),
                    ),
                    const SizedBox(height: 8),
                    ShaderMask(
                      shaderCallback: (bounds) => const LinearGradient(
                        colors: [neonCyan, electricPurple],
                      ).createShader(bounds),
                      child: Text(
                        "Batch Notice & Updates",
                        style: GoogleFonts.outfit(
                          fontSize: 14,
                          fontWeight: FontWeight.w300,
                          color: Colors.white,
                          letterSpacing: 2,
                        ),
                      ),
                    ),
                    const SizedBox(height: 48),

                    // Login Card - Glassmorphism
                    GlassmorphicContainer(
                      opacity: 0.15,
                      borderColor: neonCyan,
                      borderWidth: 1.5,
                      borderRadius: const BorderRadius.all(
                        Radius.circular(28),
                      ),
                      padding: const EdgeInsets.all(28),
                      child: Column(
                        mainAxisSize: MainAxisSize.min,
                        children: [
                          // Email Field
                          _buildGlassTextField(
                            controller: email,
                            label: "Email Address",
                            icon: Icons.email,
                            keyboardType: TextInputType.emailAddress,
                          ),
                          const SizedBox(height: 16),

                          // Password Field
                          _buildGlassTextField(
                            controller: password,
                            label: "Password",
                            icon: Icons.lock,
                            obscureText: _obscurePassword,
                            suffixIcon: IconButton(
                              icon: Icon(
                                _obscurePassword
                                    ? Icons.visibility
                                    : Icons.visibility_off,
                                color: neonCyan,
                              ),
                              onPressed: () => setState(
                                  () => _obscurePassword = !_obscurePassword),
                            ),
                          ),
                          const SizedBox(height: 8),

                          // Forgot Password
                          Align(
                            alignment: Alignment.centerRight,
                            child: TextButton(
                              onPressed: _forgotPassword,
                              child: Text(
                                'Forgot Password?',
                                style: TextStyle(
                                  color: neonCyan.withOpacity(0.9),
                                  fontWeight: FontWeight.w500,
                                  fontSize: 13,
                                ),
                              ),
                            ),
                          ),
                          const SizedBox(height: 16),

                          // Login Button - Animated Neon
                          _buildNeonButton(
                            onPressed: _loading ? null : login,
                            label: _loading ? "Signing in..." : "Login",
                            isLoading: _loading,
                            gradient: const LinearGradient(
                              colors: [neonCyan, electricPurple],
                            ),
                          ),

                          const SizedBox(height: 16),

                          // Sign Up Link - Increased tap area
                          GestureDetector(
                            onTap: () {
                              Navigator.of(context).push(
                                MaterialPageRoute(
                                  builder: (_) => const SignupPage(),
                                ),
                              );
                            },
                            child: Padding(
                              padding: const EdgeInsets.symmetric(
                                  vertical: 12, horizontal: 16),
                              child: Row(
                                mainAxisAlignment: MainAxisAlignment.center,
                                children: [
                                  Text(
                                    "Don't have an account? ",
                                    style: TextStyle(
                                      color: Colors.white.withOpacity(0.9),
                                      fontSize: 14,
                                    ),
                                  ),
                                  ShaderMask(
                                    shaderCallback: (bounds) => const LinearGradient(
                                      colors: [neonCyan, electricPurple],
                                    ).createShader(bounds),
                                    child: Text(
                                      'Sign Up',
                                      style: GoogleFonts.outfit(
                                        fontWeight: FontWeight.bold,
                                        fontSize: 14,
                                        color: Colors.white,
                                      ),
                                    ),
                                  ),
                                ],
                              ),
                            ),
                          ),
                        ],
                      ),
                    ),
                    const SizedBox(height: 32),
                    Text(
                      "Developed by Sagnik Saha Dibbay",
                      style: GoogleFonts.outfit(
                        fontSize: 11,
                        color: Colors.white.withOpacity(0.5),
                        letterSpacing: 0.5,
                      ),
                    ),
                  ],
                ),
              ),
            ),
          ),
        ],
      ),
    );
  }

  Widget _buildGlassTextField({
    required TextEditingController controller,
    required String label,
    required IconData icon,
    TextInputType keyboardType = TextInputType.text,
    bool obscureText = false,
    Widget? suffixIcon,
  }) {
    return Container(
      decoration: BoxDecoration(
        borderRadius: BorderRadius.circular(12),
        border: Border.all(color: neonCyan.withOpacity(0.3), width: 1),
        color: Colors.white.withOpacity(0.08),
      ),
      child: TextField(
        controller: controller,
        keyboardType: keyboardType,
        obscureText: obscureText,
        style: TextStyle(
          color: Colors.white,
          fontFamily: GoogleFonts.outfit().fontFamily,
        ),
        decoration: InputDecoration(
          labelText: label,
          labelStyle: TextStyle(
            color: Colors.white.withOpacity(0.7),
            fontFamily: GoogleFonts.outfit().fontFamily,
            fontSize: 13,
          ),
          prefixIcon: Icon(icon, color: neonCyan.withOpacity(0.8)),
          suffixIcon: suffixIcon,
          filled: false,
          border: InputBorder.none,
          contentPadding:
              const EdgeInsets.symmetric(horizontal: 16, vertical: 16),
          hintStyle: TextStyle(
            color: Colors.white.withOpacity(0.3),
          ),
        ),
      ),
    );
  }

  Widget _buildNeonButton({
    required VoidCallback? onPressed,
    required String label,
    required bool isLoading,
    required Gradient gradient,
  }) {
    return GestureDetector(
      onTap: onPressed,
      child: Container(
        width: double.infinity,
        height: 56,
        decoration: BoxDecoration(
          gradient: gradient,
          borderRadius: BorderRadius.circular(14),
          boxShadow: [
            BoxShadow(
              color: neonCyan.withOpacity(0.3),
              blurRadius: 20,
              offset: const Offset(0, 8),
            ),
            BoxShadow(
              color: electricPurple.withOpacity(0.2),
              blurRadius: 20,
              offset: const Offset(0, 8),
            ),
          ],
        ),
        child: Material(
          color: Colors.transparent,
          child: InkWell(
            onTap: onPressed,
            borderRadius: BorderRadius.circular(14),
            child: Center(
              child: isLoading
                  ? SizedBox(
                      width: 24,
                      height: 24,
                      child: CircularProgressIndicator(
                        strokeWidth: 2,
                        valueColor:
                            AlwaysStoppedAnimation(darkBg.withOpacity(0.8)),
                      ),
                    )
                  : Text(
                      label,
                      style: GoogleFonts.outfit(
                        fontSize: 16,
                        fontWeight: FontWeight.bold,
                        color: darkBg,
                        letterSpacing: 1,
                      ),
                    ),
            ),
          ),
        ),
      ),
    );
  }
}

// -------------------- Signup Page --------------------
class SignupPage extends StatefulWidget {
  const SignupPage({super.key});
  @override
  State<SignupPage> createState() => _SignupPageState();
}

class _SignupPageState extends State<SignupPage> {
  final _emailCtrl = TextEditingController();
  final _passwordCtrl = TextEditingController();
  final _confirmPasswordCtrl = TextEditingController();
  final _nameCtrl = TextEditingController();
  final _regIdCtrl = TextEditingController();
  final _deptCtrl = TextEditingController();
  final _bloodGroupCtrl = TextEditingController();
  final _mobileCtrl = TextEditingController();

  bool _loading = false;
  bool _obscurePassword = true;
  bool _obscureConfirmPassword = true;

  Future<void> _signup() async {
    final email = _emailCtrl.text.trim();
    final password = _passwordCtrl.text.trim();
    final confirmPassword = _confirmPasswordCtrl.text.trim();
    final name = _nameCtrl.text.trim();

    if (email.isEmpty || password.isEmpty || name.isEmpty) {
      Fluttertoast.showToast(msg: 'Please fill required fields');
      return;
    }

    if (password != confirmPassword) {
      Fluttertoast.showToast(msg: 'Passwords do not match');
      return;
    }

    if (password.length < 6) {
      Fluttertoast.showToast(msg: 'Password must be at least 6 characters');
      return;
    }

    setState(() => _loading = true);

    try {
      final credential =
          await FirebaseAuth.instance.createUserWithEmailAndPassword(
        email: email,
        password: password,
      );

      final uid = credential.user?.uid;
      if (uid == null) throw Exception('User creation failed');

      await FirebaseFirestore.instance.collection('users').doc(uid).set({
        'name': name,
        'registrationId': _regIdCtrl.text.trim(),
        'department': _deptCtrl.text.trim(),
        'bloodGroup': _bloodGroupCtrl.text.trim(),
        'mobile': _mobileCtrl.text.trim(),
        'email': email,
        'createdAt': FieldValue.serverTimestamp(),
      });

      Fluttertoast.showToast(msg: 'Account created successfully!');

      if (mounted) Navigator.of(context).pop();
    } on FirebaseAuthException catch (e) {
      String message = 'Signup failed';
      if (e.code == 'email-already-in-use') {
        message = 'This email is already registered';
      } else if (e.code == 'invalid-email') {
        message = 'Invalid email address';
      } else if (e.code == 'weak-password') {
        message = 'Password is too weak';
      }
      Fluttertoast.showToast(msg: message);
    } catch (e) {
      Fluttertoast.showToast(msg: 'Error: $e');
    } finally {
      if (mounted) setState(() => _loading = false);
    }
  }

  @override
  void dispose() {
    _emailCtrl.dispose();
    _passwordCtrl.dispose();
    _confirmPasswordCtrl.dispose();
    _nameCtrl.dispose();
    _regIdCtrl.dispose();
    _deptCtrl.dispose();
    _bloodGroupCtrl.dispose();
    _mobileCtrl.dispose();
    super.dispose();
  }

  @override
  Widget build(BuildContext context) {
    return Scaffold(
      body: Stack(
        children: [
          // Animated Gradient Background
          Container(
            decoration: BoxDecoration(
              gradient: LinearGradient(
                begin: Alignment.topLeft,
                end: Alignment.bottomRight,
                colors: [
                  darkBg,
                  const Color(0xFF1A1F3A),
                  electricPurple.withOpacity(0.2),
                ],
              ),
            ),
          ),
          // Decorative circles
          Positioned(
            top: -100,
            right: -100,
            child: Container(
              width: 300,
              height: 300,
              decoration: BoxDecoration(
                shape: BoxShape.circle,
                color: neonCyan.withOpacity(0.1),
              ),
            ),
          ),
          // Main Content
          Column(
            children: [
              // Custom App Bar
              SafeArea(
                bottom: false,
                child: Padding(
                  padding: const EdgeInsets.all(16),
                  child: Row(
                    children: [
                      GestureDetector(
                        onTap: () => Navigator.of(context).pop(),
                        child: Container(
                          padding: const EdgeInsets.all(12),
                          decoration: BoxDecoration(
                            borderRadius: BorderRadius.circular(12),
                            color: Colors.white.withOpacity(0.08),
                            border: Border.all(
                              color: neonCyan.withOpacity(0.2),
                              width: 1,
                            ),
                          ),
                          child: const Icon(Icons.arrow_back, color: neonCyan),
                        ),
                      ),
                      const SizedBox(width: 16),
                      Expanded(
                        child: Column(
                          crossAxisAlignment: CrossAxisAlignment.start,
                          children: [
                            Text(
                              'Create Account',
                              style: GoogleFonts.outfit(
                                fontSize: 22,
                                fontWeight: FontWeight.bold,
                                color: Colors.white,
                                letterSpacing: 1,
                              ),
                            ),
                            Text(
                              'Join the community',
                              style: GoogleFonts.outfit(
                                fontSize: 12,
                                color: neonCyan,
                                letterSpacing: 0.5,
                              ),
                            ),
                          ],
                        ),
                      ),
                    ],
                  ),
                ),
              ),

              // Scrollable Content
              Expanded(
                child: SingleChildScrollView(
                  padding: EdgeInsets.symmetric(
                    horizontal:
                        MediaQuery.of(context).size.width < 360 ? 16 : 24,
                  ),
                  child: Column(
                    children: [
                      const SizedBox(height: 16),

                      // Glassmorphic Card
                      GlassmorphicContainer(
                        opacity: 0.15,
                        borderColor: neonCyan,
                        borderWidth: 1.5,
                        borderRadius: const BorderRadius.all(
                          Radius.circular(28),
                        ),
                        padding: const EdgeInsets.all(28),
                        child: Column(
                          crossAxisAlignment: CrossAxisAlignment.start,
                          children: [
                            Text(
                              'Account Information',
                              style: GoogleFonts.outfit(
                                fontSize: 14,
                                fontWeight: FontWeight.w600,
                                color: Colors.white,
                                letterSpacing: 1,
                              ),
                            ),
                            const SizedBox(height: 16),

                            _buildGlassSignupField(
                              controller: _nameCtrl,
                              label: 'Full Name *',
                              icon: Icons.person,
                            ),
                            const SizedBox(height: 12),

                            _buildGlassSignupField(
                              controller: _emailCtrl,
                              label: 'Email Address *',
                              icon: Icons.email,
                              keyboardType: TextInputType.emailAddress,
                            ),
                            const SizedBox(height: 12),

                            _buildGlassSignupField(
                              controller: _passwordCtrl,
                              label: 'Password *',
                              icon: Icons.lock,
                              obscureText: _obscurePassword,
                              suffixIcon: IconButton(
                                icon: Icon(
                                  _obscurePassword
                                      ? Icons.visibility
                                      : Icons.visibility_off,
                                  color: neonCyan,
                                ),
                                onPressed: () => setState(
                                    () => _obscurePassword = !_obscurePassword),
                              ),
                            ),
                            const SizedBox(height: 12),

                            _buildGlassSignupField(
                              controller: _confirmPasswordCtrl,
                              label: 'Confirm Password *',
                              icon: Icons.lock_outline,
                              obscureText: _obscureConfirmPassword,
                              suffixIcon: IconButton(
                                icon: Icon(
                                  _obscureConfirmPassword
                                      ? Icons.visibility
                                      : Icons.visibility_off,
                                  color: neonCyan,
                                ),
                                onPressed: () => setState(() =>
                                    _obscureConfirmPassword =
                                        !_obscureConfirmPassword),
                              ),
                            ),

                            const SizedBox(height: 24),

                            // Divider
                            Container(
                              height: 1,
                              decoration: BoxDecoration(
                                gradient: LinearGradient(
                                  colors: [
                                    Colors.white.withOpacity(0.1),
                                    Colors.white.withOpacity(0),
                                  ],
                                ),
                              ),
                            ),

                            const SizedBox(height: 24),

                            Text(
                              'Profile Information',
                              style: GoogleFonts.outfit(
                                fontSize: 14,
                                fontWeight: FontWeight.w600,
                                color: Colors.white,
                                letterSpacing: 1,
                              ),
                            ),
                            const SizedBox(height: 16),

                            _buildGlassSignupField(
                              controller: _regIdCtrl,
                              label: 'Registration ID',
                              icon: Icons.badge,
                            ),
                            const SizedBox(height: 12),

                            _buildGlassSignupField(
                              controller: _deptCtrl,
                              label: 'Department',
                              icon: Icons.school,
                            ),
                            const SizedBox(height: 12),

                            _buildGlassSignupField(
                              controller: _bloodGroupCtrl,
                              label: 'Blood Group',
                              icon: Icons.bloodtype,
                            ),
                            const SizedBox(height: 12),

                            _buildGlassSignupField(
                              controller: _mobileCtrl,
                              label: 'Mobile Number',
                              icon: Icons.phone,
                              keyboardType: TextInputType.phone,
                            ),

                            const SizedBox(height: 24),

                            // Create Account Button
                            _buildNeonSignupButton(
                              onPressed: _loading ? null : _signup,
                              label:
                                  _loading ? "Creating..." : "Create Account",
                              isLoading: _loading,
                            ),

                            const SizedBox(height: 16),

                            // Login Link - Increased tap area
                            GestureDetector(
                              onTap: () => Navigator.of(context).pop(),
                              child: Padding(
                                padding: const EdgeInsets.symmetric(
                                    vertical: 12, horizontal: 16),
                                child: Row(
                                  mainAxisAlignment: MainAxisAlignment.center,
                                  children: [
                                    Text(
                                      'Already have an account? ',
                                      style: TextStyle(
                                        color: Colors.white.withOpacity(0.9),
                                        fontSize: 14,
                                      ),
                                    ),
                                    ShaderMask(
                                      shaderCallback: (bounds) =>
                                          const LinearGradient(
                                        colors: [neonCyan, electricPurple],
                                      ).createShader(bounds),
                                      child: Text(
                                        'Login',
                                        style: GoogleFonts.outfit(
                                          fontWeight: FontWeight.bold,
                                          fontSize: 14,
                                          color: Colors.white,
                                        ),
                                      ),
                                    ),
                                  ],
                                ),
                              ),
                            ),
                          ],
                        ),
                      ),
                      const SizedBox(height: 24),
                    ],
                  ),
                ),
              ),
            ],
          ),
        ],
      ),
    );
  }

  Widget _buildGlassSignupField({
    required TextEditingController controller,
    required String label,
    required IconData icon,
    TextInputType keyboardType = TextInputType.text,
    bool obscureText = false,
    Widget? suffixIcon,
  }) {
    return Container(
      decoration: BoxDecoration(
        borderRadius: BorderRadius.circular(12),
        border: Border.all(color: neonCyan.withOpacity(0.3), width: 1),
        color: Colors.white.withOpacity(0.08),
      ),
      child: TextField(
        controller: controller,
        keyboardType: keyboardType,
        obscureText: obscureText,
        style: TextStyle(
          color: Colors.white,
          fontFamily: GoogleFonts.outfit().fontFamily,
          fontSize: 14,
        ),
        decoration: InputDecoration(
          labelText: label,
          labelStyle: TextStyle(
            color: Colors.white.withOpacity(0.7),
            fontFamily: GoogleFonts.outfit().fontFamily,
            fontSize: 13,
          ),
          prefixIcon: Icon(icon, color: neonCyan.withOpacity(0.8)),
          suffixIcon: suffixIcon,
          filled: false,
          border: InputBorder.none,
          contentPadding:
              const EdgeInsets.symmetric(horizontal: 16, vertical: 16),
          hintStyle: TextStyle(
            color: Colors.white.withOpacity(0.3),
          ),
        ),
      ),
    );
  }

  Widget _buildNeonSignupButton({
    required VoidCallback? onPressed,
    required String label,
    required bool isLoading,
  }) {
    return GestureDetector(
      onTap: onPressed,
      child: Container(
        width: double.infinity,
        height: 56,
        decoration: BoxDecoration(
          gradient: const LinearGradient(
            colors: [neonCyan, electricPurple],
          ),
          borderRadius: BorderRadius.circular(14),
          boxShadow: [
            BoxShadow(
              color: neonCyan.withOpacity(0.3),
              blurRadius: 20,
              offset: const Offset(0, 8),
            ),
            BoxShadow(
              color: electricPurple.withOpacity(0.2),
              blurRadius: 20,
              offset: const Offset(0, 8),
            ),
          ],
        ),
        child: Material(
          color: Colors.transparent,
          child: InkWell(
            onTap: onPressed,
            borderRadius: BorderRadius.circular(14),
            child: Center(
              child: isLoading
                  ? SizedBox(
                      width: 24,
                      height: 24,
                      child: CircularProgressIndicator(
                        strokeWidth: 2,
                        valueColor:
                            AlwaysStoppedAnimation(darkBg.withOpacity(0.8)),
                      ),
                    )
                  : Text(
                      label,
                      style: GoogleFonts.outfit(
                        fontSize: 16,
                        fontWeight: FontWeight.bold,
                        color: darkBg,
                        letterSpacing: 1,
                      ),
                    ),
            ),
          ),
        ),
      ),
    );
  }
}

// -------------------- Home Page --------------------
class HomePage extends StatefulWidget {
  const HomePage({super.key});
  @override
  State<HomePage> createState() => _HomePageState();
}

class _HomePageState extends State<HomePage> {
  int _index = 0;
  final pages = [
    const NoticePage(),
    const ExamPage(),
    const RoutinePage(),
    const ProfilePage()
  ];
  late StreamSubscription _noticeListener;
  late StreamSubscription _examListener;
  DateTime? _lastNoticeTime;
  DateTime? _lastExamTime;
  bool _notifyNotices = true;
  bool _notifyEvents = true;
  bool isAdmin = false;

  @override
  void initState() {
    super.initState();
    _loadNotificationPrefs();
    _setupNotificationListeners();
    _checkAdmin();
  }

  Future<void> _checkAdmin() async {
    final admin = await isCurrentUserAdmin();
    debugPrint('HomePage: Admin check result = $admin');
    if (mounted) setState(() => isAdmin = admin);
  }

  Future<void> _loadNotificationPrefs() async {
    final uid = FirebaseAuth.instance.currentUser?.uid;
    if (uid == null) return;
    try {
      final doc = await FirebaseFirestore.instance
          .collection('users')
          .doc(uid)
          .collection('settings')
          .doc('prefs')
          .get();
      final data = doc.data() ?? {};
      setState(() {
        _notifyNotices = (data['notifyNotices'] ?? true) as bool;
        _notifyEvents = (data['notifyEvents'] ?? true) as bool;
      });
    } catch (_) {}
  }

  void _setupNotificationListeners() {
    // Optimized listener: only fetch the latest document and react when it changes
    _noticeListener = FirebaseFirestore.instance
        .collection('notices')
        .orderBy('time', descending: true)
        .limit(1)
        .snapshots()
        .listen((snapshot) {
      if (snapshot.docs.isNotEmpty) {
        final latestNotice = snapshot.docs.first;
        final noticeTime = (latestNotice['time'] as Timestamp).toDate();

        if (_lastNoticeTime == null) {
          // initial load - set baseline
          _lastNoticeTime = noticeTime;
        } else if (noticeTime.isAfter(_lastNoticeTime!)) {
          _lastNoticeTime = noticeTime;
          // Only show notification if user enabled it in settings
          if (_notifyNotices) {
            final text =
                latestNotice['text']?.toString() ?? 'New notice posted';
            final preview =
                text.length > 100 ? '${text.substring(0, 100)}...' : text;
            showNotification(' New Notice', preview);
          }
        }
      }
    });

    _examListener = FirebaseFirestore.instance
        .collection('exams')
        .orderBy('time', descending: true)
        .limit(1)
        .snapshots()
        .listen((snapshot) {
      if (snapshot.docs.isNotEmpty) {
        final latestExam = snapshot.docs.first;
        final examTime = (latestExam['time'] as Timestamp).toDate();

        if (_lastExamTime == null) {
          _lastExamTime = examTime;
        } else if (examTime.isAfter(_lastExamTime!)) {
          _lastExamTime = examTime;
          // Only show notification if user enabled it in settings
          if (_notifyEvents) {
            final type = latestExam['type']?.toString() ?? 'Event';
            final body = latestExam['details']?.toString() ?? 'Event updated';
            final preview =
                body.length > 100 ? '${body.substring(0, 100)}...' : body;
            showNotification(' $type Update', preview);
          }
        }
      }
    });
  }

  @override
  void dispose() {
    try {
      _noticeListener.cancel();
    } catch (_) {}
    try {
      _examListener.cancel();
    } catch (_) {}
    super.dispose();
  }

  @override
  Widget build(BuildContext context) {
    // Show dedicated homepage only on index 0
    if (_index == 0) {
      return Scaffold(
        backgroundColor: darkBg,
        appBar: AppBar(
          backgroundColor: darkBg,
          elevation: 0,
          title: ShaderMask(
            shaderCallback: (bounds) => const LinearGradient(
              colors: [neonCyan, electricPurple],
            ).createShader(bounds),
            child: Text(
              'INFYNERS',
              style: GoogleFonts.outfit(
                fontWeight: FontWeight.bold,
                fontSize: 24,
                color: Colors.white,
              ),
            ),
          ),
          actions: [
            IconButton(
              icon: const Icon(Icons.settings, color: neonCyan),
              tooltip: 'Settings',
              onPressed: () {
                Navigator.of(context).push(
                  MaterialPageRoute(builder: (_) => const SettingsPage()),
                );
              },
            ),
            IconButton(
              icon: Icon(Icons.logout, color: Colors.white.withOpacity(0.8)),
              onPressed: () async {
                await FirebaseAuth.instance.signOut();
                themeController.setMode(ThemeMode.light);
                if (context.mounted) {
                  Navigator.of(context).pushAndRemoveUntil(
                    MaterialPageRoute(builder: (_) => const GetStartedPage()),
                    (route) => false,
                  );
                }
              },
            )
          ],
        ),
        body: _buildDashboard(context),
        bottomNavigationBar: Container(
          decoration: BoxDecoration(
            color: darkCard,
            boxShadow: [
              BoxShadow(
                color: Colors.black.withOpacity(0.3),
                blurRadius: 20,
                offset: const Offset(0, -5),
              ),
            ],
          ),
          child: Theme(
            data: Theme.of(context).copyWith(
              navigationBarTheme: NavigationBarThemeData(
                labelTextStyle: WidgetStateProperty.resolveWith(
                  (states) {
                    if (states.contains(WidgetState.selected)) {
                      return GoogleFonts.outfit(
                        color: neonCyan,
                        fontSize: 12,
                        fontWeight: FontWeight.bold,
                      );
                    }
                    return GoogleFonts.outfit(
                      color: Colors.white,
                      fontSize: 12,
                      fontWeight: FontWeight.w500,
                    );
                  },
                ),
              ),
            ),
            child: NavigationBar(
              backgroundColor: Colors.transparent,
              selectedIndex: _index,
              onDestinationSelected: (i) => setState(() => _index = i),
              indicatorColor: neonCyan.withOpacity(0.2),
              labelBehavior: NavigationDestinationLabelBehavior.alwaysShow,
              destinations: const [
                NavigationDestination(
                  icon: Icon(Icons.home, color: Colors.white),
                  selectedIcon: Icon(Icons.home, color: neonCyan, size: 28),
                  label: "Home",
                ),
                NavigationDestination(
                  icon: Icon(Icons.announcement, color: Colors.white),
                  selectedIcon:
                      Icon(Icons.announcement, color: neonCyan, size: 28),
                  label: "Notices",
                ),
                NavigationDestination(
                  icon: Icon(Icons.assignment, color: Colors.white),
                  selectedIcon:
                      Icon(Icons.assignment, color: neonCyan, size: 28),
                  label: "Events",
                ),
                NavigationDestination(
                  icon: Icon(Icons.schedule, color: Colors.white),
                  selectedIcon: Icon(Icons.schedule, color: neonCyan, size: 28),
                  label: "Routine",
                ),
                NavigationDestination(
                  icon: Icon(Icons.person, color: Colors.white),
                  selectedIcon: Icon(Icons.person, color: neonCyan, size: 28),
                  label: "Profile",
                ),
              ],
            ),
          ),
        ),
      );
    }

    // Show other pages
    return Scaffold(
      backgroundColor: darkBg,
      appBar: AppBar(
        backgroundColor: darkBg,
        elevation: 0,
        title: ShaderMask(
          shaderCallback: (bounds) => const LinearGradient(
            colors: [neonCyan, electricPurple],
          ).createShader(bounds),
          child: Text(
            _getTitleForIndex(_index),
            style: GoogleFonts.outfit(
              fontWeight: FontWeight.bold,
              fontSize: 22,
              color: Colors.white,
            ),
          ),
        ),
        actions: [
          IconButton(
            icon: const Icon(Icons.settings, color: neonCyan),
            tooltip: 'Settings',
            onPressed: () {
              Navigator.of(context).push(
                MaterialPageRoute(builder: (_) => const SettingsPage()),
              );
            },
          ),
          if (isAdmin &&
              _index != 4) // Don't show admin buttons on Profile page
            IconButton(
              icon: const Icon(Icons.analytics, color: electricPurple),
              tooltip: 'Analytics',
              onPressed: () {
                Navigator.of(context).push(
                  MaterialPageRoute(builder: (_) => const AnalyticsPage()),
                );
              },
            ),
          if (isAdmin && _index != 4)
            IconButton(
              icon: const Icon(Icons.people, color: accentGreen),
              tooltip: 'Members',
              onPressed: () {
                Navigator.of(context).push(
                  MaterialPageRoute(builder: (_) => const MembersPage()),
                );
              },
            ),
          IconButton(
            icon: Icon(Icons.logout, color: Colors.white.withOpacity(0.8)),
            onPressed: () async {
              await FirebaseAuth.instance.signOut();
              themeController.setMode(ThemeMode.light);
              if (context.mounted) {
                Navigator.of(context).pushAndRemoveUntil(
                  MaterialPageRoute(builder: (_) => const GetStartedPage()),
                  (route) => false,
                );
              }
            },
          )
        ],
      ),
      body: pages[_index - 1], // Adjust index since we added Home
      bottomNavigationBar: Container(
        decoration: BoxDecoration(
          color: darkCard,
          boxShadow: [
            BoxShadow(
              color: Colors.black.withOpacity(0.3),
              blurRadius: 20,
              offset: const Offset(0, -5),
            ),
          ],
        ),
        child: Theme(
          data: Theme.of(context).copyWith(
            navigationBarTheme: NavigationBarThemeData(
              labelTextStyle: WidgetStateProperty.resolveWith(
                (states) {
                  if (states.contains(WidgetState.selected)) {
                    return GoogleFonts.outfit(
                      color: neonCyan,
                      fontSize: 12,
                      fontWeight: FontWeight.bold,
                    );
                  }
                  return GoogleFonts.outfit(
                    color: Colors.white,
                    fontSize: 12,
                    fontWeight: FontWeight.w500,
                  );
                },
              ),
            ),
          ),
          child: NavigationBar(
            backgroundColor: Colors.transparent,
            selectedIndex: _index,
            onDestinationSelected: (i) => setState(() => _index = i),
            indicatorColor: neonCyan.withOpacity(0.2),
            labelBehavior: NavigationDestinationLabelBehavior.alwaysShow,
            destinations: const [
              NavigationDestination(
                icon: Icon(Icons.home, color: Colors.white),
                selectedIcon: Icon(Icons.home, color: neonCyan, size: 28),
                label: "Home",
              ),
              NavigationDestination(
                icon: Icon(Icons.announcement, color: Colors.white),
                selectedIcon:
                    Icon(Icons.announcement, color: neonCyan, size: 28),
                label: "Notices",
              ),
              NavigationDestination(
                icon: Icon(Icons.assignment, color: Colors.white),
                selectedIcon: Icon(Icons.assignment, color: neonCyan, size: 28),
                label: "Events",
              ),
              NavigationDestination(
                icon: Icon(Icons.schedule, color: Colors.white),
                selectedIcon: Icon(Icons.schedule, color: neonCyan, size: 28),
                label: "Routine",
              ),
              NavigationDestination(
                icon: Icon(Icons.person, color: Colors.white),
                selectedIcon: Icon(Icons.person, color: neonCyan, size: 28),
                label: "Profile",
              ),
            ],
          ),
        ),
      ),
    );
  }

  String _getTitleForIndex(int index) {
    switch (index) {
      case 1:
        return 'Notices';
      case 2:
        return 'Events';
      case 3:
        return 'Routine';
      case 4:
        return 'My Profile';
      default:
        return 'INFYNERS';
    }
  }

  Widget _buildDashboard(BuildContext context) {
    final user = FirebaseAuth.instance.currentUser;

    return Container(
      decoration: BoxDecoration(
        gradient: LinearGradient(
          begin: Alignment.topLeft,
          end: Alignment.bottomRight,
          colors: [
            darkBg,
            const Color(0xFF1A1F3A),
            electricPurple.withOpacity(0.1),
          ],
        ),
      ),
      child: SingleChildScrollView(
        child: Column(
          children: [
            // Welcome Header with Glassmorphism
            Container(
              margin: const EdgeInsets.all(20),
              padding: const EdgeInsets.all(24),
              decoration: BoxDecoration(
                gradient: LinearGradient(
                  begin: Alignment.topLeft,
                  end: Alignment.bottomRight,
                  colors: [
                    neonCyan.withOpacity(0.1),
                    electricPurple.withOpacity(0.1),
                  ],
                ),
                borderRadius: BorderRadius.circular(24),
                border: Border.all(
                  color: neonCyan.withOpacity(0.3),
                  width: 1.5,
                ),
                boxShadow: [
                  BoxShadow(
                    color: neonCyan.withOpacity(0.2),
                    blurRadius: 20,
                    offset: const Offset(0, 10),
                  ),
                ],
              ),
              child: StreamBuilder<DocumentSnapshot>(
                stream: user != null
                    ? FirebaseFirestore.instance
                        .collection('users')
                        .doc(user.uid)
                        .snapshots()
                    : null,
                builder: (context, snapshot) {
                  String userName = 'User';
                  if (snapshot.hasData && snapshot.data!.exists) {
                    final data = snapshot.data!.data() as Map<String, dynamic>?;
                    userName = data?['name'] ?? 'User';
                  }

                  return Column(
                    crossAxisAlignment: CrossAxisAlignment.start,
                    children: [
                      Text(
                        'Welcome Back,',
                        style: GoogleFonts.outfit(
                          fontSize: 14,
                          color: Colors.white.withOpacity(0.7),
                          letterSpacing: 1,
                        ),
                      ),
                      const SizedBox(height: 8),
                      ShaderMask(
                        shaderCallback: (bounds) => const LinearGradient(
                          colors: [neonCyan, electricPurple],
                        ).createShader(bounds),
                        child: Text(
                          userName,
                          style: GoogleFonts.outfit(
                            fontSize: 32,
                            fontWeight: FontWeight.bold,
                            color: Colors.white,
                          ),
                        ),
                      ),
                      const SizedBox(height: 4),
                      Text(
                        DateFormat('EEEE, MMMM d, yyyy').format(DateTime.now()),
                        style: GoogleFonts.outfit(
                          fontSize: 13,
                          color: Colors.white.withOpacity(0.6),
                        ),
                      ),
                    ],
                  );
                },
              ),
            ),

            // Stats Cards
            Padding(
              padding: const EdgeInsets.all(20),
              child: Column(
                children: [
                  Row(
                    children: [
                      Expanded(
                        child: StreamBuilder<QuerySnapshot>(
                          stream: FirebaseFirestore.instance
                              .collection('notices')
                              .snapshots(),
                          builder: (context, snapshot) {
                            final count = snapshot.data?.docs.length ?? 0;
                            return _buildStatCard(
                              context,
                              Icons.announcement,
                              count.toString(),
                              'Notices',
                              Colors.blue,
                            );
                          },
                        ),
                      ),
                      const SizedBox(width: 16),
                      Expanded(
                        child: StreamBuilder<QuerySnapshot>(
                          stream: FirebaseFirestore.instance
                              .collection('exams')
                              .snapshots(),
                          builder: (context, snapshot) {
                            final count = snapshot.data?.docs.length ?? 0;
                            return _buildStatCard(
                              context,
                              Icons.event,
                              count.toString(),
                              'Events',
                              Colors.orange,
                            );
                          },
                        ),
                      ),
                    ],
                  ),
                  if (isAdmin) ...[
                    const SizedBox(height: 16),
                    StreamBuilder<QuerySnapshot>(
                      stream: FirebaseFirestore.instance
                          .collection('users')
                          .snapshots(),
                      builder: (context, snapshot) {
                        final count = snapshot.data?.docs.length ?? 0;
                        return _buildStatCard(
                          context,
                          Icons.people,
                          count.toString(),
                          'Members',
                          Colors.green,
                        );
                      },
                    ),
                    const SizedBox(height: 16),
                    Row(
                      children: [
                        Expanded(
                          child: _buildActionCard(
                            context,
                            Icons.analytics,
                            'Analytics',
                            Colors.purple,
                            () {
                              Navigator.of(context).push(
                                MaterialPageRoute(
                                    builder: (_) => const AnalyticsPage()),
                              );
                            },
                          ),
                        ),
                        const SizedBox(width: 16),
                        Expanded(
                          child: _buildActionCard(
                            context,
                            Icons.people,
                            'Manage Members',
                            Colors.teal,
                            () {
                              Navigator.of(context).push(
                                MaterialPageRoute(
                                    builder: (_) => const MembersPage()),
                              );
                            },
                          ),
                        ),
                      ],
                    ),
                  ],
                ],
              ),
            ),

            const SizedBox(height: 24),
          ],
        ),
      ),
    );
  }

  Widget _buildStatCard(BuildContext context, IconData icon, String count,
      String label, Color color) {
    return Container(
      padding: const EdgeInsets.all(20),
      decoration: BoxDecoration(
        gradient: LinearGradient(
          begin: Alignment.topLeft,
          end: Alignment.bottomRight,
          colors: [
            color.withOpacity(0.15),
            color.withOpacity(0.05),
          ],
        ),
        borderRadius: BorderRadius.circular(20),
        border: Border.all(
          color: color.withOpacity(0.3),
          width: 1.5,
        ),
        boxShadow: [
          BoxShadow(
            color: color.withOpacity(0.2),
            blurRadius: 15,
            offset: const Offset(0, 8),
          ),
        ],
      ),
      child: Column(
        mainAxisAlignment: MainAxisAlignment.center,
        children: [
          Icon(icon, color: color, size: 36),
          const SizedBox(height: 12),
          Text(
            count,
            style: GoogleFonts.outfit(
              fontSize: 28,
              fontWeight: FontWeight.bold,
              color: Colors.white,
            ),
          ),
          const SizedBox(height: 4),
          Text(
            label,
            style: GoogleFonts.outfit(
              fontSize: 13,
              color: Colors.white.withOpacity(0.7),
              fontWeight: FontWeight.w500,
            ),
          ),
        ],
      ),
    );
  }

  Widget _buildActionCard(BuildContext context, IconData icon, String label,
      Color color, VoidCallback onTap) {
    return GestureDetector(
      onTap: onTap,
      child: Container(
        padding: const EdgeInsets.all(20),
        decoration: BoxDecoration(
          gradient: LinearGradient(
            begin: Alignment.topLeft,
            end: Alignment.bottomRight,
            colors: [
              color.withOpacity(0.2),
              color.withOpacity(0.05),
            ],
          ),
          borderRadius: BorderRadius.circular(20),
          border: Border.all(
            color: color.withOpacity(0.4),
            width: 1.5,
          ),
          boxShadow: [
            BoxShadow(
              color: color.withOpacity(0.3),
              blurRadius: 15,
              offset: const Offset(0, 8),
            ),
          ],
        ),
        child: Column(
          mainAxisAlignment: MainAxisAlignment.center,
          children: [
            Container(
              padding: const EdgeInsets.all(16),
              decoration: BoxDecoration(
                shape: BoxShape.circle,
                gradient: LinearGradient(
                  colors: [color.withOpacity(0.3), color.withOpacity(0.1)],
                ),
              ),
              child: Icon(icon, color: color, size: 32),
            ),
            const SizedBox(height: 12),
            Text(
              label,
              textAlign: TextAlign.center,
              style: GoogleFonts.outfit(
                fontSize: 14,
                color: Colors.white,
                fontWeight: FontWeight.w600,
              ),
            ),
          ],
        ),
      ),
    );
  }
}

// -------------------- Notice Page --------------------
class NoticePage extends StatefulWidget {
  const NoticePage({super.key});
  @override
  State<NoticePage> createState() => _NoticePageState();
}

class _NoticePageState extends State<NoticePage> {
  final notice = TextEditingController();
  final search = TextEditingController();
  final attachmentUrl = TextEditingController();
  bool isAdmin = false;
  String _searchQuery = '';
  bool _isPoll = false;
  final List<TextEditingController> _pollOptions = [];

  bool _isPinned = false;

  @override
  void initState() {
    super.initState();
    _initAdmin();
    search.addListener(() {
      setState(() => _searchQuery = search.text.toLowerCase());
    });
    // Initialize with 2 poll options
    _pollOptions.add(TextEditingController());
    _pollOptions.add(TextEditingController());
  }

  Future<void> _initAdmin() async {
    final admin = await isCurrentUserAdmin();
    if (mounted) setState(() => isAdmin = admin);
  }

  Future<void> postNotice() async {
    final text = notice.text.trim();
    if (text.isEmpty) {
      Fluttertoast.showToast(msg: 'Enter notice text');
      return;
    }

    if (_isPoll) {
      final options = _pollOptions
          .map((c) => c.text.trim())
          .where((t) => t.isNotEmpty)
          .toList();
      if (options.length < 2) {
        Fluttertoast.showToast(msg: 'Poll needs at least 2 options');
        return;
      }

      try {
        await FirebaseFirestore.instance.collection('notices').add({
          'text': text,
          'time': FieldValue.serverTimestamp(),
          'createdBy': FirebaseAuth.instance.currentUser?.uid,
          'isPoll': true,
          'pollOptions': options,
          'pollVotes': {for (var opt in options) opt: 0},
          'isPinned': _isPinned,
        });
        notice.clear();
        for (var ctrl in _pollOptions) {
          ctrl.clear();
        }
        setState(() {
          _isPoll = false;
          _isPinned = false;
        });
        Fluttertoast.showToast(msg: 'Poll posted');
      } catch (e) {
        Fluttertoast.showToast(msg: 'Post failed: $e');
      }
    } else {
      try {
        final docData = {
          'text': text,
          'time': FieldValue.serverTimestamp(),
          'createdBy': FirebaseAuth.instance.currentUser?.uid,
          'isPinned': _isPinned,
        };

        // Only URL text field (no file upload)
        if (attachmentUrl.text.trim().isNotEmpty) {
          docData['attachmentUrl'] = attachmentUrl.text.trim();
        }

        await FirebaseFirestore.instance.collection('notices').add(docData);
        await showNotification('New Notice', text.split('\n').first);
        notice.clear();
        attachmentUrl.clear();
        setState(() => _isPinned = false);
        Fluttertoast.showToast(msg: 'Notice posted');
      } catch (e) {
        Fluttertoast.showToast(msg: 'Post failed: $e');
      }
    }
  }

  @override
  void dispose() {
    notice.dispose();
    search.dispose();
    attachmentUrl.dispose();
    for (var ctrl in _pollOptions) {
      ctrl.dispose();
    }
    super.dispose();
  }

  @override
  Widget build(BuildContext context) {
    return Column(children: [
      // Search bar
      Padding(
        padding: const EdgeInsets.all(12),
        child: TextField(
          controller: search,
          style: TextStyle(
              color: Colors.grey.shade900,
              fontSize: 16,
              fontWeight: FontWeight.w500),
          decoration: InputDecoration(
            labelText: 'Search notices',
            labelStyle: TextStyle(
              color: Colors.grey.shade700,
              fontSize: 14,
            ),
            prefixIcon: const Icon(Icons.search, color: neonCyan),
            suffixIcon: _searchQuery.isNotEmpty
                ? IconButton(
                    icon: const Icon(Icons.clear, color: Colors.white),
                    onPressed: () => search.clear(),
                  )
                : null,
            border: OutlineInputBorder(
              borderSide: BorderSide(color: neonCyan.withOpacity(0.3)),
            ),
            enabledBorder: OutlineInputBorder(
              borderSide: BorderSide(color: neonCyan.withOpacity(0.3)),
            ),
            focusedBorder: const OutlineInputBorder(
              borderSide: BorderSide(color: neonCyan, width: 2),
            ),
          ),
        ),
      ),
      if (isAdmin)
        Padding(
          padding: const EdgeInsets.symmetric(horizontal: 12),
          child: Column(children: [
            TextField(
              controller: notice,
              maxLines: 5,
              textInputAction: TextInputAction.newline,
              style: TextStyle(
                  color: Colors.grey.shade900,
                  fontSize: 16,
                  fontWeight: FontWeight.w500),
              decoration: InputDecoration(
                labelText: 'Write Notice',
                labelStyle: TextStyle(
                  color: Colors.grey.shade700,
                  fontSize: 14,
                ),
                alignLabelWithHint: true,
                border: OutlineInputBorder(
                  borderSide: BorderSide(color: neonCyan.withOpacity(0.3)),
                ),
                enabledBorder: OutlineInputBorder(
                  borderSide: BorderSide(color: neonCyan.withOpacity(0.3)),
                ),
                focusedBorder: const OutlineInputBorder(
                  borderSide: BorderSide(color: neonCyan, width: 2),
                ),
              ),
            ),
            const SizedBox(height: 8),
            TextField(
              controller: attachmentUrl,
              style: TextStyle(
                  color: Colors.grey.shade900,
                  fontSize: 16,
                  fontWeight: FontWeight.w500),
              decoration: InputDecoration(
                labelText: 'Attachment URL (optional)',
                labelStyle: TextStyle(
                  color: Colors.grey.shade700,
                  fontSize: 14,
                ),
                hintText: 'Paste Google Drive, Dropbox, etc. link',
                hintStyle: TextStyle(
                  color: Colors.grey.shade600,
                  fontSize: 14,
                ),
                prefixIcon: const Icon(Icons.link, color: neonCyan),
                border: OutlineInputBorder(
                  borderSide: BorderSide(color: neonCyan.withOpacity(0.3)),
                ),
                enabledBorder: OutlineInputBorder(
                  borderSide: BorderSide(color: neonCyan.withOpacity(0.3)),
                ),
                focusedBorder: const OutlineInputBorder(
                  borderSide: BorderSide(color: neonCyan, width: 2),
                ),
              ),
            ),
            const SizedBox(height: 8),
            Row(
              children: [
                Expanded(
                  child: Row(
                    children: [
                      Checkbox(
                        value: _isPoll,
                        activeColor: neonCyan,
                        checkColor: darkBg,
                        onChanged: (v) => setState(() => _isPoll = v ?? false),
                      ),
                      Text('Create as Poll',
                          style: GoogleFonts.outfit(
                            color: Colors.white,
                            fontSize: 14,
                          )),
                    ],
                  ),
                ),
                Expanded(
                  child: Row(
                    children: [
                      Checkbox(
                        value: _isPinned,
                        activeColor: neonCyan,
                        checkColor: darkBg,
                        onChanged: (v) =>
                            setState(() => _isPinned = v ?? false),
                      ),
                      Text('Pin to top',
                          style: GoogleFonts.outfit(
                            color: Colors.white,
                            fontSize: 14,
                          )),
                    ],
                  ),
                ),
              ],
            ),
            if (_isPoll) ...[
              const SizedBox(height: 8),
              Text('Poll Options:',
                  style: GoogleFonts.outfit(
                    fontWeight: FontWeight.bold,
                    color: Colors.white,
                    fontSize: 16,
                  )),
              const SizedBox(height: 4),
              ..._pollOptions.asMap().entries.map((entry) {
                final idx = entry.key;
                final ctrl = entry.value;
                return Padding(
                  padding: const EdgeInsets.only(bottom: 8),
                  child: Row(
                    children: [
                      Expanded(
                        child: TextField(
                          controller: ctrl,
                          style: TextStyle(
                            color: Colors.grey.shade900,
                            fontSize: 16,
                            fontWeight: FontWeight.w500,
                          ),
                          decoration: InputDecoration(
                            filled: true,
                            fillColor: Colors.white,
                            labelText: 'Option ${idx + 1}',
                            labelStyle: TextStyle(
                              color: Colors.grey.shade700,
                              fontSize: 14,
                            ),
                            hintText: 'Enter option ${idx + 1}',
                            hintStyle: TextStyle(
                              color: Colors.grey.shade600,
                            ),
                            border: OutlineInputBorder(
                              borderSide:
                                  BorderSide(color: neonCyan.withOpacity(0.3)),
                            ),
                            enabledBorder: OutlineInputBorder(
                              borderSide:
                                  BorderSide(color: neonCyan.withOpacity(0.3)),
                            ),
                            focusedBorder: const OutlineInputBorder(
                              borderSide: BorderSide(color: neonCyan, width: 2),
                            ),
                            isDense: true,
                          ),
                        ),
                      ),
                      if (_pollOptions.length > 2)
                        IconButton(
                          icon: const Icon(Icons.remove_circle,
                              color: Colors.red),
                          onPressed: () {
                            setState(() {
                              ctrl.dispose();
                              _pollOptions.removeAt(idx);
                            });
                          },
                        ),
                    ],
                  ),
                );
              }),
              TextButton.icon(
                icon: const Icon(Icons.add, color: neonCyan),
                label: Text('Add Option',
                    style: GoogleFonts.outfit(
                      color: neonCyan,
                      fontWeight: FontWeight.bold,
                    )),
                onPressed: () {
                  if (_pollOptions.length < 6) {
                    setState(() => _pollOptions.add(TextEditingController()));
                  } else {
                    Fluttertoast.showToast(msg: 'Max 6 options');
                  }
                },
              ),
            ],
            const SizedBox(height: 8),
            SizedBox(
              width: double.infinity,
              child: ElevatedButton(
                onPressed: postNotice,
                style: ElevatedButton.styleFrom(
                    backgroundColor: Colors.indigo,
                    foregroundColor: Colors.white),
                child: const Text('Post Notice'),
              ),
            ),
          ]),
        ),
      Expanded(
        child: StreamBuilder<QuerySnapshot>(
          stream: FirebaseFirestore.instance
              .collection('notices')
              .orderBy('time', descending: true)
              .snapshots(),
          builder: (context, snap) {
            if (!snap.hasData) {
              return const Center(child: CircularProgressIndicator());
            }
            final docs = snap.data!.docs;
            if (docs.isEmpty) {
              return Center(
                  child: Text('No notices yet',
                      style: GoogleFonts.outfit(
                        fontSize: 18,
                        color: Colors.white.withOpacity(0.7),
                      )));
            }

            // Filter by search query
            final filtered = _searchQuery.isEmpty
                ? docs
                : docs.where((doc) {
                    final data = doc.data() as Map<String, dynamic>;
                    final text = (data['text'] ?? '').toString().toLowerCase();
                    return text.contains(_searchQuery);
                  }).toList();

            // Sort: pinned first, then by time
            filtered.sort((a, b) {
              final dataA = a.data() as Map<String, dynamic>;
              final dataB = b.data() as Map<String, dynamic>;
              final pinnedA = (dataA['isPinned'] ?? false) as bool;
              final pinnedB = (dataB['isPinned'] ?? false) as bool;

              if (pinnedA && !pinnedB) return -1;
              if (!pinnedA && pinnedB) return 1;

              // Both pinned or both unpinned: sort by time (already desc from query)
              return 0;
            });

            if (filtered.isEmpty) {
              return Center(
                  child: Text(
                      _searchQuery.isEmpty
                          ? 'No notices yet'
                          : 'No notices match "$_searchQuery"',
                      style: GoogleFonts.outfit(
                        fontSize: 18,
                        color: Colors.white.withOpacity(0.7),
                      )));
            }

            return ListView.builder(
              itemCount: filtered.length,
              itemBuilder: (context, i) {
                final doc = filtered[i];
                final data = doc.data() as Map<String, dynamic>;
                final text = (data['text'] ?? '').toString();
                final isPoll = (data['isPoll'] ?? false) as bool;
                final isPinned = (data['isPinned'] ?? false) as bool;
                final attachmentUrl = data['attachmentUrl']?.toString();
                return NoticeCard(
                  docId: doc.id,
                  text: text,
                  isAdmin: isAdmin,
                  isPoll: isPoll,
                  isPinned: isPinned,
                  pollOptions: isPoll
                      ? List<String>.from(data['pollOptions'] ?? [])
                      : [],
                  attachmentUrl: attachmentUrl,
                  onDelete: () async {
                    await doc.reference.delete();
                    Fluttertoast.showToast(msg: 'Deleted');
                  },
                );
              },
            );
          },
        ),
      ),
    ]);
  }
}

// -------------------- Notice Card with Comments --------------------
class NoticeCard extends StatefulWidget {
  final String docId;
  final String text;
  final bool isAdmin;
  final VoidCallback onDelete;
  final bool isPoll;
  final bool isPinned;
  final List<String> pollOptions;
  final String? attachmentUrl;

  const NoticeCard({
    super.key,
    required this.docId,
    required this.text,
    required this.isAdmin,
    required this.onDelete,
    this.isPoll = false,
    this.isPinned = false,
    this.pollOptions = const [],
    this.attachmentUrl,
  });

  @override
  State<NoticeCard> createState() => _NoticeCardState();
}

class _NoticeCardState extends State<NoticeCard> {
  bool _showComments = false;
  final _commentCtrl = TextEditingController();
  String? _userVote;

  @override
  void initState() {
    super.initState();
    if (widget.isPoll) {
      _loadUserVote();
    }
  }

  Future<void> _loadUserVote() async {
    final uid = FirebaseAuth.instance.currentUser?.uid;
    if (uid == null) return;

    try {
      final voteDoc = await FirebaseFirestore.instance
          .collection('notices')
          .doc(widget.docId)
          .collection('votes')
          .doc(uid)
          .get();

      if (voteDoc.exists && mounted) {
        setState(() {
          _userVote = voteDoc.data()?['option'];
        });
      }
    } catch (_) {}
  }

  Future<void> _vote(String option) async {
    final uid = FirebaseAuth.instance.currentUser?.uid;
    if (uid == null) return;

    try {
      final noticeRef =
          FirebaseFirestore.instance.collection('notices').doc(widget.docId);
      final voteRef = noticeRef.collection('votes').doc(uid);

      await FirebaseFirestore.instance.runTransaction((transaction) async {
        final voteDoc = await transaction.get(voteRef);
        final noticeDoc = await transaction.get(noticeRef);

        final pollVotes =
            Map<String, dynamic>.from(noticeDoc.data()?['pollVotes'] ?? {});

        // Remove old vote
        if (voteDoc.exists) {
          final oldVote = voteDoc.data()?['option'];
          if (oldVote != null && pollVotes.containsKey(oldVote)) {
            pollVotes[oldVote] = (pollVotes[oldVote] ?? 0) - 1;
          }
        }

        // Add new vote
        pollVotes[option] = (pollVotes[option] ?? 0) + 1;

        transaction.set(
            voteRef, {'option': option, 'time': FieldValue.serverTimestamp()});
        transaction.update(noticeRef, {'pollVotes': pollVotes});
      });

      setState(() => _userVote = option);
      Fluttertoast.showToast(msg: 'Vote recorded');
    } catch (e) {
      Fluttertoast.showToast(msg: 'Failed to vote: $e');
    }
  }

  @override
  void dispose() {
    _commentCtrl.dispose();
    super.dispose();
  }

  Future<void> _postComment() async {
    final text = _commentCtrl.text.trim();
    if (text.isEmpty) return;

    final uid = FirebaseAuth.instance.currentUser?.uid;
    if (uid == null) return;

    try {
      // Get user profile name
      final userDoc =
          await FirebaseFirestore.instance.collection('users').doc(uid).get();
      final userName = userDoc.data()?['name'] ??
          FirebaseAuth.instance.currentUser?.email?.split('@')[0] ??
          'Anonymous';
      final profilePicUrl = userDoc.data()?['profilePicUrl'];

      await FirebaseFirestore.instance
          .collection('notices')
          .doc(widget.docId)
          .collection('comments')
          .add({
        'text': text,
        'userId': uid,
        'userName': userName,
        'profilePicUrl': profilePicUrl,
        'time': FieldValue.serverTimestamp(),
      });
      _commentCtrl.clear();
      Fluttertoast.showToast(msg: 'Comment posted');
    } catch (e) {
      Fluttertoast.showToast(msg: 'Failed to post comment: $e');
    }
  }

  void _showEditDialog() {
    final textCtrl = TextEditingController(text: widget.text);
    final urlCtrl = TextEditingController(text: widget.attachmentUrl ?? '');

    showDialog(
      context: context,
      builder: (context) => AlertDialog(
        title: const Text('Edit Notice'),
        content: SingleChildScrollView(
          child: Column(
            mainAxisSize: MainAxisSize.min,
            children: [
              TextField(
                controller: textCtrl,
                maxLines: 5,
                decoration: const InputDecoration(
                  labelText: 'Notice Text',
                  border: OutlineInputBorder(),
                ),
              ),
              const SizedBox(height: 12),
              TextField(
                controller: urlCtrl,
                decoration: const InputDecoration(
                  labelText: 'Attachment URL',
                  border: OutlineInputBorder(),
                ),
              ),
            ],
          ),
        ),
        actions: [
          TextButton(
            onPressed: () => Navigator.pop(context),
            child: const Text('Cancel'),
          ),
          ElevatedButton(
            onPressed: () async {
              final newText = textCtrl.text.trim();
              if (newText.isEmpty) {
                Fluttertoast.showToast(msg: 'Notice text cannot be empty');
                return;
              }

              try {
                final updateData = <String, dynamic>{'text': newText};
                if (urlCtrl.text.trim().isNotEmpty) {
                  updateData['attachmentUrl'] = urlCtrl.text.trim();
                } else {
                  updateData['attachmentUrl'] = FieldValue.delete();
                }

                await FirebaseFirestore.instance
                    .collection('notices')
                    .doc(widget.docId)
                    .update(updateData);

                Fluttertoast.showToast(msg: 'Notice updated');
                if (context.mounted) Navigator.pop(context);
              } catch (e) {
                Fluttertoast.showToast(msg: 'Failed to update: $e');
              }
            },
            child: const Text('Save'),
          ),
        ],
      ),
    );
  }

  @override
  Widget build(BuildContext context) {
    final isDark = Theme.of(context).brightness == Brightness.dark;

    return Card(
      margin: const EdgeInsets.symmetric(horizontal: 12, vertical: 8),
      elevation: widget.isPinned ? 4 : 2,
      shape: RoundedRectangleBorder(borderRadius: BorderRadius.circular(16)),
      child: Container(
        decoration: widget.isPinned
            ? BoxDecoration(
                borderRadius: BorderRadius.circular(16),
                gradient: LinearGradient(
                  begin: Alignment.topLeft,
                  end: Alignment.bottomRight,
                  colors: isDark
                      ? [
                          Colors.amber.shade900.withOpacity(0.3),
                          Colors.amber.shade800.withOpacity(0.2)
                        ]
                      : [Colors.amber.shade50, Colors.amber.shade100],
                ),
                border: Border.all(color: Colors.amber.shade400, width: 2),
              )
            : null,
        child: Column(
          crossAxisAlignment: CrossAxisAlignment.start,
          children: [
            // Pinned Header
            if (widget.isPinned)
              Container(
                padding:
                    const EdgeInsets.symmetric(horizontal: 16, vertical: 8),
                decoration: BoxDecoration(
                  gradient: LinearGradient(
                    colors: [Colors.amber.shade400, Colors.orange.shade400],
                  ),
                  borderRadius: const BorderRadius.only(
                    topLeft: Radius.circular(16),
                    topRight: Radius.circular(16),
                  ),
                ),
                child: Row(
                  children: [
                    const Icon(Icons.push_pin, size: 16, color: Colors.white),
                    const SizedBox(width: 6),
                    Text(
                      'PINNED NOTICE',
                      style: GoogleFonts.poppins(
                        fontSize: 11,
                        fontWeight: FontWeight.w700,
                        color: Colors.white,
                        letterSpacing: 1,
                      ),
                    ),
                  ],
                ),
              ),

            // Notice Content
            Padding(
              padding: const EdgeInsets.all(16),
              child: Column(
                crossAxisAlignment: CrossAxisAlignment.start,
                children: [
                  Row(
                    crossAxisAlignment: CrossAxisAlignment.start,
                    children: [
                      Expanded(
                        child: Text(
                          widget.text,
                          style: GoogleFonts.outfit(
                            fontSize: 15,
                            height: 1.5,
                            color: Colors.white,
                            fontWeight: widget.isPinned
                                ? FontWeight.w600
                                : FontWeight.normal,
                          ),
                        ),
                      ),
                      if (widget.isAdmin)
                        Row(
                          mainAxisSize: MainAxisSize.min,
                          children: [
                            IconButton(
                              icon: const Icon(Icons.edit, size: 20),
                              color: Theme.of(context).colorScheme.primary,
                              onPressed: () => _showEditDialog(),
                              tooltip: 'Edit',
                            ),
                            IconButton(
                              icon: const Icon(Icons.delete, size: 20),
                              color: Colors.red,
                              onPressed: widget.onDelete,
                              tooltip: 'Delete',
                            ),
                          ],
                        ),
                    ],
                  ),

                  // Attachment Link
                  if (widget.attachmentUrl != null) ...[
                    const SizedBox(height: 12),
                    InkWell(
                      onTap: () async {
                        final uri = Uri.parse(widget.attachmentUrl!);
                        try {
                          if (await canLaunchUrl(uri)) {
                            await launchUrl(uri,
                                mode: LaunchMode.externalApplication);
                          } else {
                            Fluttertoast.showToast(
                                msg: 'Cannot open attachment');
                          }
                        } catch (e) {
                          Fluttertoast.showToast(
                              msg: 'Error opening attachment: $e');
                        }
                      },
                      child: Container(
                        padding: const EdgeInsets.all(12),
                        decoration: BoxDecoration(
                          color: Theme.of(context)
                              .colorScheme
                              .primaryContainer
                              .withOpacity(0.5),
                          borderRadius: BorderRadius.circular(8),
                          border: Border.all(
                            color: Theme.of(context)
                                .colorScheme
                                .primary
                                .withOpacity(0.3),
                          ),
                        ),
                        child: Row(
                          children: [
                            Icon(
                              Icons.link,
                              size: 18,
                              color: Theme.of(context).colorScheme.primary,
                            ),
                            const SizedBox(width: 8),
                            Expanded(
                              child: Text(
                                widget.attachmentUrl!,
                                style: const TextStyle(
                                  color: neonCyan,
                                  decoration: TextDecoration.underline,
                                  fontSize: 12,
                                  fontWeight: FontWeight.w500,
                                ),
                                overflow: TextOverflow.ellipsis,
                                maxLines: 1,
                              ),
                            ),
                            Icon(
                              Icons.open_in_new,
                              size: 14,
                              color: Theme.of(context).colorScheme.primary,
                            ),
                          ],
                        ),
                      ),
                    ),
                  ],
                ],
              ),
            ),

            // Poll Section
            if (widget.isPoll) ...[
              const Divider(height: 1),
              Padding(
                padding: const EdgeInsets.all(16),
                child: StreamBuilder<DocumentSnapshot>(
                  stream: FirebaseFirestore.instance
                      .collection('notices')
                      .doc(widget.docId)
                      .snapshots(),
                  builder: (context, snap) {
                    if (!snap.hasData) return const SizedBox.shrink();

                    final pollVotes = Map<String, int>.from((snap.data!.data()
                            as Map<String, dynamic>?)?['pollVotes'] ??
                        {});
                    final totalVotes =
                        pollVotes.values.fold<int>(0, (sum, v) => sum + v);

                    return Column(
                      crossAxisAlignment: CrossAxisAlignment.start,
                      children: [
                        Row(
                          children: [
                            Container(
                              padding: const EdgeInsets.symmetric(
                                  horizontal: 8, vertical: 4),
                              decoration: BoxDecoration(
                                color: Theme.of(context)
                                    .colorScheme
                                    .primaryContainer,
                                borderRadius: BorderRadius.circular(8),
                              ),
                              child: Row(
                                children: [
                                  const Icon(Icons.poll, size: 14),
                                  const SizedBox(width: 4),
                                  Text(
                                    'POLL',
                                    style: GoogleFonts.poppins(
                                      fontSize: 11,
                                      fontWeight: FontWeight.w600,
                                    ),
                                  ),
                                ],
                              ),
                            ),
                            const Spacer(),
                            Text(
                              'Total: $totalVotes votes',
                              style: GoogleFonts.poppins(
                                fontSize: 11,
                                color: Colors.grey,
                              ),
                            ),
                          ],
                        ),
                        const SizedBox(height: 12),
                        ...widget.pollOptions.map((option) {
                          final votes = pollVotes[option] ?? 0;
                          final percentage = totalVotes > 0
                              ? (votes / totalVotes * 100).round()
                              : 0;
                          final isVoted = _userVote == option;

                          return Padding(
                            padding: const EdgeInsets.only(bottom: 10),
                            child: InkWell(
                              onTap: () => _vote(option),
                              borderRadius: BorderRadius.circular(12),
                              child: Container(
                                padding: const EdgeInsets.all(14),
                                decoration: BoxDecoration(
                                  color: isVoted
                                      ? Theme.of(context)
                                          .colorScheme
                                          .primaryContainer
                                          .withOpacity(0.6)
                                      : (isDark
                                          ? Colors.grey.shade800
                                          : Colors.grey.shade100),
                                  border: Border.all(
                                    color: isVoted
                                        ? Theme.of(context).colorScheme.primary
                                        : Colors.grey.shade300,
                                    width: isVoted ? 2.5 : 1,
                                  ),
                                  borderRadius: BorderRadius.circular(12),
                                ),
                                child: Column(
                                  crossAxisAlignment: CrossAxisAlignment.start,
                                  children: [
                                    Row(
                                      children: [
                                        if (isVoted)
                                          Container(
                                            margin:
                                                const EdgeInsets.only(right: 8),
                                            padding: const EdgeInsets.all(4),
                                            decoration: BoxDecoration(
                                              color: Theme.of(context)
                                                  .colorScheme
                                                  .primary,
                                              shape: BoxShape.circle,
                                            ),
                                            child: const Icon(
                                              Icons.check,
                                              size: 12,
                                              color: Colors.white,
                                            ),
                                          ),
                                        Expanded(
                                          child: Text(
                                            option,
                                            style: GoogleFonts.poppins(
                                              fontWeight: isVoted
                                                  ? FontWeight.w600
                                                  : FontWeight.normal,
                                              fontSize: 13,
                                            ),
                                          ),
                                        ),
                                        Text(
                                          '$percentage%',
                                          style: GoogleFonts.poppins(
                                            fontSize: 14,
                                            fontWeight: FontWeight.w600,
                                            color: isVoted
                                                ? Theme.of(context)
                                                    .colorScheme
                                                    .primary
                                                : Colors.grey,
                                          ),
                                        ),
                                        const SizedBox(width: 4),
                                        Text(
                                          '($votes)',
                                          style: GoogleFonts.poppins(
                                            fontSize: 11,
                                            color: Colors.grey,
                                          ),
                                        ),
                                      ],
                                    ),
                                    const SizedBox(height: 8),
                                    ClipRRect(
                                      borderRadius: BorderRadius.circular(4),
                                      child: LinearProgressIndicator(
                                        value: totalVotes > 0
                                            ? votes / totalVotes
                                            : 0,
                                        backgroundColor: isDark
                                            ? Colors.grey.shade700
                                            : Colors.grey.shade200,
                                        valueColor: AlwaysStoppedAnimation(
                                          isVoted
                                              ? Theme.of(context)
                                                  .colorScheme
                                                  .primary
                                              : Colors.grey.shade400,
                                        ),
                                        minHeight: 6,
                                      ),
                                    ),
                                  ],
                                ),
                              ),
                            ),
                          );
                        }),
                      ],
                    );
                  },
                ),
              ),
            ],

            // Comments Section
            const Divider(height: 1),
            Padding(
              padding: const EdgeInsets.symmetric(horizontal: 16, vertical: 8),
              child: Row(
                children: [
                  StreamBuilder<QuerySnapshot>(
                    stream: FirebaseFirestore.instance
                        .collection('notices')
                        .doc(widget.docId)
                        .collection('comments')
                        .snapshots(),
                    builder: (context, snap) {
                      final count = snap.hasData ? snap.data!.docs.length : 0;
                      return TextButton.icon(
                        icon: Icon(
                          _showComments
                              ? Icons.comment
                              : Icons.comment_outlined,
                          size: 18,
                        ),
                        label: Text(
                          count == 0
                              ? 'Add Comment'
                              : '$count Comment${count == 1 ? '' : 's'}',
                          style: GoogleFonts.poppins(fontSize: 12),
                        ),
                        onPressed: () =>
                            setState(() => _showComments = !_showComments),
                      );
                    },
                  ),
                ],
              ),
            ),
            if (_showComments) ...[
              const Divider(height: 1),
              Padding(
                padding: const EdgeInsets.all(16),
                child: Column(
                  children: [
                    Row(
                      crossAxisAlignment: CrossAxisAlignment.start,
                      children: [
                        Expanded(
                          child: TextField(
                            controller: _commentCtrl,
                            decoration: InputDecoration(
                              hintText: 'Write a comment...',
                              hintStyle: GoogleFonts.poppins(fontSize: 13),
                              border: OutlineInputBorder(
                                borderRadius: BorderRadius.circular(12),
                              ),
                              contentPadding: const EdgeInsets.all(12),
                              isDense: true,
                            ),
                            maxLines: 2,
                          ),
                        ),
                        const SizedBox(width: 8),
                        IconButton(
                          icon: const Icon(Icons.send_rounded),
                          onPressed: _postComment,
                          color: Theme.of(context).colorScheme.primary,
                          style: IconButton.styleFrom(
                            backgroundColor:
                                Theme.of(context).colorScheme.primaryContainer,
                          ),
                        ),
                      ],
                    ),
                    const SizedBox(height: 16),
                    StreamBuilder<QuerySnapshot>(
                      stream: FirebaseFirestore.instance
                          .collection('notices')
                          .doc(widget.docId)
                          .collection('comments')
                          .orderBy('time', descending: true)
                          .snapshots(),
                      builder: (context, snap) {
                        if (!snap.hasData) return const SizedBox.shrink();
                        final comments = snap.data!.docs;
                        if (comments.isEmpty) {
                          return Padding(
                            padding: const EdgeInsets.all(16),
                            child: Text(
                              'No comments yet. Be the first to comment!',
                              style: GoogleFonts.poppins(
                                fontSize: 12,
                                color: Colors.grey,
                                fontStyle: FontStyle.italic,
                              ),
                            ),
                          );
                        }
                        return Column(
                          children: comments.map((doc) {
                            final data = doc.data() as Map<String, dynamic>;
                            final commentText = data['text'] ?? '';
                            final userName = data['userName'] ??
                                data['userEmail']?.split('@')[0] ??
                                'Anonymous';
                            final profilePicUrl = data['profilePicUrl'];

                            ImageProvider? avatarImage;
                            if (profilePicUrl != null) {
                              if (profilePicUrl.startsWith('data:image')) {
                                final base64Data =
                                    profilePicUrl.split(',').last;
                                avatarImage =
                                    MemoryImage(base64Decode(base64Data));
                              } else {
                                avatarImage = NetworkImage(profilePicUrl);
                              }
                            }

                            return Container(
                              margin: const EdgeInsets.only(bottom: 12),
                              padding: const EdgeInsets.all(12),
                              decoration: BoxDecoration(
                                color: Theme.of(context).brightness ==
                                        Brightness.dark
                                    ? Colors.grey.shade800
                                    : Colors.grey.shade100,
                                borderRadius: BorderRadius.circular(12),
                              ),
                              child: Row(
                                crossAxisAlignment: CrossAxisAlignment.start,
                                children: [
                                  CircleAvatar(
                                    radius: 18,
                                    backgroundImage: avatarImage,
                                    child: profilePicUrl == null
                                        ? Text(
                                            userName[0].toUpperCase(),
                                            style:
                                                const TextStyle(fontSize: 14),
                                          )
                                        : null,
                                  ),
                                  const SizedBox(width: 12),
                                  Expanded(
                                    child: Column(
                                      crossAxisAlignment:
                                          CrossAxisAlignment.start,
                                      children: [
                                        Text(
                                          userName,
                                          style: GoogleFonts.poppins(
                                            fontSize: 12,
                                            fontWeight: FontWeight.w600,
                                          ),
                                        ),
                                        const SizedBox(height: 4),
                                        Text(
                                          commentText,
                                          style:
                                              GoogleFonts.poppins(fontSize: 13),
                                        ),
                                      ],
                                    ),
                                  ),
                                  if (widget.isAdmin)
                                    IconButton(
                                      icon: const Icon(Icons.delete, size: 18),
                                      color: Colors.red,
                                      onPressed: () async {
                                        try {
                                          await FirebaseFirestore.instance
                                              .collection('notices')
                                              .doc(widget.docId)
                                              .collection('comments')
                                              .doc(doc.id)
                                              .delete();
                                          Fluttertoast.showToast(
                                              msg: 'Comment deleted');
                                        } catch (e) {
                                          Fluttertoast.showToast(
                                              msg: 'Failed to delete: $e');
                                        }
                                      },
                                    ),
                                ],
                              ),
                            );
                          }).toList(),
                        );
                      },
                    ),
                  ],
                ),
              ),
            ],
          ],
        ),
      ),
    );
  }
}

// -------------------- Profile Page --------------------
class ProfilePage extends StatefulWidget {
  const ProfilePage({super.key});
  @override
  State<ProfilePage> createState() => _ProfilePageState();
}

class _ProfilePageState extends State<ProfilePage> {
  final _nameCtrl = TextEditingController();
  final _regIdCtrl = TextEditingController();
  final _deptCtrl = TextEditingController();
  final _bloodGroupCtrl = TextEditingController();
  final _mobileCtrl = TextEditingController();
  bool _loading = true;
  bool _saving = false;
  bool _isEditing = false;
  String? _profilePicUrl;
  bool _uploadingPhoto = false;

  @override
  void initState() {
    super.initState();
    _loadProfile();
  }

  Future<void> _loadProfile() async {
    final uid = FirebaseAuth.instance.currentUser?.uid;
    if (uid == null) return;

    try {
      final doc =
          await FirebaseFirestore.instance.collection('users').doc(uid).get();
      final data = doc.data() ?? {};

      _nameCtrl.text = data['name'] ?? '';
      _regIdCtrl.text = data['registrationId'] ?? '';
      _deptCtrl.text = data['department'] ?? '';
      _bloodGroupCtrl.text = data['bloodGroup'] ?? '';
      _mobileCtrl.text = data['mobile'] ?? '';
      _profilePicUrl = data['profilePicUrl'];
    } catch (e) {
      Fluttertoast.showToast(msg: 'Failed to load profile: $e');
    } finally {
      if (mounted) setState(() => _loading = false);
    }
  }

  Uint8List _base64ToImage(String base64String) {
    // Remove data:image prefix if present
    final base64Data = base64String.split(',').last;
    return base64Decode(base64Data);
  }

  Future<void> _pickAndUploadPhoto() async {
    try {
      final ImagePicker picker = ImagePicker();
      final XFile? image = await picker.pickImage(
        source: ImageSource.gallery,
        maxWidth: 512,
        maxHeight: 512,
        imageQuality: 75,
      );

      if (image == null) return;

      setState(() => _uploadingPhoto = true);

      final uid = FirebaseAuth.instance.currentUser?.uid;
      if (uid == null) throw Exception('Not authenticated');

      // Convert image to base64 (free storage in Firestore)
      final bytes = await image.readAsBytes();
      final base64Image = base64Encode(bytes);
      final dataUrl = 'data:image/jpeg;base64,$base64Image';

      // Save to Firestore directly (no Storage needed) - use set with merge
      await FirebaseFirestore.instance.collection('users').doc(uid).set({
        'profilePicUrl': dataUrl,
      }, SetOptions(merge: true));

      setState(() => _profilePicUrl = dataUrl);
      Fluttertoast.showToast(msg: 'Profile picture updated');
    } catch (e) {
      Fluttertoast.showToast(msg: 'Failed to upload photo: $e');
    } finally {
      if (mounted) setState(() => _uploadingPhoto = false);
    }
  }

  Future<void> _removeProfilePicture() async {
    try {
      setState(() => _uploadingPhoto = true);

      final uid = FirebaseAuth.instance.currentUser?.uid;
      if (uid == null) throw Exception('Not authenticated');

      // Remove profile picture from Firestore
      await FirebaseFirestore.instance.collection('users').doc(uid).update({
        'profilePicUrl': FieldValue.delete(),
      });

      setState(() => _profilePicUrl = null);
      Fluttertoast.showToast(msg: 'Profile picture removed');
    } catch (e) {
      Fluttertoast.showToast(msg: 'Failed to remove photo: $e');
    } finally {
      if (mounted) setState(() => _uploadingPhoto = false);
    }
  }

  Future<void> _saveProfile() async {
    final uid = FirebaseAuth.instance.currentUser?.uid;
    if (uid == null) return;

    final name = _nameCtrl.text.trim();
    final regId = _regIdCtrl.text.trim();
    final dept = _deptCtrl.text.trim();
    final bloodGroup = _bloodGroupCtrl.text.trim();
    final mobile = _mobileCtrl.text.trim();

    if (name.isEmpty) {
      Fluttertoast.showToast(msg: 'Name is required');
      return;
    }

    setState(() => _saving = true);

    try {
      await FirebaseFirestore.instance.collection('users').doc(uid).set({
        'name': name,
        'registrationId': regId,
        'department': dept,
        'bloodGroup': bloodGroup,
        'mobile': mobile,
        'email': FirebaseAuth.instance.currentUser?.email,
        'updatedAt': FieldValue.serverTimestamp(),
      }, SetOptions(merge: true));

      Fluttertoast.showToast(msg: 'Profile saved');
      if (mounted) setState(() => _isEditing = false);
    } catch (e) {
      Fluttertoast.showToast(msg: 'Failed to save profile: $e');
    } finally {
      if (mounted) setState(() => _saving = false);
    }
  }

  @override
  void dispose() {
    _nameCtrl.dispose();
    _regIdCtrl.dispose();
    _deptCtrl.dispose();
    _bloodGroupCtrl.dispose();
    _mobileCtrl.dispose();
    super.dispose();
  }

  @override
  Widget build(BuildContext context) {
    return Scaffold(
      backgroundColor: darkBg,
      appBar: AppBar(
        backgroundColor: darkBg,
        elevation: 0,
        title: const SizedBox.shrink(),
        actions: [
          IconButton(
            icon: const Icon(Icons.settings, color: neonCyan),
            onPressed: () {
              Navigator.push(
                context,
                MaterialPageRoute(builder: (_) => const SettingsPage()),
              );
            },
            tooltip: 'Settings',
          ),
        ],
      ),
      body: _loading
          ? const Center(child: CircularProgressIndicator(color: neonCyan))
          : Container(
              decoration: BoxDecoration(
                gradient: LinearGradient(
                  begin: Alignment.topLeft,
                  end: Alignment.bottomRight,
                  colors: [
                    darkBg,
                    const Color(0xFF1A1F3A),
                    electricPurple.withOpacity(0.1),
                  ],
                ),
              ),
              child: SingleChildScrollView(
                child: Column(
                  children: [
                    // Profile Picture Section
                    Container(
                      margin: const EdgeInsets.all(20),
                      padding: const EdgeInsets.symmetric(vertical: 32),
                      decoration: BoxDecoration(
                        gradient: LinearGradient(
                          begin: Alignment.topLeft,
                          end: Alignment.bottomRight,
                          colors: [
                            neonCyan.withOpacity(0.1),
                            electricPurple.withOpacity(0.1),
                          ],
                        ),
                        borderRadius: BorderRadius.circular(24),
                        border: Border.all(
                          color: neonCyan.withOpacity(0.3),
                          width: 1.5,
                        ),
                        boxShadow: [
                          BoxShadow(
                            color: neonCyan.withOpacity(0.2),
                            blurRadius: 20,
                            offset: const Offset(0, 10),
                          ),
                        ],
                      ),
                      child: Column(
                        children: [
                          Stack(
                            children: [
                              Container(
                                decoration: BoxDecoration(
                                  shape: BoxShape.circle,
                                  border: Border.all(
                                    color: neonCyan.withOpacity(0.6),
                                    width: 4,
                                  ),
                                  boxShadow: [
                                    BoxShadow(
                                      color: neonCyan.withOpacity(0.4),
                                      blurRadius: 20,
                                      offset: const Offset(0, 8),
                                    ),
                                  ],
                                ),
                                child: CircleAvatar(
                                  radius: 60,
                                  backgroundColor: darkCard,
                                  backgroundImage: _profilePicUrl != null &&
                                          _profilePicUrl!
                                              .startsWith('data:image')
                                      ? MemoryImage(
                                              _base64ToImage(_profilePicUrl!))
                                          as ImageProvider
                                      : (_profilePicUrl != null
                                          ? NetworkImage(_profilePicUrl!)
                                              as ImageProvider
                                          : null),
                                  child: _profilePicUrl == null
                                      ? Text(
                                          _nameCtrl.text.isNotEmpty
                                              ? _nameCtrl.text[0].toUpperCase()
                                              : '?',
                                          style: const TextStyle(
                                            fontSize: 48,
                                            color: neonCyan,
                                            fontWeight: FontWeight.bold,
                                          ),
                                        )
                                      : null,
                                ),
                              ),
                              if (_uploadingPhoto)
                                Positioned.fill(
                                  child: Container(
                                    decoration: BoxDecoration(
                                      shape: BoxShape.circle,
                                      color: Colors.black.withOpacity(0.5),
                                    ),
                                    child: const Center(
                                      child: CircularProgressIndicator(
                                        color: neonCyan,
                                      ),
                                    ),
                                  ),
                                ),
                              Positioned(
                                bottom: 0,
                                right: 0,
                                child: Container(
                                  decoration: BoxDecoration(
                                    shape: BoxShape.circle,
                                    gradient: const LinearGradient(
                                      colors: [neonCyan, electricPurple],
                                    ),
                                    border: Border.all(color: darkBg, width: 3),
                                    boxShadow: [
                                      BoxShadow(
                                        color: neonCyan.withOpacity(0.5),
                                        blurRadius: 10,
                                      ),
                                    ],
                                  ),
                                  child: IconButton(
                                    icon: const Icon(Icons.camera_alt,
                                        color: Colors.white),
                                    onPressed: _uploadingPhoto
                                        ? null
                                        : _pickAndUploadPhoto,
                                    tooltip: 'Change Photo',
                                  ),
                                ),
                              ),
                              if (_profilePicUrl != null)
                                Positioned(
                                  bottom: 0,
                                  left: 0,
                                  child: Container(
                                    decoration: BoxDecoration(
                                      shape: BoxShape.circle,
                                      color: accentPink,
                                      border:
                                          Border.all(color: darkBg, width: 3),
                                      boxShadow: [
                                        BoxShadow(
                                          color: accentPink.withOpacity(0.5),
                                          blurRadius: 10,
                                        ),
                                      ],
                                    ),
                                    child: IconButton(
                                      icon: const Icon(Icons.delete,
                                          color: Colors.white),
                                      onPressed: _uploadingPhoto
                                          ? null
                                          : _removeProfilePicture,
                                      tooltip: 'Remove Photo',
                                    ),
                                  ),
                                ),
                            ],
                          ),
                          const SizedBox(height: 12),
                          Text(
                            FirebaseAuth.instance.currentUser?.email ?? '',
                            style: GoogleFonts.outfit(
                              fontSize: 14,
                              color: Colors.white.withOpacity(0.7),
                            ),
                          ),
                        ],
                      ),
                    ),

                    // Profile Form with Glassmorphism
                    Padding(
                      padding: const EdgeInsets.all(20),
                      child: Column(
                        crossAxisAlignment: CrossAxisAlignment.start,
                        children: [
                          Row(
                            mainAxisAlignment: MainAxisAlignment.spaceBetween,
                            children: [
                              Text(
                                'Personal Information',
                                style: GoogleFonts.outfit(
                                  fontSize: 20,
                                  fontWeight: FontWeight.bold,
                                  color: Colors.white,
                                ),
                              ),
                              if (!_loading)
                                IconButton(
                                  icon: _saving
                                      ? const SizedBox(
                                          width: 20,
                                          height: 20,
                                          child: CircularProgressIndicator(
                                            strokeWidth: 2,
                                            valueColor: AlwaysStoppedAnimation(
                                                neonCyan),
                                          ),
                                        )
                                      : Icon(
                                          _isEditing ? Icons.save : Icons.edit,
                                          color: neonCyan,
                                          size: 24),
                                  onPressed: _saving
                                      ? null
                                      : () {
                                          if (_isEditing) {
                                            _saveProfile();
                                          } else {
                                            setState(() => _isEditing = true);
                                          }
                                        },
                                  tooltip: _isEditing
                                      ? 'Save Profile'
                                      : 'Edit Profile',
                                ),
                            ],
                          ),
                          const SizedBox(height: 20),
                          _buildGlassTextField(
                            controller: _nameCtrl,
                            label: 'Full Name *',
                            icon: Icons.person,
                            enabled: _isEditing,
                            onChanged: (_) => setState(() {}),
                          ),
                          const SizedBox(height: 16),
                          _buildGlassTextField(
                            controller: _regIdCtrl,
                            label: 'Registration ID',
                            hint: 'e.g., 242-50-000',
                            icon: Icons.badge,
                            enabled: _isEditing,
                          ),
                          const SizedBox(height: 16),
                          _buildGlassTextField(
                            controller: _deptCtrl,
                            label: 'Department',
                            hint: 'e.g., ICE',
                            icon: Icons.school,
                            enabled: _isEditing,
                          ),
                          const SizedBox(height: 16),
                          _buildGlassTextField(
                            controller: _bloodGroupCtrl,
                            label: 'Blood Group',
                            hint: 'e.g., O+, A-, B+',
                            icon: Icons.bloodtype,
                            enabled: _isEditing,
                          ),
                          const SizedBox(height: 16),
                          _buildGlassTextField(
                            controller: _mobileCtrl,
                            label: 'Mobile Number',
                            hint: 'e.g., +8801XXXXXXXXX',
                            icon: Icons.phone,
                            keyboardType: TextInputType.phone,
                            enabled: _isEditing,
                          ),
                          if (!_isEditing) const SizedBox(height: 16),
                          if (!_isEditing)
                            Center(
                              child: Text(
                                'Tap the edit icon to modify your profile',
                                style: GoogleFonts.outfit(
                                  color: Colors.white.withOpacity(0.5),
                                  fontSize: 14,
                                  fontStyle: FontStyle.italic,
                                ),
                              ),
                            ),
                        ],
                      ),
                    ),
                  ],
                ),
              ),
            ),
    );
  }

  Widget _buildGlassTextField({
    required TextEditingController controller,
    required String label,
    required IconData icon,
    String? hint,
    TextInputType? keyboardType,
    Function(String)? onChanged,
    bool enabled = true,
  }) {
    return Container(
      decoration: BoxDecoration(
        color: Colors.white.withOpacity(enabled ? 0.08 : 0.02),
        borderRadius: BorderRadius.circular(16),
        border: Border.all(
          color: neonCyan.withOpacity(enabled ? 0.3 : 0.15),
          width: 1.5,
        ),
        boxShadow: [
          BoxShadow(
            color: neonCyan.withOpacity(0.1),
            blurRadius: 10,
            offset: const Offset(0, 4),
          ),
        ],
      ),
      child: TextField(
        controller: controller,
        enabled: enabled,
        keyboardType: keyboardType,
        onChanged: onChanged,
        style: GoogleFonts.outfit(
          color: Colors.grey.shade900,
          fontSize: 16,
          fontWeight: FontWeight.w500,
        ),
        decoration: InputDecoration(
          labelText: label,
          labelStyle: GoogleFonts.outfit(
            color: Colors.grey.shade700,
            fontSize: 14,
            fontWeight: FontWeight.w500,
          ),
          hintText: hint,
          hintStyle: GoogleFonts.outfit(
            color: Colors.grey.shade600,
            fontSize: 14,
          ),
          prefixIcon: Icon(icon, color: neonCyan, size: 20),
          border: InputBorder.none,
          contentPadding: const EdgeInsets.all(16),
        ),
      ),
    );
  }
}

// -------------------- Settings Page --------------------
class SettingsPage extends StatefulWidget {
  const SettingsPage({super.key});
  @override
  State<SettingsPage> createState() => _SettingsPageState();
}

class _SettingsPageState extends State<SettingsPage> {
  bool _darkMode = false;
  bool _notifyNotices = true;
  bool _notifyEvents = true;
  bool _loading = true;
  StreamSubscription<DocumentSnapshot<Map<String, dynamic>>>? _prefsSub;

  Future<void> _loadSettings() async {
    final uid = FirebaseAuth.instance.currentUser?.uid;
    if (uid == null) return;
    try {
      final doc = await FirebaseFirestore.instance
          .collection('users')
          .doc(uid)
          .collection('settings')
          .doc('prefs')
          .get();
      final data = doc.data() ?? {};
      _darkMode = (data['darkMode'] ?? false) as bool;
      _notifyNotices = (data['notifyNotices'] ?? true) as bool;
      _notifyEvents = (data['notifyEvents'] ?? true) as bool;
      // Apply theme immediately based on saved preference
      themeController.setMode(_darkMode ? ThemeMode.dark : ThemeMode.light);
      // Live listen to prefs for immediate reflection
      _prefsSub?.cancel();
      _prefsSub = FirebaseFirestore.instance
          .collection('users')
          .doc(uid)
          .collection('settings')
          .doc('prefs')
          .snapshots()
          .listen((snap) {
        final live = snap.data() ?? {};
        final newDark = (live['darkMode'] ?? false) as bool;
        final newNotices = (live['notifyNotices'] ?? true) as bool;
        final newEvents = (live['notifyEvents'] ?? true) as bool;
        if (mounted) {
          setState(() {
            _darkMode = newDark;
            _notifyNotices = newNotices;
            _notifyEvents = newEvents;
          });
        }
      });
    } catch (_) {}
    if (mounted) setState(() => _loading = false);
  }

  Future<void> _saveSettings() async {
    final uid = FirebaseAuth.instance.currentUser?.uid;
    if (uid == null) return;
    try {
      await FirebaseFirestore.instance
          .collection('users')
          .doc(uid)
          .collection('settings')
          .doc('prefs')
          .set({
        'darkMode': _darkMode,
        'notifyNotices': _notifyNotices,
        'notifyEvents': _notifyEvents,
        'updatedAt': FieldValue.serverTimestamp(),
      }, SetOptions(merge: true));
      Fluttertoast.showToast(msg: 'Settings saved');
    } catch (e) {
      Fluttertoast.showToast(msg: 'Failed to save settings: $e');
    }
  }

  @override
  void initState() {
    super.initState();
    _darkMode = themeController.mode == ThemeMode.dark;
    _loadSettings();
  }

  @override
  void dispose() {
    _prefsSub?.cancel();
    super.dispose();
  }

  @override
  Widget build(BuildContext context) {
    if (_loading) {
      return const Scaffold(body: Center(child: CircularProgressIndicator()));
    }

    return Scaffold(
      backgroundColor: darkBg,
      appBar: AppBar(
        backgroundColor: darkBg,
        elevation: 0,
        title: ShaderMask(
          shaderCallback: (bounds) => const LinearGradient(
            colors: [neonCyan, electricPurple],
          ).createShader(bounds),
          child: Text(
            'Settings',
            style: GoogleFonts.outfit(
              fontWeight: FontWeight.bold,
              fontSize: 22,
              color: Colors.white,
            ),
          ),
        ),
        leading: IconButton(
          icon: const Icon(Icons.arrow_back, color: Colors.white),
          onPressed: () => Navigator.of(context).pop(),
        ),
      ),
      body: Container(
        decoration: BoxDecoration(
          gradient: LinearGradient(
            begin: Alignment.topLeft,
            end: Alignment.bottomRight,
            colors: [
              darkBg,
              const Color(0xFF1A1F3A),
              electricPurple.withOpacity(0.1),
            ],
          ),
        ),
        child: ListView(
          padding: const EdgeInsets.symmetric(vertical: 8),
          children: [
            // Appearance Section
            _buildSectionHeader(context, 'Appearance', Icons.palette),
            Card(
              color: darkCard,
              margin: const EdgeInsets.symmetric(horizontal: 12, vertical: 4),
              child: Column(
                children: [
                  SwitchListTile(
                    secondary: Icon(
                      _darkMode ? Icons.dark_mode : Icons.light_mode,
                      color: neonCyan,
                    ),
                    title: Text('Dark Mode',
                        style: GoogleFonts.outfit(
                            color: Colors.white, fontWeight: FontWeight.bold)),
                    subtitle: Text(_darkMode ? 'Enabled' : 'Disabled',
                        style: GoogleFonts.outfit(
                            color: Colors.white.withOpacity(0.7))),
                    value: _darkMode,
                    onChanged: (v) async {
                      setState(() => _darkMode = v);
                      await _saveSettings();
                      themeController
                          .setMode(v ? ThemeMode.dark : ThemeMode.light);
                    },
                  ),
                ],
              ),
            ),

            const SizedBox(height: 16),

            // Notifications Section
            _buildSectionHeader(context, 'Notifications', Icons.notifications),
            Card(
              color: darkCard,
              margin: const EdgeInsets.symmetric(horizontal: 12, vertical: 4),
              child: Column(
                children: [
                  SwitchListTile(
                    secondary: const Icon(
                      Icons.announcement,
                      color: neonCyan,
                    ),
                    title: Text('Notices',
                        style: GoogleFonts.outfit(
                            color: Colors.white, fontWeight: FontWeight.bold)),
                    subtitle: Text(_notifyNotices ? 'Enabled' : 'Disabled',
                        style: GoogleFonts.outfit(
                            color: Colors.white.withOpacity(0.7))),
                    value: _notifyNotices,
                    onChanged: (v) async {
                      setState(() => _notifyNotices = v);
                      await _saveSettings();
                    },
                  ),
                  Divider(
                    color: Colors.white.withOpacity(0.1),
                    height: 1,
                  ),
                  SwitchListTile(
                    secondary: const Icon(
                      Icons.event,
                      color: neonCyan,
                    ),
                    title: Text('Events',
                        style: GoogleFonts.outfit(
                            color: Colors.white, fontWeight: FontWeight.bold)),
                    subtitle: Text(_notifyEvents ? 'Enabled' : 'Disabled',
                        style: GoogleFonts.outfit(
                            color: Colors.white.withOpacity(0.7))),
                    value: _notifyEvents,
                    onChanged: (v) async {
                      setState(() => _notifyEvents = v);
                      await _saveSettings();
                    },
                  ),
                ],
              ),
            ),

            const SizedBox(height: 16),

            // Account & Security Section
            _buildSectionHeader(context, 'Account & Security', Icons.security),
            Card(
              color: darkCard,
              margin: const EdgeInsets.symmetric(horizontal: 12, vertical: 4),
              child: Column(
                children: [
                  ListTile(
                    leading: const Icon(Icons.lock, color: neonCyan),
                    title: Text(
                      'Change Password',
                      style: GoogleFonts.outfit(
                        color: Colors.white,
                        fontWeight: FontWeight.w600,
                      ),
                    ),
                    subtitle: Text(
                      'Update your account password',
                      style: GoogleFonts.outfit(
                        color: Colors.white.withOpacity(0.7),
                        fontSize: 13,
                      ),
                    ),
                    trailing:
                        const Icon(Icons.chevron_right, color: neonCyan),
                    onTap: () {
                      Navigator.of(context).push(
                        MaterialPageRoute(
                            builder: (_) => const ChangePasswordPage()),
                      );
                    },
                  ),
                  Divider(height: 1, indent: 72,
                      color: Colors.white.withOpacity(0.08)),
                  ListTile(
                    leading: const Icon(Icons.email, color: neonCyan),
                    title: Text(
                      'Email',
                      style: GoogleFonts.outfit(
                        color: Colors.white,
                        fontWeight: FontWeight.w600,
                      ),
                    ),
                    subtitle: Text(
                      FirebaseAuth.instance.currentUser?.email ??
                          'Not available',
                      style: GoogleFonts.outfit(
                        color: Colors.white.withOpacity(0.7),
                        fontSize: 13,
                      ),
                    ),
                    trailing: Container(
                      padding: const EdgeInsets.symmetric(
                          horizontal: 8, vertical: 4),
                      decoration: BoxDecoration(
                        color: Colors.green.withOpacity(0.15),
                        borderRadius: BorderRadius.circular(12),
                      ),
                      child: const Text(
                        'Verified',
                        style: TextStyle(
                            color: Colors.green,
                            fontSize: 12,
                            fontWeight: FontWeight.bold),
                      ),
                    ),
                  ),
                ],
              ),
            ),

            const SizedBox(height: 16),

            // About Section
            _buildSectionHeader(context, 'About', Icons.info),
            Card(
              color: darkCard,
              margin: const EdgeInsets.symmetric(horizontal: 12, vertical: 4),
              child: Column(
                children: [
                  ListTile(
                    leading: const Icon(Icons.info_outline, color: neonCyan),
                    title: Text(
                      'About INFYNERS',
                      style: GoogleFonts.outfit(
                        color: Colors.white,
                        fontWeight: FontWeight.w500,
                      ),
                    ),
                    subtitle: Text(
                      'App information and developer details',
                      style: GoogleFonts.outfit(
                        color: Colors.white.withOpacity(0.7),
                      ),
                    ),
                    trailing: const Icon(Icons.chevron_right, color: neonCyan),
                    onTap: () {
                      Navigator.of(context).push(
                        MaterialPageRoute(builder: (_) => const AboutUsPage()),
                      );
                    },
                  ),
                  Divider(
                      height: 1,
                      indent: 72,
                      color: Colors.white.withOpacity(0.1)),
                  ListTile(
                    leading: const Icon(Icons.policy, color: neonCyan),
                    title: Text(
                      'Privacy Policy',
                      style: GoogleFonts.outfit(
                        color: Colors.white,
                        fontWeight: FontWeight.w500,
                      ),
                    ),
                    subtitle: Text(
                      'How we handle your data',
                      style: GoogleFonts.outfit(
                        color: Colors.white.withOpacity(0.7),
                      ),
                    ),
                    trailing: const Icon(Icons.chevron_right, color: neonCyan),
                    onTap: () {
                      showDialog(
                        context: context,
                        builder: (context) => AlertDialog(
                          backgroundColor: darkCard,
                          title: Text(
                            'Privacy Policy',
                            style: GoogleFonts.outfit(
                              color: neonCyan,
                              fontWeight: FontWeight.bold,
                            ),
                          ),
                          content: SingleChildScrollView(
                            child: Text(
                              'INFYNERS respects your privacy. We collect and store only the information necessary to provide you with our services.\n\n'
                              'Data Collection:\n'
                              ' Email and profile information\n'
                              ' Notices and event data\n'
                              ' User preferences\n\n'
                              'Data Usage:\n'
                              ' All data is stored securely in Firebase\n'
                              ' We do not share your information with third parties\n'
                              ' Your data is used only for app functionality\n\n'
                              'Your Rights:\n'
                              ' You can update your profile anytime\n'
                              ' You can request data deletion by contacting admin',
                              style: GoogleFonts.outfit(
                                color: Colors.white.withOpacity(0.85),
                                fontSize: 13,
                                height: 1.5,
                              ),
                            ),
                          ),
                          actions: [
                            TextButton(
                              onPressed: () => Navigator.pop(context),
                              child: Text(
                                'Close',
                                style: GoogleFonts.outfit(
                                  color: neonCyan,
                                  fontWeight: FontWeight.bold,
                                ),
                              ),
                            ),
                          ],
                        ),
                      );
                    },
                  ),
                  Divider(
                      height: 1,
                      indent: 72,
                      color: Colors.white.withOpacity(0.1)),
                  ListTile(
                    leading: const Icon(Icons.article, color: neonCyan),
                    title: Text(
                      'Terms of Service',
                      style: GoogleFonts.outfit(
                        color: Colors.white,
                        fontWeight: FontWeight.w500,
                      ),
                    ),
                    subtitle: Text(
                      'Terms and conditions',
                      style: GoogleFonts.outfit(
                        color: Colors.white.withOpacity(0.7),
                      ),
                    ),
                    trailing: const Icon(Icons.chevron_right, color: neonCyan),
                    onTap: () {
                      showDialog(
                        context: context,
                        builder: (context) => AlertDialog(
                          backgroundColor: darkCard,
                          title: Text(
                            'Terms of Service',
                            style: GoogleFonts.outfit(
                              color: neonCyan,
                              fontWeight: FontWeight.bold,
                            ),
                          ),
                          content: SingleChildScrollView(
                            child: Text(
                              'By using INFYNERS, you agree to the following terms:\n\n'
                              '1. User Conduct:\n'
                              ' Be respectful to other members\n'
                              ' Do not post inappropriate content\n'
                              ' Follow academic integrity guidelines\n\n'
                              '2. Account Responsibility:\n'
                              ' Keep your password secure\n'
                              ' Do not share your account\n'
                              ' Report any security issues\n\n'
                              '3. Content Guidelines:\n'
                              ' Posted content should be relevant\n'
                              ' Do not spread misinformation\n'
                              ' Respect intellectual property\n\n'
                              '4. Service Availability:\n'
                              ' We strive for 24/7 availability\n'
                              ' Maintenance may cause downtime\n'
                              ' Features may be updated',
                              style: GoogleFonts.outfit(
                                color: Colors.white.withOpacity(0.85),
                                fontSize: 13,
                                height: 1.5,
                              ),
                            ),
                          ),
                          actions: [
                            TextButton(
                              onPressed: () => Navigator.pop(context),
                              child: Text(
                                'Close',
                                style: GoogleFonts.outfit(
                                  color: neonCyan,
                                  fontWeight: FontWeight.bold,
                                ),
                              ),
                            ),
                          ],
                        ),
                      );
                    },
                  ),
                  Divider(height: 1, indent: 72,
                      color: Colors.white.withOpacity(0.1)),
                  ListTile(
                    leading: const Icon(Icons.badge, color: Colors.grey),
                    title: Text(
                      'App Version',
                      style: GoogleFonts.outfit(
                        color: Colors.white,
                        fontWeight: FontWeight.w600,
                      ),
                    ),
                    subtitle: Text(
                      '1.0.0+1',
                      style: GoogleFonts.outfit(
                        color: Colors.white.withOpacity(0.7),
                        fontSize: 13,
                      ),
                    ),
                    trailing: Container(
                      padding: const EdgeInsets.symmetric(
                          horizontal: 8, vertical: 4),
                      decoration: BoxDecoration(
                        color: Colors.blue.withOpacity(0.1),
                        borderRadius: BorderRadius.circular(12),
                      ),
                      child: const Text(
                        'Latest',
                        style: TextStyle(
                            color: Colors.blue,
                            fontSize: 12,
                            fontWeight: FontWeight.bold),
                      ),
                    ),
                  ),
                ],
              ),
            ),

            const SizedBox(height: 24),

            // Footer
            Padding(
              padding: const EdgeInsets.symmetric(horizontal: 16),
              child: Column(
                children: [
                  Text(
                    'INFYNERS',
                    style: GoogleFonts.outfit(
                      fontSize: 16,
                      fontWeight: FontWeight.bold,
                      color: neonCyan,
                    ),
                  ),
                  const SizedBox(height: 4),
                  Text(
                    'Batch Notice & Updates Platform',
                    style: GoogleFonts.outfit(
                      fontSize: 12,
                      color: Colors.white.withOpacity(0.7),
                    ),
                  ),
                  const SizedBox(height: 16),
                ],
              ),
            ),
          ],
        ),
      ),
    );
  }

  Widget _buildSectionHeader(
      BuildContext context, String title, IconData icon) {
    return Padding(
      padding: const EdgeInsets.symmetric(horizontal: 12, vertical: 12),
      child: Row(
        children: [
          Icon(icon, color: neonCyan, size: 24),
          const SizedBox(width: 12),
          Text(
            title,
            style: GoogleFonts.outfit(
              fontSize: 18,
              fontWeight: FontWeight.bold,
              color: Colors.white,
            ),
          ),
        ],
      ),
    );
  }
}

// -------------------- About Us Page --------------------
class AboutUsPage extends StatelessWidget {
  const AboutUsPage({super.key});

  @override
  Widget build(BuildContext context) {
    return Scaffold(
      backgroundColor: darkBg,
      appBar: AppBar(
        backgroundColor: darkBg,
        elevation: 0,
        title: ShaderMask(
          shaderCallback: (bounds) => const LinearGradient(
            colors: [neonCyan, electricPurple],
          ).createShader(bounds),
          child: Text(
            'About Us',
            style: GoogleFonts.outfit(
              fontWeight: FontWeight.bold,
              fontSize: 22,
              color: Colors.white,
            ),
          ),
        ),
        leading: IconButton(
          icon: const Icon(Icons.arrow_back, color: Colors.white),
          onPressed: () => Navigator.of(context).pop(),
        ),
      ),
      body: Container(
        decoration: BoxDecoration(
          gradient: LinearGradient(
            begin: Alignment.topLeft,
            end: Alignment.bottomRight,
            colors: [
              darkBg,
              const Color(0xFF1A1F3A),
              electricPurple.withOpacity(0.1),
            ],
          ),
        ),
        child: SingleChildScrollView(
          child: Column(
            children: [
            // App Header
            Container(
              width: double.infinity,
              decoration: BoxDecoration(
                gradient: LinearGradient(
                  begin: Alignment.topLeft,
                  end: Alignment.bottomRight,
                  colors: [
                    Theme.of(context).colorScheme.primary,
                    Theme.of(context).colorScheme.secondary,
                  ],
                ),
              ),
              padding: const EdgeInsets.symmetric(vertical: 40, horizontal: 24),
              child: Column(
                children: [
                  Container(
                    width: 100,
                    height: 100,
                    decoration: BoxDecoration(
                      color: Colors.white.withOpacity(0.2),
                      shape: BoxShape.circle,
                      border: Border.all(color: Colors.white, width: 3),
                    ),
                    child: const Icon(
                      Icons.school,
                      size: 60,
                      color: Colors.white,
                    ),
                  ),
                  const SizedBox(height: 16),
                  Text(
                    'INFYNERS',
                    style: GoogleFonts.poppins(
                      fontSize: 32,
                      fontWeight: FontWeight.bold,
                      color: Colors.white,
                      letterSpacing: 2,
                    ),
                  ),
                  const SizedBox(height: 8),
                  Text(
                    'Batch Notice & Updates Platform',
                    style: GoogleFonts.poppins(
                      fontSize: 14,
                      color: Colors.white.withOpacity(0.9),
                    ),
                    textAlign: TextAlign.center,
                  ),
                  const SizedBox(height: 4),
                  Container(
                    padding:
                        const EdgeInsets.symmetric(horizontal: 12, vertical: 6),
                    decoration: BoxDecoration(
                      color: Colors.white.withOpacity(0.2),
                      borderRadius: BorderRadius.circular(20),
                    ),
                    child: Text(
                      'Version 1.0.0',
                      style: TextStyle(
                        fontSize: 12,
                        color: Colors.white.withOpacity(0.9),
                      ),
                    ),
                  ),
                ],
              ),
            ),

            Padding(
              padding: const EdgeInsets.all(24),
              child: Column(
                crossAxisAlignment: CrossAxisAlignment.start,
                children: [
                  // About Section
                  _buildSectionTitle(
                      context, 'About the App', Icons.info_outline),
                  const SizedBox(height: 12),
                  Container(
                    decoration: BoxDecoration(
                      color: darkCard,
                      borderRadius: BorderRadius.circular(12),
                      border: Border.all(
                        color: neonCyan.withOpacity(0.2),
                        width: 1,
                      ),
                      boxShadow: [
                        BoxShadow(
                          color: neonCyan.withOpacity(0.1),
                          blurRadius: 10,
                          offset: const Offset(0, 4),
                        ),
                      ],
                    ),
                    child: Padding(
                      padding: const EdgeInsets.all(20),
                      child: Column(
                        crossAxisAlignment: CrossAxisAlignment.start,
                        children: [
                          Text(
                            'INFYNERS is a comprehensive batch notice and updates management platform designed to streamline communication between students and educators.',
                            style: GoogleFonts.outfit(
                              fontSize: 14,
                              height: 1.6,
                              color: Colors.white.withOpacity(0.85),
                            ),
                          ),
                          const SizedBox(height: 16),
                          Text(
                            'Key Features:',
                            style: GoogleFonts.outfit(
                              fontSize: 14,
                              fontWeight: FontWeight.w600,
                              color: neonCyan,
                            ),
                          ),
                          const SizedBox(height: 8),
                          _buildFeatureItem(Icons.announcement,
                              'Real-time notices and updates'),
                          _buildFeatureItem(
                              Icons.poll, 'Interactive polls and voting'),
                          _buildFeatureItem(
                              Icons.event, 'Event and exam management'),
                          _buildFeatureItem(
                              Icons.schedule, 'Class routine tracking'),
                          _buildFeatureItem(
                              Icons.comment, 'Comments and discussions'),
                          _buildFeatureItem(
                              Icons.notifications, 'Push notifications'),
                          _buildFeatureItem(
                              Icons.analytics, 'Admin analytics dashboard'),
                          _buildFeatureItem(Icons.people, 'Member management'),
                        ],
                      ),
                    ),
                  ),

                  const SizedBox(height: 32),

                  // Developer Section
                  _buildSectionTitle(context, 'Developer', Icons.code),
                  const SizedBox(height: 12),
                  Card(
                    color: darkCard,
                    elevation: 2,
                    child: Padding(
                      padding: const EdgeInsets.all(20),
                      child: Column(
                        children: [
                          CircleAvatar(
                            radius: 50,
                            backgroundColor:
                                Theme.of(context).colorScheme.primary,
                            child: const Icon(
                              Icons.person,
                              size: 50,
                              color: Colors.white,
                            ),
                          ),
                          const SizedBox(height: 16),
                          Text(
                            'Sagnik Saha Dibbay',
                            style: GoogleFonts.poppins(
                              fontSize: 20,
                              fontWeight: FontWeight.bold,
                              color: Colors.white,
                            ),
                          ),
                          const SizedBox(height: 4),
                          Text(
                            'Software Developer',
                            style: GoogleFonts.poppins(
                              fontSize: 14,
                              color: Colors.white.withOpacity(0.7),
                            ),
                          ),
                          const SizedBox(height: 20),
                          Divider(color: Colors.white.withOpacity(0.1)),
                          const SizedBox(height: 16),
                          _buildInfoRow(
                              Icons.badge, 'Student ID', '242-50-014'),
                          const SizedBox(height: 12),
                          _buildInfoRow(Icons.business, 'Department',
                              'Information and Communication Engineering'),
                          const SizedBox(height: 12),
                          _buildInfoRow(Icons.school, 'University',
                              'Daffodil International University'),
                          const SizedBox(height: 20),
                          Container(
                            padding: const EdgeInsets.all(16),
                            decoration: BoxDecoration(
                              gradient: const LinearGradient(
                                colors: [neonCyan, electricPurple],
                                begin: Alignment.topLeft,
                                end: Alignment.bottomRight,
                              ),
                              borderRadius: BorderRadius.circular(12),
                            ),
                            child: Row(
                              children: [
                                const Icon(
                                  Icons.lightbulb_outline,
                                  color: Colors.white,
                                ),
                                const SizedBox(width: 12),
                                Expanded(
                                  child: Text(
                                    'Passionate about creating innovative solutions for educational institutions',
                                    style: GoogleFonts.poppins(
                                      fontSize: 12,
                                      fontStyle: FontStyle.italic,
                                      color: Colors.white,
                                    ),
                                  ),
                                ),
                              ],
                            ),
                          ),
                        ],
                      ),
                    ),
                  ),

                  const SizedBox(height: 32),

                  // Technology Stack
                  _buildSectionTitle(context, 'Built With', Icons.build),
                  const SizedBox(height: 12),
                  Card(
                    color: darkCard,
                    elevation: 2,
                    child: Padding(
                      padding: const EdgeInsets.all(20),
                      child: Column(
                        children: [
                          _buildTechItem('Flutter', 'Cross-platform framework'),
                          _buildTechItem(
                              'Firebase', 'Backend services & authentication'),
                          _buildTechItem('Firestore', 'Cloud database'),
                          _buildTechItem(
                              'Material Design 3', 'Modern UI components'),
                          _buildTechItem('Google Fonts', 'Typography'),
                        ],
                      ),
                    ),
                  ),

                  const SizedBox(height: 32),

                  // Contact Section
                  _buildSectionTitle(
                      context, 'Get in Touch', Icons.contact_mail),
                  const SizedBox(height: 12),
                  Card(
                    color: darkCard,
                    elevation: 2,
                    child: Padding(
                      padding: const EdgeInsets.all(20),
                      child: Column(
                        children: [
                          Text(
                            'Have questions or feedback? Feel free to reach out!',
                            textAlign: TextAlign.center,
                            style: GoogleFonts.poppins(
                              fontSize: 14,
                              color: Colors.white.withOpacity(0.8),
                            ),
                          ),
                          const SizedBox(height: 20),
                          ElevatedButton.icon(
                            onPressed: () async {
                              final email =
                                  FirebaseAuth.instance.currentUser?.email;
                              if (email != null) {
                                Fluttertoast.showToast(
                                  msg: 'Contact feature coming soon!',
                                  toastLength: Toast.LENGTH_SHORT,
                                );
                              }
                            },
                            icon: const Icon(Icons.email),
                            label: const Text('Send Feedback'),
                            style: ElevatedButton.styleFrom(
                              backgroundColor: electricPurple,
                              foregroundColor: Colors.white,
                              padding: const EdgeInsets.symmetric(
                                  horizontal: 24, vertical: 12),
                            ),
                          ),
                        ],
                      ),
                    ),
                  ),

                  const SizedBox(height: 32),

                  // Footer
                  Center(
                    child: Column(
                      children: [
                        Text(
                          ' 2025 INFYNERS',
                          style: GoogleFonts.outfit(
                            fontSize: 12,
                            color: Colors.white.withOpacity(0.7),
                          ),
                        ),
                        const SizedBox(height: 4),
                        Text(
                          'Made for Dept. of ICE, Daffodil International University',
                          style: GoogleFonts.outfit(
                            fontSize: 11,
                            color: Colors.white.withOpacity(0.6),
                          ),
                          textAlign: TextAlign.center,
                        ),
                      ],
                    ),
                  ),
                  const SizedBox(height: 24),
                ],
              ),
            ),
          ],
        ),
      ),
    ),
  );
  }

  Widget _buildSectionTitle(BuildContext context, String title, IconData icon) {
    return Row(
      children: [
        Container(
          padding: const EdgeInsets.all(8),
          decoration: BoxDecoration(
            color: electricPurple.withOpacity(0.2),
            borderRadius: BorderRadius.circular(8),
            border: Border.all(
              color: neonCyan.withOpacity(0.3),
              width: 1,
            ),
          ),
          child: Icon(
            icon,
            size: 20,
            color: neonCyan,
          ),
        ),
        const SizedBox(width: 12),
        Text(
          title,
          style: GoogleFonts.outfit(
            fontSize: 18,
            fontWeight: FontWeight.bold,
            color: Colors.white,
          ),
        ),
      ],
    );
  }

  Widget _buildFeatureItem(IconData icon, String text) {
    return Padding(
      padding: const EdgeInsets.symmetric(vertical: 4),
      child: Row(
        children: [
          Icon(icon, size: 18, color: neonCyan),
          const SizedBox(width: 12),
          Expanded(
            child: Text(
              text,
              style: GoogleFonts.outfit(
                fontSize: 13,
                color: Colors.white.withOpacity(0.85),
              ),
            ),
          ),
        ],
      ),
    );
  }

  Widget _buildInfoRow(IconData icon, String label, String value) {
    return Row(
      crossAxisAlignment: CrossAxisAlignment.start,
      children: [
        Icon(icon, size: 20, color: neonCyan),
        const SizedBox(width: 12),
        Expanded(
          child: Column(
            crossAxisAlignment: CrossAxisAlignment.start,
            children: [
              Text(
                label,
                style: GoogleFonts.poppins(
                  fontSize: 12,
                  color: Colors.white.withOpacity(0.7),
                ),
              ),
              const SizedBox(height: 2),
              Text(
                value,
                style: GoogleFonts.poppins(
                  fontSize: 14,
                  fontWeight: FontWeight.w500,
                  color: Colors.white,
                ),
              ),
            ],
          ),
        ),
      ],
    );
  }

  Widget _buildTechItem(String tech, String description) {
    return Padding(
      padding: const EdgeInsets.symmetric(vertical: 8),
      child: Row(
        children: [
          Container(
            width: 8,
            height: 8,
            decoration: const BoxDecoration(
              color: neonCyan,
              shape: BoxShape.circle,
            ),
          ),
          const SizedBox(width: 12),
          Expanded(
            child: Column(
              crossAxisAlignment: CrossAxisAlignment.start,
              children: [
                Text(
                  tech,
                  style: GoogleFonts.poppins(
                    fontSize: 14,
                    fontWeight: FontWeight.w600,
                    color: Colors.white,
                  ),
                ),
                Text(
                  description,
                  style: GoogleFonts.poppins(
                    fontSize: 12,
                    color: Colors.white.withOpacity(0.75),
                  ),
                ),
              ],
            ),
          ),
        ],
      ),
    );
  }
}

// -------------------- Change Password Page --------------------
class ChangePasswordPage extends StatefulWidget {
  const ChangePasswordPage({super.key});
  @override
  State<ChangePasswordPage> createState() => _ChangePasswordPageState();
}

class _ChangePasswordPageState extends State<ChangePasswordPage> {
  final _currentPasswordCtrl = TextEditingController();
  final _newPasswordCtrl = TextEditingController();
  final _confirmPasswordCtrl = TextEditingController();
  bool _loading = false;
  bool _showCurrentPassword = false;
  bool _showNewPassword = false;
  bool _showConfirmPassword = false;

  @override
  void dispose() {
    _currentPasswordCtrl.dispose();
    _newPasswordCtrl.dispose();
    _confirmPasswordCtrl.dispose();
    super.dispose();
  }

  Future<void> _changePassword() async {
    final currentPassword = _currentPasswordCtrl.text.trim();
    final newPassword = _newPasswordCtrl.text.trim();
    final confirmPassword = _confirmPasswordCtrl.text.trim();

    if (currentPassword.isEmpty ||
        newPassword.isEmpty ||
        confirmPassword.isEmpty) {
      Fluttertoast.showToast(msg: 'Please fill all fields');
      return;
    }

    if (newPassword.length < 6) {
      Fluttertoast.showToast(msg: 'New password must be at least 6 characters');
      return;
    }

    if (newPassword != confirmPassword) {
      Fluttertoast.showToast(msg: 'New passwords do not match');
      return;
    }

    setState(() => _loading = true);

    try {
      final user = FirebaseAuth.instance.currentUser;
      if (user == null || user.email == null) {
        throw Exception('No user logged in');
      }

      // Re-authenticate user with current password
      final credential = EmailAuthProvider.credential(
        email: user.email!,
        password: currentPassword,
      );
      await user.reauthenticateWithCredential(credential);

      // Update password
      await user.updatePassword(newPassword);

      Fluttertoast.showToast(msg: 'Password changed successfully');
      if (mounted) Navigator.pop(context);
    } on FirebaseAuthException catch (e) {
      String message = 'Failed to change password';
      if (e.code == 'wrong-password') {
        message = 'Current password is incorrect';
      } else if (e.code == 'weak-password') {
        message = 'New password is too weak';
      } else if (e.code == 'requires-recent-login') {
        message = 'Please logout and login again before changing password';
      }
      Fluttertoast.showToast(msg: message);
    } catch (e) {
      Fluttertoast.showToast(msg: 'Error: ${e.toString()}');
    } finally {
      if (mounted) setState(() => _loading = false);
    }
  }

  @override
  Widget build(BuildContext context) {
    return Scaffold(
      backgroundColor: darkBg,
      appBar: AppBar(
        backgroundColor: darkBg,
        elevation: 0,
        title: ShaderMask(
          shaderCallback: (bounds) => const LinearGradient(
            colors: [neonCyan, electricPurple],
          ).createShader(bounds),
          child: Text(
            'Change Password',
            style: GoogleFonts.outfit(
              fontWeight: FontWeight.bold,
              fontSize: 22,
              color: Colors.white,
            ),
          ),
        ),
        leading: IconButton(
          icon: const Icon(Icons.arrow_back, color: Colors.white),
          onPressed: () => Navigator.of(context).pop(),
        ),
      ),
      body: Container(
        decoration: BoxDecoration(
          gradient: LinearGradient(
            begin: Alignment.topLeft,
            end: Alignment.bottomRight,
            colors: [
              darkBg,
              const Color(0xFF1A1F3A),
              electricPurple.withOpacity(0.1),
            ],
          ),
        ),
        child: SingleChildScrollView(
          padding: const EdgeInsets.all(16),
          child: Column(
            crossAxisAlignment: CrossAxisAlignment.start,
            children: [
              Text(
                'Enter your current password and choose a new one',
                style: GoogleFonts.outfit(
                  color: Colors.white.withOpacity(0.8),
                  fontSize: 14,
                ),
              ),
              const SizedBox(height: 24),
              _glassField(
                controller: _currentPasswordCtrl,
                label: 'Current Password',
                icon: Icons.lock_outline,
                obscure: !_showCurrentPassword,
                toggle: () => setState(
                    () => _showCurrentPassword = !_showCurrentPassword),
              ),
              const SizedBox(height: 16),
              _glassField(
                controller: _newPasswordCtrl,
                label: 'New Password',
                icon: Icons.lock,
                helper: 'At least 6 characters',
                obscure: !_showNewPassword,
                toggle: () =>
                    setState(() => _showNewPassword = !_showNewPassword),
              ),
              const SizedBox(height: 16),
              _glassField(
                controller: _confirmPasswordCtrl,
                label: 'Confirm New Password',
                icon: Icons.lock,
                obscure: !_showConfirmPassword,
                toggle: () => setState(
                    () => _showConfirmPassword = !_showConfirmPassword),
              ),
              const SizedBox(height: 24),
              SizedBox(
                width: double.infinity,
                height: 48,
                child: ElevatedButton(
                  onPressed: _loading ? null : _changePassword,
                  style: ElevatedButton.styleFrom(
                    backgroundColor: electricPurple,
                    foregroundColor: Colors.white,
                    shape: RoundedRectangleBorder(
                      borderRadius: BorderRadius.circular(14),
                    ),
                  ),
                  child: _loading
                      ? const SizedBox(
                          height: 20,
                          width: 20,
                          child: CircularProgressIndicator(
                              color: Colors.white, strokeWidth: 2),
                        )
                      : Text(
                          'Change Password',
                          style: GoogleFonts.outfit(
                              fontWeight: FontWeight.bold, fontSize: 16),
                        ),
                ),
              ),
            ],
          ),
        ),
      ),
    );
  }

  Widget _glassField({
    required TextEditingController controller,
    required String label,
    required IconData icon,
    String? helper,
    required bool obscure,
    required VoidCallback toggle,
  }) {
    return Container(
      decoration: BoxDecoration(
        color: Colors.white,
        borderRadius: BorderRadius.circular(16),
        border: Border.all(color: neonCyan.withOpacity(0.35), width: 1.5),
        boxShadow: [
          BoxShadow(
            color: neonCyan.withOpacity(0.12),
            blurRadius: 14,
            offset: const Offset(0, 6),
          ),
        ],
      ),
      child: TextField(
        controller: controller,
        obscureText: obscure,
        style: GoogleFonts.outfit(
          color: Colors.grey.shade900,
          fontSize: 15,
          fontWeight: FontWeight.w500,
        ),
        decoration: InputDecoration(
          labelText: label,
          labelStyle: GoogleFonts.outfit(
            color: Colors.grey.shade700,
            fontWeight: FontWeight.w600,
          ),
          prefixIcon: Icon(icon, color: neonCyan),
          suffixIcon: IconButton(
            icon: Icon(obscure ? Icons.visibility : Icons.visibility_off,
                color: Colors.grey.shade700),
            onPressed: toggle,
          ),
          hintStyle: GoogleFonts.outfit(color: Colors.grey.shade600),
          helperText: helper,
          helperStyle:
              GoogleFonts.outfit(color: Colors.grey.shade700, fontSize: 12),
          border: InputBorder.none,
          contentPadding: const EdgeInsets.symmetric(
              horizontal: 14, vertical: 16),
        ),
      ),
    );
  }
}

// -------------------- Analytics Page --------------------
class AnalyticsPage extends StatelessWidget {
  const AnalyticsPage({super.key});

  @override
  Widget build(BuildContext context) {
    return Scaffold(
      backgroundColor: darkBg,
      appBar: AppBar(
        backgroundColor: darkBg,
        elevation: 0,
        title: ShaderMask(
          shaderCallback: (bounds) => const LinearGradient(
            colors: [neonCyan, electricPurple],
          ).createShader(bounds),
          child: Text(
            'Analytics',
            style: GoogleFonts.outfit(
              fontWeight: FontWeight.bold,
              fontSize: 22,
              color: Colors.white,
            ),
          ),
        ),
        leading: IconButton(
          icon: const Icon(Icons.arrow_back, color: Colors.white),
          onPressed: () => Navigator.pop(context),
        ),
      ),
      body: Container(
        decoration: BoxDecoration(
          gradient: LinearGradient(
            begin: Alignment.topLeft,
            end: Alignment.bottomRight,
            colors: [
              darkBg,
              const Color(0xFF1A1F3A),
              electricPurple.withOpacity(0.1),
            ],
          ),
        ),
        child: SingleChildScrollView(
          padding: const EdgeInsets.all(16),
          child: Column(
            crossAxisAlignment: CrossAxisAlignment.start,
            children: [
              Text('Content Statistics',
                  style: GoogleFonts.outfit(
                      fontSize: 20,
                      fontWeight: FontWeight.bold,
                      color: Colors.white)),
              const SizedBox(height: 16),
              StreamBuilder<QuerySnapshot>(
                stream: FirebaseFirestore.instance
                    .collection('notices')
                    .snapshots(),
                builder: (context, snap) {
                  final noticeCount = snap.hasData ? snap.data!.docs.length : 0;
                  final pollCount = snap.hasData
                      ? snap.data!.docs
                          .where((d) =>
                              (d.data() as Map<String, dynamic>)['isPoll'] ==
                              true)
                          .length
                      : 0;

                  return Container(
                    decoration: BoxDecoration(
                      gradient: LinearGradient(
                        begin: Alignment.topLeft,
                        end: Alignment.bottomRight,
                        colors: [
                          neonCyan.withOpacity(0.1),
                          electricPurple.withOpacity(0.1),
                        ],
                      ),
                      borderRadius: BorderRadius.circular(16),
                      border: Border.all(
                        color: neonCyan.withOpacity(0.3),
                        width: 1.5,
                      ),
                      boxShadow: [
                        BoxShadow(
                          color: neonCyan.withOpacity(0.2),
                          blurRadius: 15,
                          offset: const Offset(0, 8),
                        ),
                      ],
                    ),
                    child: ListTile(
                      leading:
                          const Icon(Icons.announcement, size: 40, color: neonCyan),
                      title: Text('Total Notices',
                          style: GoogleFonts.outfit(
                              fontWeight: FontWeight.bold,
                              color: Colors.white)),
                      subtitle: Text('Polls: $pollCount',
                          style: GoogleFonts.outfit(
                              color: Colors.white.withOpacity(0.7))),
                      trailing: Text('$noticeCount',
                          style: GoogleFonts.outfit(
                              fontSize: 24,
                              fontWeight: FontWeight.bold,
                              color: neonCyan)),
                    ),
                  );
                },
              ),
              const SizedBox(height: 8),
              StreamBuilder<QuerySnapshot>(
                stream:
                    FirebaseFirestore.instance.collection('exams').snapshots(),
                builder: (context, snap) {
                  final eventCount = snap.hasData ? snap.data!.docs.length : 0;
                  final withDates = snap.hasData
                      ? snap.data!.docs
                          .where((d) =>
                              (d.data() as Map<String, dynamic>)['eventDate'] !=
                              null)
                          .length
                      : 0;

                  return Container(
                    decoration: BoxDecoration(
                      gradient: LinearGradient(
                        begin: Alignment.topLeft,
                        end: Alignment.bottomRight,
                        colors: [
                          accentGreen.withOpacity(0.1),
                          neonCyan.withOpacity(0.1),
                        ],
                      ),
                      borderRadius: BorderRadius.circular(16),
                      border: Border.all(
                        color: accentGreen.withOpacity(0.3),
                        width: 1.5,
                      ),
                      boxShadow: [
                        BoxShadow(
                          color: accentGreen.withOpacity(0.2),
                          blurRadius: 15,
                          offset: const Offset(0, 8),
                        ),
                      ],
                    ),
                    child: ListTile(
                      leading: const Icon(Icons.event, size: 40, color: accentGreen),
                      title: Text('Total Events',
                          style: GoogleFonts.outfit(
                              fontWeight: FontWeight.bold,
                              color: Colors.white)),
                      subtitle: Text('With dates: $withDates',
                          style: GoogleFonts.outfit(
                              color: Colors.white.withOpacity(0.7))),
                      trailing: Text('$eventCount',
                          style: GoogleFonts.outfit(
                              fontSize: 24,
                              fontWeight: FontWeight.bold,
                              color: accentGreen)),
                    ),
                  );
                },
              ),
              const SizedBox(height: 24),
              Text('Engagement',
                  style: GoogleFonts.outfit(
                      fontSize: 20,
                      fontWeight: FontWeight.bold,
                      color: Colors.white)),
              const SizedBox(height: 16),
              StreamBuilder<QuerySnapshot>(
                stream: FirebaseFirestore.instance
                    .collectionGroup('comments')
                    .snapshots(),
                builder: (context, snap) {
                  final commentCount =
                      snap.hasData ? snap.data!.docs.length : 0;

                  return Container(
                    decoration: BoxDecoration(
                      gradient: LinearGradient(
                        begin: Alignment.topLeft,
                        end: Alignment.bottomRight,
                        colors: [
                          accentPink.withOpacity(0.1),
                          electricPurple.withOpacity(0.1),
                        ],
                      ),
                      borderRadius: BorderRadius.circular(16),
                      border: Border.all(
                        color: accentPink.withOpacity(0.3),
                        width: 1.5,
                      ),
                      boxShadow: [
                        BoxShadow(
                          color: accentPink.withOpacity(0.2),
                          blurRadius: 15,
                          offset: const Offset(0, 8),
                        ),
                      ],
                    ),
                    child: ListTile(
                      leading: const Icon(Icons.comment, size: 40, color: accentPink),
                      title: Text('Total Comments',
                          style: GoogleFonts.outfit(
                              fontWeight: FontWeight.bold,
                              color: Colors.white)),
                      trailing: Text('$commentCount',
                          style: GoogleFonts.outfit(
                              fontSize: 24,
                              fontWeight: FontWeight.bold,
                              color: accentPink)),
                    ),
                  );
                },
              ),
              const SizedBox(height: 8),
              StreamBuilder<QuerySnapshot>(
                stream: FirebaseFirestore.instance
                    .collectionGroup('votes')
                    .snapshots(),
                builder: (context, snap) {
                  final voteCount = snap.hasData ? snap.data!.docs.length : 0;

                  return Container(
                    decoration: BoxDecoration(
                      gradient: LinearGradient(
                        begin: Alignment.topLeft,
                        end: Alignment.bottomRight,
                        colors: [
                          electricPurple.withOpacity(0.1),
                          neonCyan.withOpacity(0.1),
                        ],
                      ),
                      borderRadius: BorderRadius.circular(16),
                      border: Border.all(
                        color: electricPurple.withOpacity(0.3),
                        width: 1.5,
                      ),
                      boxShadow: [
                        BoxShadow(
                          color: electricPurple.withOpacity(0.2),
                          blurRadius: 15,
                          offset: const Offset(0, 8),
                        ),
                      ],
                    ),
                    child: ListTile(
                      leading: const Icon(Icons.how_to_vote,
                          size: 40, color: electricPurple),
                      title: Text('Total Poll Votes',
                          style: GoogleFonts.outfit(
                              fontWeight: FontWeight.bold,
                              color: Colors.white)),
                      trailing: Text('$voteCount',
                          style: GoogleFonts.outfit(
                              fontSize: 24,
                              fontWeight: FontWeight.bold,
                              color: electricPurple)),
                    ),
                  );
                },
              ),
              const SizedBox(height: 24),
              Text('Recent Activity',
                  style: GoogleFonts.outfit(
                      fontSize: 20,
                      fontWeight: FontWeight.bold,
                      color: Colors.white)),
              const SizedBox(height: 16),
              StreamBuilder<QuerySnapshot>(
                stream: FirebaseFirestore.instance
                    .collection('notices')
                    .orderBy('time', descending: true)
                    .limit(5)
                    .snapshots(),
                builder: (context, snap) {
                  if (!snap.hasData) return const CircularProgressIndicator();

                  return Container(
                    decoration: BoxDecoration(
                      gradient: LinearGradient(
                        begin: Alignment.topLeft,
                        end: Alignment.bottomRight,
                        colors: [
                          neonCyan.withOpacity(0.1),
                          electricPurple.withOpacity(0.1),
                        ],
                      ),
                      borderRadius: BorderRadius.circular(16),
                      border: Border.all(
                        color: neonCyan.withOpacity(0.3),
                        width: 1.5,
                      ),
                      boxShadow: [
                        BoxShadow(
                          color: neonCyan.withOpacity(0.2),
                          blurRadius: 15,
                          offset: const Offset(0, 8),
                        ),
                      ],
                    ),
                    child: Column(
                      children: [
                        ListTile(
                          title: Text('Latest Notices',
                              style: GoogleFonts.outfit(
                                  fontWeight: FontWeight.bold,
                                  color: Colors.white)),
                        ),
                        ...snap.data!.docs.map((doc) {
                          final data = doc.data() as Map<String, dynamic>;
                          final text = data['text']?.toString() ?? '';
                          return ListTile(
                            dense: true,
                            title: Text(
                              text,
                              maxLines: 1,
                              overflow: TextOverflow.ellipsis,
                              style: GoogleFonts.outfit(
                                  color: Colors.white.withOpacity(0.9)),
                            ),
                            leading: Icon(
                              data['isPoll'] == true
                                  ? Icons.poll
                                  : Icons.article,
                              size: 20,
                              color: neonCyan,
                            ),
                          );
                        }),
                      ],
                    ),
                  );
                },
              ),
            ],
          ),
        ),
      ),
    );
  }
}

// -------------------- Exam Page --------------------
// Each exam type (Quiz/Assignment/Presentation, Mid, Final) is posted as a separate document.
// Admin can post multi-line text. Each document has 'type' and 'details' fields.
class ExamPage extends StatefulWidget {
  const ExamPage({super.key});
  @override
  State<ExamPage> createState() => _ExamPageState();
}

class _ExamPageState extends State<ExamPage> {
  final quizCtrl = TextEditingController();
  final midCtrl = TextEditingController();
  final finalCtrl = TextEditingController();
  final search = TextEditingController();
  bool isAdmin = false;
  String _searchQuery = '';
  String _typeFilter = 'All';
  DateTime? _quizDate;
  DateTime? _midDate;
  DateTime? _finalDate;
  bool _showAdminPanel = false;
  bool _showCalendarView = false;

  @override
  void initState() {
    super.initState();
    _initAdmin();
    search.addListener(() {
      setState(() => _searchQuery = search.text.toLowerCase());
    });
  }

  Future<void> _initAdmin() async {
    final admin = await isCurrentUserAdmin();
    if (mounted) setState(() => isAdmin = admin);
  }

  Future<void> postIndividualExam(
      String type, String text, DateTime? eventDate) async {
    final body = text.trim();
    if (body.isEmpty) return;
    try {
      await FirebaseFirestore.instance.collection('exams').add({
        'type': type,
        'details': body,
        'time': FieldValue.serverTimestamp(),
        'eventDate': eventDate != null ? Timestamp.fromDate(eventDate) : null,
        'createdBy': FirebaseAuth.instance.currentUser?.uid,
      });
      // Send brief notification (first line)
      await showNotification(
          'Event Update', '$type: ${body.split('\n').first}');

      // Schedule reminder if eventDate is provided and in future
      if (eventDate != null && eventDate.isAfter(DateTime.now())) {
        await _scheduleEventReminder(type, body, eventDate);
      }
    } catch (e) {
      Fluttertoast.showToast(msg: 'Failed to post $type: $e');
    }
  }

  Future<void> _scheduleEventReminder(
      String type, String details, DateTime eventDate) async {
    try {
      // Schedule notification 1 day before event at 9 AM
      final reminderTime = DateTime(
        eventDate.year,
        eventDate.month,
        eventDate.day - 1,
        9, // 9 AM
        0,
      );

      if (reminderTime.isAfter(DateTime.now())) {
        final scheduledDate = tz.TZDateTime.from(reminderTime, tz.local);
        await flutterLocalNotificationsPlugin.zonedSchedule(
          eventDate.millisecondsSinceEpoch ~/ 1000, // unique ID
          ' Event Reminder: $type',
          'Tomorrow: ${details.split('\n').first}',
          scheduledDate,
          const NotificationDetails(
            android: AndroidNotificationDetails(
              'infyners_channel',
              'Infyners Notifications',
              channelDescription: 'Notifications for Infyners app',
              importance: Importance.max,
              priority: Priority.high,
            ),
          ),
          androidScheduleMode: AndroidScheduleMode.exactAllowWhileIdle,
          matchDateTimeComponents: DateTimeComponents.time,
        );
      }
    } catch (e) {
      debugPrint('Failed to schedule reminder: $e');
    }
  }

  Future<void> postAll() async {
    if (quizCtrl.text.trim().isEmpty &&
        midCtrl.text.trim().isEmpty &&
        finalCtrl.text.trim().isEmpty) {
      Fluttertoast.showToast(msg: 'Please enter at least one field');
      return;
    }
    if (quizCtrl.text.trim().isNotEmpty) {
      await postIndividualExam(
          'Quiz / Assignment / Presentation', quizCtrl.text, _quizDate);
    }
    if (midCtrl.text.trim().isNotEmpty) {
      await postIndividualExam('Mid Exam', midCtrl.text, _midDate);
    }
    if (finalCtrl.text.trim().isNotEmpty) {
      await postIndividualExam('Final Exam', finalCtrl.text, _finalDate);
    }

    quizCtrl.clear();
    midCtrl.clear();
    finalCtrl.clear();
    setState(() {
      _quizDate = null;
      _midDate = null;
      _finalDate = null;
    });
    Fluttertoast.showToast(msg: 'Event info posted');
  }

  Future<void> _editExamDoc(DocumentSnapshot doc) async {
    final data = doc.data() as Map<String, dynamic>;
    final type = (data['type'] ?? '').toString();
    final details = (data['details'] ?? '').toString();
    final editCtrl = TextEditingController(text: details);

    await showDialog(
      context: context,
      builder: (_) => StatefulBuilder(builder: (context, setDialog) {
        return AlertDialog(
          title: Text('Edit: $type'),
          content: Column(mainAxisSize: MainAxisSize.min, children: [
            TextField(
                controller: editCtrl,
                maxLines: 8,
                decoration: const InputDecoration(
                    border: OutlineInputBorder(), labelText: 'Details')),
          ]),
          actions: [
            TextButton(
                onPressed: () => Navigator.pop(context),
                child: const Text('Cancel')),
            ElevatedButton(
              onPressed: () async {
                final newDetails = editCtrl.text.trim();
                await doc.reference.set({
                  'type': type,
                  'details': newDetails,
                  'time': FieldValue.serverTimestamp(),
                  'createdBy': FirebaseAuth.instance.currentUser?.uid,
                });
                Navigator.pop(context);
                Fluttertoast.showToast(msg: 'Updated');
              },
              style: ElevatedButton.styleFrom(
                  backgroundColor: Colors.indigo,
                  foregroundColor: Colors.white),
              child: const Text('Save'),
            ),
          ],
        );
      }),
    );
    editCtrl.dispose();
  }

  @override
  void dispose() {
    quizCtrl.dispose();
    midCtrl.dispose();
    finalCtrl.dispose();
    search.dispose();
    super.dispose();
  }

  @override
  Widget build(BuildContext context) {
    return Column(children: [
      // Search and filter bar
      Padding(
        padding: const EdgeInsets.all(12),
        child: Row(children: [
          Expanded(
            flex: 2,
            child: TextField(
              controller: search,
              decoration: InputDecoration(
                labelText: 'Search events',
                prefixIcon: const Icon(Icons.search),
                suffixIcon: _searchQuery.isNotEmpty
                    ? IconButton(
                        icon: const Icon(Icons.clear),
                        onPressed: () => search.clear(),
                      )
                    : null,
                border: const OutlineInputBorder(),
              ),
            ),
          ),
          const SizedBox(width: 8),
          Expanded(
            child: DropdownButtonFormField<String>(
              initialValue: _typeFilter,
              decoration: const InputDecoration(
                labelText: 'Type',
                border: OutlineInputBorder(),
              ),
              items: [
                'All',
                'Quiz / Assignment / Presentation',
                'Mid Exam',
                'Final Exam'
              ]
                  .map((t) => DropdownMenuItem(
                      value: t,
                      child: Text(t, style: const TextStyle(fontSize: 12))))
                  .toList(),
              onChanged: (v) => setState(() => _typeFilter = v ?? 'All'),
            ),
          ),
          const SizedBox(width: 8),
          IconButton(
            icon: Icon(
              _showCalendarView ? Icons.list : Icons.calendar_month,
              color: neonCyan,
              size: 24,
            ),
            tooltip: _showCalendarView ? 'List View' : 'Calendar View',
            onPressed: () =>
                setState(() => _showCalendarView = !_showCalendarView),
          ),
        ]),
      ),
      if (isAdmin)
        Padding(
          padding: const EdgeInsets.symmetric(horizontal: 12, vertical: 8),
          child: ElevatedButton.icon(
            onPressed: () => setState(() => _showAdminPanel = !_showAdminPanel),
            icon: Icon(
              _showAdminPanel ? Icons.expand_less : Icons.expand_more,
              color: Colors.white,
            ),
            label: Text(
              _showAdminPanel ? 'Hide Post Panel' : 'Post Event',
              style: GoogleFonts.outfit(
                fontWeight: FontWeight.bold,
                color: Colors.white,
              ),
            ),
            style: ElevatedButton.styleFrom(
              backgroundColor: electricPurple,
              foregroundColor: Colors.white,
              minimumSize: const Size(double.infinity, 40),
            ),
          ),
        ),
      if (isAdmin && _showAdminPanel)
        Container(
          constraints: const BoxConstraints(maxHeight: 400),
          padding: const EdgeInsets.symmetric(horizontal: 12),
          child: SingleChildScrollView(
            child: Column(children: [
              // Quiz / Assignment / Presentation (multi-line)
              TextField(
                controller: quizCtrl,
                maxLines: 4,
                textInputAction: TextInputAction.newline,
                style: GoogleFonts.outfit(
                  color: Colors.grey.shade900,
                  fontSize: 14,
                  fontWeight: FontWeight.w500,
                ),
                decoration: InputDecoration(
                  filled: true,
                  fillColor: Colors.white,
                  labelText: 'Quiz / Assignment / Presentation',
                  labelStyle: GoogleFonts.outfit(
                    color: Colors.grey.shade700,
                  ),
                  hintText: 'Enter quiz/assignment details',
                  hintStyle: GoogleFonts.outfit(
                    color: Colors.grey.shade600,
                  ),
                  border: OutlineInputBorder(
                    borderSide: BorderSide(
                      color: neonCyan.withOpacity(0.3),
                    ),
                  ),
                  enabledBorder: OutlineInputBorder(
                    borderSide: BorderSide(
                      color: neonCyan.withOpacity(0.3),
                    ),
                  ),
                  focusedBorder: const OutlineInputBorder(
                    borderSide: BorderSide(
                      color: neonCyan,
                      width: 2,
                    ),
                  ),
                  alignLabelWithHint: true,
                ),
              ),
              const SizedBox(height: 4),
              Row(children: [
                Text(
                  'Event Date: ',
                  style: GoogleFonts.outfit(
                    fontSize: 12,
                    color: Colors.white.withOpacity(0.8),
                    fontWeight: FontWeight.bold,
                  ),
                ),
                Expanded(
                  child: TextButton.icon(
                    icon: const Icon(Icons.calendar_today, size: 16),
                    label: Text(
                      _quizDate == null
                          ? 'Set Date'
                          : '${_quizDate!.day}/${_quizDate!.month}/${_quizDate!.year}',
                      style: GoogleFonts.outfit(
                        fontSize: 12,
                        color: neonCyan,
                      ),
                      overflow: TextOverflow.ellipsis,
                    ),
                    onPressed: () async {
                      final date = await showDatePicker(
                        context: context,
                        initialDate: _quizDate ??
                            DateTime.now().add(const Duration(days: 1)),
                        firstDate: DateTime.now(),
                        lastDate: DateTime.now().add(const Duration(days: 365)),
                      );
                      if (date != null) setState(() => _quizDate = date);
                    },
                  ),
                ),
                if (_quizDate != null)
                  IconButton(
                    icon: const Icon(Icons.clear, size: 16),
                    iconSize: 16,
                    color: accentPink,
                    padding: EdgeInsets.zero,
                    constraints: const BoxConstraints(),
                    onPressed: () => setState(() => _quizDate = null),
                  ),
              ]),

              const SizedBox(height: 10),

              // Mid Exam
              TextField(
                controller: midCtrl,
                maxLines: 3,
                style: GoogleFonts.outfit(
                  color: Colors.grey.shade900,
                  fontSize: 14,
                  fontWeight: FontWeight.w500,
                ),
                decoration: InputDecoration(
                  filled: true,
                  fillColor: Colors.white,
                  labelText: 'Mid Exam',
                  labelStyle: GoogleFonts.outfit(
                    color: Colors.grey.shade700,
                  ),
                  hintText: 'Enter mid-term details',
                  hintStyle: GoogleFonts.outfit(
                    color: Colors.grey.shade600,
                  ),
                  border: OutlineInputBorder(
                    borderSide: BorderSide(
                      color: neonCyan.withOpacity(0.3),
                    ),
                  ),
                  enabledBorder: OutlineInputBorder(
                    borderSide: BorderSide(
                      color: neonCyan.withOpacity(0.3),
                    ),
                  ),
                  focusedBorder: const OutlineInputBorder(
                    borderSide: BorderSide(
                      color: neonCyan,
                      width: 2,
                    ),
                  ),
                ),
              ),
              const SizedBox(height: 4),
              Row(children: [
                Text(
                  'Event Date: ',
                  style: GoogleFonts.outfit(
                    fontSize: 12,
                    color: Colors.white.withOpacity(0.8),
                    fontWeight: FontWeight.bold,
                  ),
                ),
                Expanded(
                  child: TextButton.icon(
                    icon: const Icon(Icons.calendar_today, size: 16),
                    label: Text(
                      _midDate == null
                          ? 'Set Date'
                          : '${_midDate!.day}/${_midDate!.month}/${_midDate!.year}',
                      style: GoogleFonts.outfit(
                        fontSize: 12,
                        color: neonCyan,
                      ),
                      overflow: TextOverflow.ellipsis,
                    ),
                    onPressed: () async {
                      final date = await showDatePicker(
                        context: context,
                        initialDate: _midDate ??
                            DateTime.now().add(const Duration(days: 1)),
                        firstDate: DateTime.now(),
                        lastDate: DateTime.now().add(const Duration(days: 365)),
                      );
                      if (date != null) setState(() => _midDate = date);
                    },
                  ),
                ),
                if (_midDate != null)
                  IconButton(
                    icon: const Icon(Icons.clear, size: 16),
                    iconSize: 16,
                    color: accentPink,
                    padding: EdgeInsets.zero,
                    constraints: const BoxConstraints(),
                    onPressed: () => setState(() => _midDate = null),
                  ),
              ]),

              const SizedBox(height: 10),

              // Final Exam
              TextField(
                controller: finalCtrl,
                maxLines: 3,
                style: GoogleFonts.outfit(
                  color: Colors.grey.shade900,
                  fontSize: 14,
                  fontWeight: FontWeight.w500,
                ),
                decoration: InputDecoration(
                  filled: true,
                  fillColor: Colors.white,
                  labelText: 'Final Exam',
                  labelStyle: GoogleFonts.outfit(
                    color: Colors.grey.shade700,
                  ),
                  hintText: 'Enter final exam details',
                  hintStyle: GoogleFonts.outfit(
                    color: Colors.grey.shade600,
                  ),
                  border: OutlineInputBorder(
                    borderSide: BorderSide(
                      color: neonCyan.withOpacity(0.3),
                    ),
                  ),
                  enabledBorder: OutlineInputBorder(
                    borderSide: BorderSide(
                      color: neonCyan.withOpacity(0.3),
                    ),
                  ),
                  focusedBorder: const OutlineInputBorder(
                    borderSide: BorderSide(
                      color: neonCyan,
                      width: 2,
                    ),
                  ),
                ),
              ),
              const SizedBox(height: 4),
              Row(children: [
                Text(
                  'Event Date: ',
                  style: GoogleFonts.outfit(
                    fontSize: 12,
                    color: Colors.white.withOpacity(0.8),
                    fontWeight: FontWeight.bold,
                  ),
                ),
                Expanded(
                  child: TextButton.icon(
                    icon: const Icon(Icons.calendar_today, size: 16),
                    label: Text(
                      _finalDate == null
                          ? 'Set Date'
                          : '${_finalDate!.day}/${_finalDate!.month}/${_finalDate!.year}',
                      style: GoogleFonts.outfit(
                        fontSize: 12,
                        color: neonCyan,
                      ),
                      overflow: TextOverflow.ellipsis,
                    ),
                    onPressed: () async {
                      final date = await showDatePicker(
                        context: context,
                        initialDate: _finalDate ??
                            DateTime.now().add(const Duration(days: 1)),
                        firstDate: DateTime.now(),
                        lastDate: DateTime.now().add(const Duration(days: 365)),
                      );
                      if (date != null) setState(() => _finalDate = date);
                    },
                  ),
                ),
                if (_finalDate != null)
                  IconButton(
                    icon: const Icon(Icons.clear, size: 16),
                    iconSize: 16,
                    color: accentPink,
                    padding: EdgeInsets.zero,
                    constraints: const BoxConstraints(),
                    onPressed: () => setState(() => _finalDate = null),
                  ),
              ]),

              const SizedBox(height: 10),
              SizedBox(
                width: double.infinity,
                child: ElevatedButton(
                  onPressed: postAll,
                  style: ElevatedButton.styleFrom(
                    backgroundColor: electricPurple,
                    foregroundColor: Colors.white,
                  ),
                  child: Text(
                    'Post Exam Info (separate entries)',
                    style: GoogleFonts.outfit(
                      fontWeight: FontWeight.bold,
                      color: Colors.white,
                    ),
                  ),
                ),
              ),
            ]),
          ),
        ),
      Expanded(
        child: _showCalendarView ? _buildCalendarView() : _buildListView(),
      ),
    ]);
  }

  Widget _buildCalendarView() {
    return StreamBuilder<QuerySnapshot>(
      stream: FirebaseFirestore.instance.collection('exams').snapshots(),
      builder: (context, snap) {
        if (!snap.hasData) {
          return const Center(child: CircularProgressIndicator());
        }

        final events = snap.data!.docs.where((doc) {
          final data = doc.data() as Map<String, dynamic>;
          return data['eventDate'] != null;
        }).toList();

        if (events.isEmpty) {
          return Center(
            child: Text(
              'No events with dates',
              style: GoogleFonts.outfit(
                fontSize: 16,
                color: Colors.white.withOpacity(0.7),
              ),
            ),
          );
        }

        // Group by month
        final grouped = <String, List<DocumentSnapshot>>{};
        for (var doc in events) {
          final data = doc.data() as Map<String, dynamic>;
          final eventDate = (data['eventDate'] as Timestamp).toDate();
          final key =
              '${eventDate.year}-${eventDate.month.toString().padLeft(2, '0')}';
          grouped.putIfAbsent(key, () => []).add(doc);
        }

        final sortedKeys = grouped.keys.toList()..sort();

        return ListView.builder(
          itemCount: sortedKeys.length,
          itemBuilder: (context, i) {
            final key = sortedKeys[i];
            final monthEvents = grouped[key]!;
            final firstDate = (monthEvents.first.data()
                as Map<String, dynamic>)['eventDate'] as Timestamp;
            final date = firstDate.toDate();
            final monthName = [
              '',
              'January',
              'February',
              'March',
              'April',
              'May',
              'June',
              'July',
              'August',
              'September',
              'October',
              'November',
              'December'
            ][date.month];

            return Column(
              crossAxisAlignment: CrossAxisAlignment.start,
              children: [
                Padding(
                  padding: const EdgeInsets.all(12),
                  child: Text(
                    '$monthName ${date.year}',
                    style: GoogleFonts.outfit(
                      fontSize: 18,
                      fontWeight: FontWeight.bold,
                      color: Colors.white,
                    ),
                  ),
                ),
                ...monthEvents.map((doc) {
                  final data = doc.data() as Map<String, dynamic>;
                  final type = data['type']?.toString() ?? 'Event';
                  final details = data['details']?.toString() ?? '';
                  final eventDate = (data['eventDate'] as Timestamp).toDate();

                  return Container(
                    margin:
                        const EdgeInsets.symmetric(horizontal: 12, vertical: 4),
                    decoration: BoxDecoration(
                      color: darkCard,
                      borderRadius: BorderRadius.circular(12),
                      border: Border.all(
                        color: neonCyan.withOpacity(0.3),
                        width: 1.5,
                      ),
                      gradient: LinearGradient(
                        begin: Alignment.topLeft,
                        end: Alignment.bottomRight,
                        colors: [
                          Colors.white.withOpacity(0.05),
                          Colors.white.withOpacity(0.02),
                        ],
                      ),
                      boxShadow: [
                        BoxShadow(
                          color: neonCyan.withOpacity(0.15),
                          blurRadius: 15,
                          offset: const Offset(0, 8),
                        ),
                      ],
                    ),
                    child: ListTile(
                      leading: Container(
                        width: 50,
                        height: 50,
                        decoration: BoxDecoration(
                          color: electricPurple.withOpacity(0.2),
                          borderRadius: BorderRadius.circular(8),
                          border: Border.all(
                            color: neonCyan.withOpacity(0.3),
                            width: 1,
                          ),
                        ),
                        child: Column(
                          mainAxisAlignment: MainAxisAlignment.center,
                          children: [
                            Text(
                              eventDate.day.toString(),
                              style: GoogleFonts.outfit(
                                fontSize: 16,
                                fontWeight: FontWeight.bold,
                                color: Colors.white,
                              ),
                            ),
                            Text(
                              [
                                '',
                                'Jan',
                                'Feb',
                                'Mar',
                                'Apr',
                                'May',
                                'Jun',
                                'Jul',
                                'Aug',
                                'Sep',
                                'Oct',
                                'Nov',
                                'Dec'
                              ][eventDate.month],
                              style: GoogleFonts.outfit(
                                fontSize: 9,
                                color: Colors.white.withOpacity(0.7),
                              ),
                            ),
                          ],
                        ),
                      ),
                      title: Text(
                        type,
                        style: GoogleFonts.outfit(
                          fontWeight: FontWeight.bold,
                          fontSize: 15,
                          color: neonCyan,
                        ),
                      ),
                      subtitle: Text(
                        details,
                        maxLines: 2,
                        overflow: TextOverflow.ellipsis,
                        style: GoogleFonts.outfit(
                          fontSize: 13,
                          color: Colors.white.withOpacity(0.8),
                        ),
                      ),
                    ),
                  );
                }),
              ],
            );
          },
        );
      },
    );
  }

  Widget _buildListView() {
    return StreamBuilder<QuerySnapshot>(
      stream: FirebaseFirestore.instance
          .collection('exams')
          .orderBy('time', descending: true)
          .snapshots(),
      builder: (context, snap) {
        if (!snap.hasData) {
          return const Center(child: CircularProgressIndicator());
        }
        final docs = snap.data!.docs;
        if (docs.isEmpty) {
          return Center(
            child: Text(
              'No exam info yet',
              style: GoogleFonts.outfit(
                fontSize: 18,
                color: Colors.white.withOpacity(0.7),
              ),
            ),
          );
        }

        // Filter by search query and type
        final filtered = docs.where((doc) {
          final data = doc.data() as Map<String, dynamic>;
          final type = (data['type'] ?? '').toString().toLowerCase();
          final details = (data['details'] ?? '').toString().toLowerCase();

          // Type filter
          if (_typeFilter != 'All' && data['type'] != _typeFilter) {
            return false;
          }

          // Search filter
          if (_searchQuery.isNotEmpty) {
            return type.contains(_searchQuery) ||
                details.contains(_searchQuery);
          }

          return true;
        }).toList();

        if (filtered.isEmpty) {
          return Center(
            child: Text(
              'No events match your filters',
              style: GoogleFonts.outfit(
                fontSize: 16,
                color: Colors.white.withOpacity(0.7),
              ),
            ),
          );
        }

        return ListView.builder(
          itemCount: filtered.length,
          itemBuilder: (context, i) {
            final doc = filtered[i];
            final data = doc.data() as Map<String, dynamic>;
            final type = (data['type'] ?? 'Exam').toString();
            final details = (data['details'] ?? '').toString();
            final eventDate = data['eventDate'] as Timestamp?;
            final dateStr = eventDate != null
                ? ' ${eventDate.toDate().day}/${eventDate.toDate().month}/${eventDate.toDate().year}'
                : '';
            return Container(
              margin: const EdgeInsets.symmetric(horizontal: 12, vertical: 6),
              decoration: BoxDecoration(
                color: darkCard,
                borderRadius: BorderRadius.circular(12),
                border: Border.all(
                  color: neonCyan.withOpacity(0.3),
                  width: 1.5,
                ),
                gradient: LinearGradient(
                  begin: Alignment.topLeft,
                  end: Alignment.bottomRight,
                  colors: [
                    Colors.white.withOpacity(0.05),
                    Colors.white.withOpacity(0.02),
                  ],
                ),
                boxShadow: [
                  BoxShadow(
                    color: neonCyan.withOpacity(0.15),
                    blurRadius: 15,
                    offset: const Offset(0, 8),
                  ),
                ],
              ),
              child: ListTile(
                title: Text(
                  type,
                  style: GoogleFonts.outfit(
                    fontWeight: FontWeight.bold,
                    fontSize: 15,
                    color: neonCyan,
                  ),
                ),
                subtitle: Column(
                  crossAxisAlignment: CrossAxisAlignment.start,
                  children: [
                    if (dateStr.isNotEmpty)
                      Text(
                        dateStr,
                        style: GoogleFonts.outfit(
                          fontSize: 12,
                          color: accentGreen,
                        ),
                      ),
                    Text(
                      details,
                      style: GoogleFonts.outfit(
                        fontSize: 13,
                        color: Colors.white.withOpacity(0.8),
                        height: 1.4,
                      ),
                    ),
                  ],
                ),
                trailing: isAdmin
                    ? Row(mainAxisSize: MainAxisSize.min, children: [
                        IconButton(
                          icon: const Icon(Icons.edit),
                          iconSize: 20,
                          color: neonCyan,
                          onPressed: () => _editExamDoc(doc),
                        ),
                        IconButton(
                          icon: const Icon(Icons.delete),
                          iconSize: 20,
                          color: accentPink,
                          onPressed: () async {
                            await doc.reference.delete();
                            Fluttertoast.showToast(msg: 'Deleted');
                          },
                        ),
                      ])
                    : null,
              ),
            );
          },
        );
      },
    );
  }
}

// -------------------- Routine Page --------------------
// Routine stored as document per day: /routines/{day} { data: [ {course,teacher,room}, ... ] }
class RoutinePage extends StatefulWidget {
  const RoutinePage({super.key});
  @override
  State<RoutinePage> createState() => _RoutinePageState();
}

class _RoutinePageState extends State<RoutinePage> {
  String selectedDay = 'Sunday';
  bool isAdmin = false;

  final List<String> defaultTimes = const [
    '8:20 - 9:50',
    '9:50 - 11:20',
    '11:20 - 12:50',
    '1:10 - 2:40',
    '2:40 - 4:10',
  ];

  List<String> times = [];

  Map<String, List<Map<String, String>>> routineData = {};

  @override
  void initState() {
    super.initState();
    times = List.from(defaultTimes);
    _init();
  }

  Future<void> _init() async {
    final admin = await isCurrentUserAdmin();
    setState(() => isAdmin = admin);
    await loadRoutine();
  }

  Future<void> loadRoutine() async {
    final snap = await FirebaseFirestore.instance
        .collection('routines')
        .doc(selectedDay)
        .get();
    List<Map<String, String>> slots;
    List<String> storedTimes = List.from(defaultTimes);

    if (snap.exists) {
      final data = snap.data() as Map<String, dynamic>;
      final raw = data['data'] as List<dynamic>? ?? [];
      slots = raw.map((e) => Map<String, String>.from(e as Map)).toList();

      final fetchedTimes = (data['times'] as List?)
              ?.map((e) => e.toString())
              .toList() ??
          [];
      if (fetchedTimes.isNotEmpty) {
        storedTimes = fetchedTimes;
      }
    } else {
      slots = List.generate(
          defaultTimes.length, (_) => {'course': '', 'teacher': '', 'room': ''});
    }

    final targetLength = storedTimes.length;
    if (slots.length < targetLength) {
      slots.addAll(List.generate(
          targetLength - slots.length,
          (_) => {'course': '', 'teacher': '', 'room': ''}));
    } else if (slots.length > targetLength) {
      for (var i = storedTimes.length; i < slots.length; i++) {
        storedTimes.add('Slot ${i + 1}');
      }
    }

    setState(() {
      times = storedTimes;
      routineData[selectedDay] = slots;
    });
  }

  Future<void> saveRoutine() async {
    final currentSlots = routineData[selectedDay] ??
        List.generate(
            times.length, (_) => {'course': '', 'teacher': '', 'room': ''});

    // Keep slot count aligned with time slots
    if (currentSlots.length < times.length) {
      currentSlots.addAll(List.generate(
          times.length - currentSlots.length,
          (_) => {'course': '', 'teacher': '', 'room': ''}));
    } else if (currentSlots.length > times.length) {
      for (var i = times.length; i < currentSlots.length; i++) {
        times.add('Slot ${i + 1}');
      }
    }

    await FirebaseFirestore.instance
        .collection('routines')
        .doc(selectedDay)
        .set({
      'data': currentSlots,
      'times': times,
      'updatedAt': FieldValue.serverTimestamp(),
    });
    Fluttertoast.showToast(msg: 'Routine updated for $selectedDay');
  }

  void _editSlot(int index) {
    final slot = routineData[selectedDay]![index];
    final courseCtrl = TextEditingController(text: slot['course']);
    final teacherCtrl = TextEditingController(text: slot['teacher']);
    final roomCtrl = TextEditingController(text: slot['room']);
    final timeCtrl = TextEditingController(
      text: index < times.length ? times[index] : '',
    );

    showDialog(
      context: context,
      builder: (_) => StatefulBuilder(builder: (context, setDialog) {
        return AlertDialog(
          title: Text('Edit ${times[index]}'),
          content: Column(mainAxisSize: MainAxisSize.min, children: [
            TextField(
                controller: courseCtrl,
                decoration: const InputDecoration(labelText: 'Course Code')),
            TextField(
                controller: teacherCtrl,
                decoration:
                    const InputDecoration(labelText: 'Teacher Initial')),
            TextField(
                controller: roomCtrl,
                decoration: const InputDecoration(labelText: 'Room')),
            const SizedBox(height: 12),
            TextField(
              controller: timeCtrl,
              decoration: const InputDecoration(labelText: 'Time Slot'),
            ),
          ]),
          actions: [
            TextButton(
                onPressed: () => Navigator.pop(context),
                child: const Text('Cancel')),
            ElevatedButton(
              onPressed: () async {
                final newTime = timeCtrl.text.trim();
                if (newTime.isNotEmpty) {
                  if (index < times.length) {
                    times[index] = newTime;
                  } else {
                    times.add(newTime);
                  }
                }

                routineData[selectedDay]![index] = {
                  'course': courseCtrl.text.trim(),
                  'teacher': teacherCtrl.text.trim(),
                  'room': roomCtrl.text.trim(),
                };
                await saveRoutine(); // auto-save immediately
                setState(() {});
                Navigator.pop(context);
              },
              style: ElevatedButton.styleFrom(
                  backgroundColor: Colors.indigo,
                  foregroundColor: Colors.white),
              child: const Text('Save'),
            ),
          ],
        );
      }),
    );
  }

  @override
  Widget build(BuildContext context) {
    final daySlots = routineData[selectedDay] ??
      List.generate(
        times.length, (_) => {'course': '', 'teacher': '', 'room': ''});
    return Padding(
      padding: const EdgeInsets.all(12),
      child: Column(children: [
        Container(
          padding: const EdgeInsets.all(16),
          decoration: BoxDecoration(
            gradient: LinearGradient(
              colors: [
                neonCyan.withOpacity(0.1),
                electricPurple.withOpacity(0.1),
              ],
            ),
            borderRadius: BorderRadius.circular(16),
            border: Border.all(
              color: neonCyan.withOpacity(0.3),
              width: 1.5,
            ),
          ),
          child: Row(children: [
            Text('Day:',
                style: GoogleFonts.outfit(
                  fontWeight: FontWeight.bold,
                  color: Colors.white,
                  fontSize: 16,
                )),
            const SizedBox(width: 8),
            Expanded(
              child: DropdownButton<String>(
                value: selectedDay,
                isExpanded: true,
                dropdownColor: darkCard,
                style: GoogleFonts.outfit(
                  color: Colors.white,
                  fontSize: 16,
                  fontWeight: FontWeight.w500,
                ),
                items: const [
                  'Sunday',
                  'Monday',
                  'Tuesday',
                  'Wednesday',
                  'Thursday',
                  'Friday',
                  'Saturday'
                ]
                    .map((d) => DropdownMenuItem(value: d, child: Text(d)))
                    .toList(),
                onChanged: (v) async {
                  if (v == null) return;
                  setState(() => selectedDay = v);
                  await loadRoutine();
                },
              ),
            ),
            const SizedBox(width: 8),
            if (isAdmin)
              Container(
                decoration: BoxDecoration(
                  gradient: const LinearGradient(
                    colors: [neonCyan, electricPurple],
                  ),
                  borderRadius: BorderRadius.circular(8),
                ),
                child: ElevatedButton(
                  onPressed: saveRoutine,
                  style: ElevatedButton.styleFrom(
                    backgroundColor: Colors.transparent,
                    foregroundColor: Colors.white,
                    shadowColor: Colors.transparent,
                  ),
                  child: Text('Save',
                      style: GoogleFonts.outfit(
                        fontWeight: FontWeight.bold,
                        fontSize: 14,
                      )),
                ),
              ),
          ]),
        ),
        const SizedBox(height: 10),
        Expanded(
          child: ListView.builder(
            itemCount: times.length,
            itemBuilder: (context, i) {
              final slot = daySlots[i];
              return Container(
                margin: const EdgeInsets.symmetric(vertical: 6),
                decoration: BoxDecoration(
                  gradient: LinearGradient(
                    colors: [
                      neonCyan.withOpacity(0.1),
                      electricPurple.withOpacity(0.1),
                    ],
                  ),
                  borderRadius: BorderRadius.circular(12),
                  border: Border.all(
                    color: neonCyan.withOpacity(0.3),
                    width: 1.5,
                  ),
                ),
                child: ListTile(
                  title: Text(times[i],
                      style: GoogleFonts.outfit(
                        fontWeight: FontWeight.bold,
                        color: Colors.white,
                        fontSize: 16,
                      )),
                  subtitle: Text(
                      'Course: ${slot['course']}\nTeacher: ${slot['teacher']}\nRoom: ${slot['room']}',
                      style: GoogleFonts.outfit(
                        color: Colors.white.withOpacity(0.8),
                        fontSize: 13,
                      )),
                  trailing: isAdmin
                      ? IconButton(
                          icon: const Icon(Icons.edit, color: neonCyan),
                          onPressed: () => _editSlot(i))
                      : null,
                ),
              );
            },
          ),
        ),
      ]),
    );
  }
}

// -------------------- Members Page (Admin Only) --------------------
class MembersPage extends StatefulWidget {
  const MembersPage({super.key});
  @override
  State<MembersPage> createState() => _MembersPageState();
}

class _MembersPageState extends State<MembersPage> {
  final List<String> _selectedFields = [
    'name',
    'registrationId',
    'department',
    'bloodGroup',
    'mobile',
    'email'
  ];

  Future<void> _deleteUser(String userId, String userName) async {
    // Directly call deactivate (no dialog needed here, confirmation happens in _deactivateUser)
    await _deactivateUser(userId, userName);
  }

  Future<void> _deactivateUser(String userId, String userName) async {
    // Confirm deactivation
    final confirm = await showDialog<bool>(
      context: context,
      builder: (context) => AlertDialog(
        title: const Text('Deactivate User'),
        content: Text(
          'Are you sure you want to deactivate "$userName"?\n\n'
          'The user will not be able to login or access the app.\n'
          'You can reactivate them later.',
        ),
        actions: [
          TextButton(
            onPressed: () => Navigator.pop(context, false),
            child: const Text('Cancel'),
          ),
          ElevatedButton(
            onPressed: () => Navigator.pop(context, true),
            style: ElevatedButton.styleFrom(backgroundColor: Colors.orange),
            child: const Text('Deactivate'),
          ),
        ],
      ),
    );

    if (confirm != true) return;

    try {
      await FirebaseFirestore.instance.collection('users').doc(userId).update({
        'isActive': false,
        'deactivatedAt': FieldValue.serverTimestamp(),
        'deactivatedBy': FirebaseAuth.instance.currentUser?.uid,
      });

      Fluttertoast.showToast(
        msg: 'User "$userName" has been deactivated',
        toastLength: Toast.LENGTH_LONG,
      );
    } catch (e) {
      Fluttertoast.showToast(
        msg: 'Failed to deactivate user: $e',
        toastLength: Toast.LENGTH_LONG,
      );
    }
  }

  Future<void> _exportAllMembersPDF(List<QueryDocumentSnapshot> members) async {
    try {
      final pdf = pw.Document();

      // Counts & aggregations
      int activeCount = 0;
      final deptCount = <String, int>{};
      for (final doc in members) {
        final data = doc.data() as Map<String, dynamic>;
        final isActive = data['isActive'] != false;
        if (isActive) activeCount++;
        final dept = (data['department']?.toString() ?? '').trim();
        if (dept.isNotEmpty) {
          deptCount.update(dept, (v) => v + 1, ifAbsent: () => 1);
        }
      }
      final inactiveCount = members.length - activeCount;

      // Selected field headers
      final headers = <String>[];
      final fieldOrder = [
        'name',
        'registrationId',
        'department',
        'bloodGroup',
        'mobile',
        'email',
      ];
      final fieldLabels = {
        'name': 'Name',
        'registrationId': 'Reg ID',
        'department': 'Department',
        'bloodGroup': 'Blood',
        'mobile': 'Mobile',
        'email': 'Email',
      };
      for (final f in fieldOrder) {
        if (_selectedFields.contains(f)) headers.add(fieldLabels[f]!);
      }

      // Row data
      final rows = <List<String>>[];
      for (final doc in members) {
        final data = doc.data() as Map<String, dynamic>;
        final row = <String>[];
        if (_selectedFields.contains('name')) {
          row.add(data['name']?.toString() ?? '-');
        }
        if (_selectedFields.contains('registrationId')) {
          row.add(data['registrationId']?.toString() ?? '-');
        }
        if (_selectedFields.contains('department')) {
          row.add(data['department']?.toString() ?? '-');
        }
        if (_selectedFields.contains('bloodGroup')) {
          row.add(data['bloodGroup']?.toString() ?? '-');
        }
        if (_selectedFields.contains('mobile')) {
          row.add(data['mobile']?.toString() ?? '-');
        }
        if (_selectedFields.contains('email')) {
          row.add(data['email']?.toString() ?? '-');
        }
        rows.add(row);
      }

      // Build department distribution table
      final deptRows = deptCount.entries
          .map((e) => [
                e.key,
                e.value.toString(),
                '${((e.value / members.length) * 100).toStringAsFixed(1)}%'
              ])
          .toList()
        ..sort((a, b) => b[1].compareTo(a[1]));

      pdf.addPage(
        pw.MultiPage(
          pageFormat: PdfPageFormat.a4,
          margin: const pw.EdgeInsets.symmetric(horizontal: 28, vertical: 32),
          header: (context) => pw.Container(
            padding: const pw.EdgeInsets.only(bottom: 12),
            child: pw.Row(
              mainAxisAlignment: pw.MainAxisAlignment.spaceBetween,
              crossAxisAlignment: pw.CrossAxisAlignment.end,
              children: [
                pw.Column(
                  crossAxisAlignment: pw.CrossAxisAlignment.start,
                  children: [
                    pw.Text('INFYNERS',
                        style: pw.TextStyle(
                            fontSize: 22,
                            fontWeight: pw.FontWeight.bold,
                            color: PdfColors.indigo)),
                    pw.Text('Members Directory',
                        style: const pw.TextStyle(
                            fontSize: 12, color: PdfColors.grey700)),
                  ],
                ),
                pw.Text('Generated: ${DateTime.now().toString().split('.')[0]}',
                    style: const pw.TextStyle(
                        fontSize: 8, color: PdfColors.grey600))
              ],
            ),
          ),
          footer: (context) => pw.Container(
            alignment: pw.Alignment.center,
            margin: const pw.EdgeInsets.only(top: 12),
            child: pw.Text(
                'Page ${context.pageNumber} of ${context.pagesCount}',
                style:
                    const pw.TextStyle(fontSize: 8, color: PdfColors.grey600)),
          ),
          build: (context) => [
            // Summary Section
            pw.Container(
              decoration: pw.BoxDecoration(
                border: pw.Border.all(color: PdfColors.indigo, width: 0.8),
                borderRadius: const pw.BorderRadius.all(pw.Radius.circular(8)),
                color: PdfColors.indigo50,
              ),
              padding: const pw.EdgeInsets.all(16),
              child: pw.Column(
                crossAxisAlignment: pw.CrossAxisAlignment.start,
                children: [
                  pw.Text('Summary',
                      style: pw.TextStyle(
                          fontSize: 14,
                          fontWeight: pw.FontWeight.bold,
                          color: PdfColors.indigo)),
                  pw.SizedBox(height: 8),
                  pw.Wrap(
                    spacing: 12,
                    runSpacing: 8,
                    children: [
                      _pdfStatChip('Total', members.length.toString(),
                          PdfColors.blue700),
                      _pdfStatChip(
                          'Active', activeCount.toString(), PdfColors.green700),
                      _pdfStatChip('Inactive', inactiveCount.toString(),
                          PdfColors.red700),
                      _pdfStatChip(
                          'Fields',
                          headers.isEmpty
                              ? 'None selected'
                              : headers.join(', '),
                          PdfColors.indigo700),
                    ],
                  ),
                ],
              ),
            ),
            pw.SizedBox(height: 18),
            // Department Distribution
            if (deptRows.isNotEmpty)
              pw.Column(children: [
                pw.Text('Department Distribution',
                    style: pw.TextStyle(
                        fontSize: 12, fontWeight: pw.FontWeight.bold)),
                pw.SizedBox(height: 6),
                pw.TableHelper.fromTextArray(
                  headers: ['Department', 'Count', 'Percent'],
                  data: deptRows,
                  headerStyle: pw.TextStyle(
                      fontSize: 10,
                      fontWeight: pw.FontWeight.bold,
                      color: PdfColors.white),
                  headerDecoration:
                      const pw.BoxDecoration(color: PdfColors.indigo),
                  cellStyle: const pw.TextStyle(fontSize: 9),
                  cellAlignment: pw.Alignment.centerLeft,
                  cellPadding:
                      const pw.EdgeInsets.symmetric(horizontal: 6, vertical: 4),
                  oddRowDecoration:
                      const pw.BoxDecoration(color: PdfColors.grey200),
                ),
                pw.SizedBox(height: 18),
              ]),
            // Members Table
            pw.Text('Members',
                style:
                    pw.TextStyle(fontSize: 12, fontWeight: pw.FontWeight.bold)),
            pw.SizedBox(height: 6),
            if (headers.isEmpty)
              pw.Text(
                  'No fields selected. Please select at least one field before exporting.',
                  style: const pw.TextStyle(color: PdfColors.red, fontSize: 10))
            else
              pw.TableHelper.fromTextArray(
                headers: headers,
                data: rows,
                headerStyle: pw.TextStyle(
                    fontSize: 10,
                    fontWeight: pw.FontWeight.bold,
                    color: PdfColors.white),
                headerDecoration:
                    const pw.BoxDecoration(color: PdfColors.indigo),
                headerPadding: const pw.EdgeInsets.all(8),
                cellStyle: const pw.TextStyle(fontSize: 9),
                cellAlignment: pw.Alignment.centerLeft,
                cellPadding:
                    const pw.EdgeInsets.symmetric(horizontal: 6, vertical: 4),
                border:
                    pw.TableBorder.all(color: PdfColors.grey300, width: 0.3),
                oddRowDecoration:
                    const pw.BoxDecoration(color: PdfColors.grey100),
              ),
            pw.SizedBox(height: 12),
            pw.Text(
                'Confidential  Internal directory. Do not distribute externally.',
                style:
                    const pw.TextStyle(fontSize: 8, color: PdfColors.grey600)),
          ],
        ),
      );

      await Printing.layoutPdf(onLayout: (format) => pdf.save());
      Fluttertoast.showToast(msg: 'PDF generated successfully');
    } catch (e) {
      Fluttertoast.showToast(msg: 'Export failed: $e');
    }
  }

  Future<void> _exportSingleMemberPDF(Map<String, dynamic> data) async {
    try {
      final pdf = pw.Document();

      final name = data['name']?.toString() ?? 'N/A';
      final regId = data['registrationId']?.toString() ?? 'N/A';
      final dept = data['department']?.toString() ?? 'N/A';
      final bloodGroup = data['bloodGroup']?.toString() ?? 'N/A';
      final mobile = data['mobile']?.toString() ?? 'N/A';
      final email = data['email']?.toString() ?? 'N/A';
      final profilePicUrl = data['profilePicUrl'];

      // Decode profile picture if available
      pw.MemoryImage? profileImage;
      if (profilePicUrl != null &&
          profilePicUrl.toString().startsWith('data:image')) {
        try {
          final base64Data = profilePicUrl.toString().split(',').last;
          final imageBytes = base64Decode(base64Data);
          profileImage = pw.MemoryImage(imageBytes);
        } catch (e) {
          // Ignore if image decode fails
        }
      }

      pdf.addPage(
        pw.Page(
          pageFormat: PdfPageFormat.a4,
          margin: const pw.EdgeInsets.all(40),
          build: (context) => pw.Column(
            crossAxisAlignment: pw.CrossAxisAlignment.start,
            children: [
              // Header with profile picture
              pw.Row(
                mainAxisAlignment: pw.MainAxisAlignment.spaceBetween,
                crossAxisAlignment: pw.CrossAxisAlignment.start,
                children: [
                  pw.Expanded(
                    child: pw.Column(
                      crossAxisAlignment: pw.CrossAxisAlignment.start,
                      children: [
                        pw.Text(
                          'INFYNERS',
                          style: pw.TextStyle(
                              fontSize: 28,
                              fontWeight: pw.FontWeight.bold,
                              color: PdfColors.indigo),
                        ),
                        pw.Text(
                          'Member Information',
                          style: const pw.TextStyle(
                              fontSize: 14, color: PdfColors.grey700),
                        ),
                        pw.SizedBox(height: 8),
                        pw.Text(
                          DateTime.now().toString().split(' ')[0],
                          style: const pw.TextStyle(
                              fontSize: 10, color: PdfColors.grey600),
                        ),
                      ],
                    ),
                  ),
                  // Profile Picture
                  if (profileImage != null)
                    pw.Container(
                      width: 100,
                      height: 100,
                      decoration: pw.BoxDecoration(
                        border:
                            pw.Border.all(color: PdfColors.indigo, width: 3),
                        borderRadius:
                            const pw.BorderRadius.all(pw.Radius.circular(8)),
                      ),
                      child: pw.ClipRRect(
                        horizontalRadius: 6,
                        verticalRadius: 6,
                        child: pw.Image(profileImage, fit: pw.BoxFit.cover),
                      ),
                    )
                  else
                    pw.Container(
                      width: 100,
                      height: 100,
                      decoration: pw.BoxDecoration(
                        color: PdfColors.indigo100,
                        border:
                            pw.Border.all(color: PdfColors.indigo, width: 3),
                        borderRadius:
                            const pw.BorderRadius.all(pw.Radius.circular(8)),
                      ),
                      child: pw.Center(
                        child: pw.Text(
                          name.isNotEmpty ? name[0].toUpperCase() : '?',
                          style: pw.TextStyle(
                            fontSize: 48,
                            fontWeight: pw.FontWeight.bold,
                            color: PdfColors.indigo,
                          ),
                        ),
                      ),
                    ),
                ],
              ),
              pw.SizedBox(height: 30),
              pw.Divider(thickness: 2, color: PdfColors.indigo),
              pw.SizedBox(height: 30),

              // Member details
              _buildPDFInfoRow('Full Name', name),
              pw.SizedBox(height: 16),
              _buildPDFInfoRow('Registration ID', regId),
              pw.SizedBox(height: 16),
              _buildPDFInfoRow('Department', dept),
              pw.SizedBox(height: 16),
              _buildPDFInfoRow('Blood Group', bloodGroup),
              pw.SizedBox(height: 16),
              _buildPDFInfoRow('Mobile Number', mobile),
              pw.SizedBox(height: 16),
              _buildPDFInfoRow('Email Address', email),

              pw.Spacer(),
              pw.Divider(color: PdfColors.grey400),
              pw.SizedBox(height: 10),
              pw.Row(
                mainAxisAlignment: pw.MainAxisAlignment.spaceBetween,
                children: [
                  pw.Text(
                    'This is an auto-generated document from INFYNERS app.',
                    style: const pw.TextStyle(
                        fontSize: 8, color: PdfColors.grey600),
                  ),
                  pw.Text(
                    'Confidential',
                    style: pw.TextStyle(
                      fontSize: 8,
                      fontWeight: pw.FontWeight.bold,
                      color: PdfColors.grey700,
                    ),
                  ),
                ],
              ),
            ],
          ),
        ),
      );

      await Printing.layoutPdf(onLayout: (format) => pdf.save());
      Fluttertoast.showToast(msg: 'Member PDF generated');
    } catch (e) {
      Fluttertoast.showToast(msg: 'Export failed: $e');
    }
  }

  pw.Widget _buildPDFInfoRow(String label, String value) {
    return pw.Column(
      crossAxisAlignment: pw.CrossAxisAlignment.start,
      children: [
        pw.Text(
          label,
          style: pw.TextStyle(
              fontSize: 10,
              fontWeight: pw.FontWeight.bold,
              color: PdfColors.grey700),
        ),
        pw.SizedBox(height: 4),
        pw.Container(
          padding: const pw.EdgeInsets.symmetric(horizontal: 12, vertical: 8),
          decoration: pw.BoxDecoration(
            border: pw.Border.all(color: PdfColors.grey400),
            borderRadius: const pw.BorderRadius.all(pw.Radius.circular(4)),
          ),
          child: pw.Text(
            value,
            style: const pw.TextStyle(fontSize: 12),
          ),
        ),
      ],
    );
  }

  @override
  Widget build(BuildContext context) {
    return Scaffold(
      backgroundColor: darkBg,
      appBar: AppBar(
        backgroundColor: darkBg,
        elevation: 0,
        title: ShaderMask(
          shaderCallback: (bounds) => const LinearGradient(
            colors: [neonCyan, electricPurple],
          ).createShader(bounds),
          child: Text(
            'Members',
            style: GoogleFonts.outfit(
              fontWeight: FontWeight.bold,
              fontSize: 22,
              color: Colors.white,
            ),
          ),
        ),
        leading: IconButton(
          icon: const Icon(Icons.arrow_back, color: Colors.white),
          onPressed: () => Navigator.pop(context),
        ),
      ),
      body: Container(
        decoration: BoxDecoration(
          gradient: LinearGradient(
            begin: Alignment.topLeft,
            end: Alignment.bottomRight,
            colors: [
              darkBg,
              const Color(0xFF1A1F3A),
              electricPurple.withOpacity(0.1),
            ],
          ),
        ),
        child: StreamBuilder<QuerySnapshot>(
          stream: FirebaseFirestore.instance.collection('users').snapshots(),
          builder: (context, snapshot) {
            if (snapshot.hasError) {
              return Center(
                child: Column(
                  mainAxisAlignment: MainAxisAlignment.center,
                  children: [
                    const Icon(Icons.error, size: 48, color: Colors.red),
                    const SizedBox(height: 16),
                    Text('Error loading members:\n${snapshot.error}'),
                    const SizedBox(height: 16),
                    ElevatedButton(
                      onPressed: () => setState(() {}),
                      child: const Text('Retry'),
                    ),
                  ],
                ),
              );
            }

            if (snapshot.connectionState == ConnectionState.waiting) {
              return const Center(child: CircularProgressIndicator());
            }

            final members = snapshot.data?.docs ?? [];

            if (members.isEmpty) {
              return const Center(child: Text('No members found'));
            }

            final activeMembers = members.where((doc) {
              final data = doc.data() as Map<String, dynamic>;
              return data['isActive'] != false;
            }).length;
            final deactivatedMembers = members.length - activeMembers;

            return Column(
              children: [
                // Statistics Cards
                Container(
                  padding: const EdgeInsets.all(16),
                  decoration: BoxDecoration(
                    gradient: LinearGradient(
                      colors: [
                        neonCyan.withOpacity(0.2),
                        electricPurple.withOpacity(0.2)
                      ],
                      begin: Alignment.topLeft,
                      end: Alignment.bottomRight,
                    ),
                    border: Border.all(
                      color: neonCyan.withOpacity(0.3),
                      width: 1.5,
                    ),
                  ),
                  child: Column(
                    crossAxisAlignment: CrossAxisAlignment.start,
                    children: [
                      Text(
                        'Members Overview',
                        style: GoogleFonts.outfit(
                          fontSize: 22,
                          fontWeight: FontWeight.bold,
                          color: Colors.white,
                        ),
                      ),
                      const SizedBox(height: 16),
                      Row(
                        children: [
                          Expanded(
                            child: _buildStatCard(
                              'Total',
                              members.length.toString(),
                              Icons.people,
                              Colors.white,
                              neonCyan,
                            ),
                          ),
                          const SizedBox(width: 12),
                          Expanded(
                            child: _buildStatCard(
                              'Active',
                              activeMembers.toString(),
                              Icons.check_circle,
                              Colors.white,
                              accentGreen,
                            ),
                          ),
                          const SizedBox(width: 12),
                          Expanded(
                            child: _buildStatCard(
                              'Inactive',
                              deactivatedMembers.toString(),
                              Icons.block,
                              Colors.white,
                              accentPink,
                            ),
                          ),
                        ],
                      ),
                    ],
                  ),
                ),

                // Enhanced Export Section
                Container(
                  margin: const EdgeInsets.all(16),
                  padding: const EdgeInsets.all(16),
                  decoration: BoxDecoration(
                    color: Colors.white,
                    borderRadius: BorderRadius.circular(16),
                    boxShadow: [
                      BoxShadow(
                        color: Colors.grey.shade300,
                        blurRadius: 8,
                        offset: const Offset(0, 2),
                      ),
                    ],
                  ),
                  child: Column(
                    crossAxisAlignment: CrossAxisAlignment.start,
                    children: [
                      Row(
                        children: [
                          Container(
                            padding: const EdgeInsets.all(8),
                            decoration: BoxDecoration(
                              color: Colors.red.shade50,
                              borderRadius: BorderRadius.circular(8),
                            ),
                            child: Icon(Icons.picture_as_pdf,
                                color: Colors.red.shade700),
                          ),
                          const SizedBox(width: 12),
                          const Expanded(
                            child: Column(
                              crossAxisAlignment: CrossAxisAlignment.start,
                              children: [
                                Text(
                                  'Export to PDF',
                                  style: TextStyle(
                                    fontSize: 18,
                                    fontWeight: FontWeight.bold,
                                    color: Colors.white,
                                  ),
                                ),
                                Text(
                                  'Select fields to include in export',
                                  style: TextStyle(
                                    fontSize: 12,
                                    color: Color(0xFFB0B0B0),
                                  ),
                                ),
                              ],
                            ),
                          ),
                        ],
                      ),
                      const SizedBox(height: 16),
                      Wrap(
                        spacing: 8,
                        runSpacing: 8,
                        children: [
                          _buildFieldChip('name', 'Name'),
                          _buildFieldChip('registrationId', 'Reg ID'),
                          _buildFieldChip('department', 'Department'),
                          _buildFieldChip('bloodGroup', 'Blood Group'),
                          _buildFieldChip('mobile', 'Mobile'),
                          _buildFieldChip('email', 'Email'),
                        ],
                      ),
                      const SizedBox(height: 16),
                      Row(
                        children: [
                          Expanded(
                            child: Container(
                              decoration: BoxDecoration(
                                gradient: const LinearGradient(
                                  colors: [accentPink, electricPurple],
                                ),
                                borderRadius: BorderRadius.circular(12),
                                boxShadow: [
                                  BoxShadow(
                                    color: accentPink.withOpacity(0.4),
                                    blurRadius: 15,
                                    offset: const Offset(0, 8),
                                  ),
                                ],
                              ),
                              child: ElevatedButton.icon(
                                onPressed: _selectedFields.isEmpty
                                    ? null
                                    : () => _exportAllMembersPDF(members),
                                icon: const Icon(Icons.download),
                                label: Text('Export ${members.length} Members',
                                    style: GoogleFonts.outfit(
                                        fontWeight: FontWeight.bold)),
                                style: ElevatedButton.styleFrom(
                                  backgroundColor: Colors.transparent,
                                  foregroundColor: Colors.white,
                                  disabledBackgroundColor: Colors.grey.shade800,
                                  shadowColor: Colors.transparent,
                                  padding:
                                      const EdgeInsets.symmetric(vertical: 14),
                                  shape: RoundedRectangleBorder(
                                    borderRadius: BorderRadius.circular(12),
                                  ),
                                ),
                              ),
                            ),
                          ),
                        ],
                      ),
                      if (_selectedFields.isEmpty)
                        Padding(
                          padding: const EdgeInsets.only(top: 8),
                          child: Row(
                            children: [
                              Icon(Icons.info_outline,
                                  size: 16, color: Colors.orange.shade700),
                              const SizedBox(width: 6),
                              Text(
                                'Please select at least one field to export',
                                style: TextStyle(
                                  fontSize: 12,
                                  color: Colors.orange.shade700,
                                ),
                              ),
                            ],
                          ),
                        ),
                    ],
                  ),
                ),
                // Members list
                Expanded(
                  child: ListView.builder(
                    itemCount: members.length,
                    itemBuilder: (context, index) {
                      final doc = members[index];
                      final data = doc.data() as Map<String, dynamic>;

                      final name = data['name']?.toString() ?? 'No Name';
                      final regId = data['registrationId']?.toString() ?? '';
                      final dept = data['department']?.toString() ?? '';
                      final bloodGroup = data['bloodGroup']?.toString() ?? '';
                      final mobile = data['mobile']?.toString() ?? '';
                      final email = data['email']?.toString() ?? '';
                      final profilePicUrl = data['profilePicUrl'];
                      final isActive = data['isActive'] ?? true;

                      ImageProvider? avatarImage;
                      if (profilePicUrl != null) {
                        if (profilePicUrl.startsWith('data:image')) {
                          final base64Data = profilePicUrl.split(',').last;
                          avatarImage = MemoryImage(base64Decode(base64Data));
                        } else {
                          avatarImage = NetworkImage(profilePicUrl);
                        }
                      }

                      return Container(
                        margin: const EdgeInsets.symmetric(
                            horizontal: 16, vertical: 8),
                        decoration: BoxDecoration(
                          gradient: LinearGradient(
                            begin: Alignment.topLeft,
                            end: Alignment.bottomRight,
                            colors: isActive
                                ? [
                                    neonCyan.withOpacity(0.1),
                                    electricPurple.withOpacity(0.1),
                                  ]
                                : [
                                    accentPink.withOpacity(0.2),
                                    Colors.red.withOpacity(0.2),
                                  ],
                          ),
                          borderRadius: BorderRadius.circular(16),
                          border: Border.all(
                            color: isActive
                                ? neonCyan.withOpacity(0.3)
                                : accentPink.withOpacity(0.5),
                            width: 1.5,
                          ),
                          boxShadow: [
                            BoxShadow(
                              color: isActive
                                  ? neonCyan.withOpacity(0.2)
                                  : accentPink.withOpacity(0.3),
                              blurRadius: 15,
                              offset: const Offset(0, 8),
                            ),
                          ],
                        ),
                        child: ExpansionTile(
                          shape: RoundedRectangleBorder(
                            borderRadius: BorderRadius.circular(16),
                          ),
                          iconColor: isActive ? neonCyan : accentPink,
                          collapsedIconColor: isActive ? neonCyan : accentPink,
                          leading: Stack(
                            children: [
                              Container(
                                decoration: BoxDecoration(
                                  shape: BoxShape.circle,
                                  border: Border.all(
                                    color: isActive ? neonCyan : accentPink,
                                    width: 2,
                                  ),
                                ),
                                child: CircleAvatar(
                                  radius: 22,
                                  backgroundColor: darkCard,
                                  backgroundImage: avatarImage,
                                  child: profilePicUrl == null
                                      ? Text(
                                          name[0].toUpperCase(),
                                          style: TextStyle(
                                            color: isActive
                                                ? neonCyan
                                                : accentPink,
                                            fontWeight: FontWeight.bold,
                                          ),
                                        )
                                      : null,
                                ),
                              ),
                              if (!isActive)
                                Positioned(
                                  right: 0,
                                  bottom: 0,
                                  child: Container(
                                    padding: const EdgeInsets.all(2),
                                    decoration: BoxDecoration(
                                      color: accentPink,
                                      shape: BoxShape.circle,
                                      border:
                                          Border.all(color: darkBg, width: 2),
                                    ),
                                    child: const Icon(
                                      Icons.block,
                                      size: 10,
                                      color: Colors.white,
                                    ),
                                  ),
                                ),
                            ],
                          ),
                          title: Row(
                            children: [
                              Expanded(
                                child: Text(name,
                                    style: GoogleFonts.outfit(
                                        fontWeight: FontWeight.bold,
                                        color: Colors.white)),
                              ),
                              if (!isActive)
                                Container(
                                  padding: const EdgeInsets.symmetric(
                                      horizontal: 8, vertical: 2),
                                  decoration: BoxDecoration(
                                    color: accentPink,
                                    borderRadius: BorderRadius.circular(12),
                                    boxShadow: [
                                      BoxShadow(
                                        color: accentPink.withOpacity(0.4),
                                        blurRadius: 8,
                                      ),
                                    ],
                                  ),
                                  child: Text(
                                    'DEACTIVATED',
                                    style: GoogleFonts.outfit(
                                      fontSize: 10,
                                      color: Colors.white,
                                      fontWeight: FontWeight.bold,
                                    ),
                                  ),
                                ),
                            ],
                          ),
                          subtitle: Text(regId.isNotEmpty ? regId : email,
                              style: GoogleFonts.outfit(
                                  color: Colors.white.withOpacity(0.7))),
                          children: [
                            Padding(
                              padding: const EdgeInsets.all(16),
                              child: Column(
                                crossAxisAlignment: CrossAxisAlignment.start,
                                children: [
                                  if (regId.isNotEmpty)
                                    _buildInfoRow('ID', regId),
                                  if (dept.isNotEmpty)
                                    _buildInfoRow('Department', dept),
                                  if (bloodGroup.isNotEmpty)
                                    _buildInfoRow('Blood Group', bloodGroup),
                                  if (mobile.isNotEmpty)
                                    _buildInfoRow('Mobile', mobile),
                                  _buildInfoRow('Email', email),
                                  if (!isActive)
                                    Container(
                                      margin: const EdgeInsets.only(top: 8),
                                      padding: const EdgeInsets.all(12),
                                      decoration: BoxDecoration(
                                        color: Colors.red.shade100,
                                        borderRadius: BorderRadius.circular(8),
                                        border: Border.all(
                                            color: Colors.red.shade300),
                                      ),
                                      child: const Row(
                                        children: [
                                          Icon(Icons.info_outline,
                                              color: Colors.red, size: 20),
                                          SizedBox(width: 8),
                                          Expanded(
                                            child: Text(
                                              'This user account is currently deactivated',
                                              style: TextStyle(
                                                color: Colors.red,
                                                fontWeight: FontWeight.w500,
                                              ),
                                            ),
                                          ),
                                        ],
                                      ),
                                    ),
                                  const SizedBox(height: 16),
                                  Row(
                                    mainAxisAlignment: MainAxisAlignment.center,
                                    children: [
                                      if (isActive) ...[
                                        ElevatedButton.icon(
                                          onPressed: () =>
                                              _exportSingleMemberPDF(data),
                                          icon: const Icon(Icons.picture_as_pdf,
                                              size: 18),
                                          label: const Text('Export PDF'),
                                          style: ElevatedButton.styleFrom(
                                            backgroundColor: Colors.red,
                                            foregroundColor: Colors.white,
                                          ),
                                        ),
                                        const SizedBox(width: 12),
                                        ElevatedButton.icon(
                                          onPressed: () =>
                                              _deleteUser(doc.id, name),
                                          icon: const Icon(
                                              Icons.manage_accounts,
                                              size: 18),
                                          label: const Text('Manage User'),
                                          style: ElevatedButton.styleFrom(
                                            backgroundColor:
                                                Colors.orange.shade700,
                                            foregroundColor: Colors.white,
                                          ),
                                        ),
                                      ] else ...[
                                        ElevatedButton.icon(
                                          onPressed: () async {
                                            final confirm =
                                                await showDialog<bool>(
                                              context: context,
                                              builder: (context) => AlertDialog(
                                                title: const Text(
                                                    'Reactivate User'),
                                                content: Text(
                                                    'Reactivate "$name"?\n\nThey will be able to login and access the app again.'),
                                                actions: [
                                                  TextButton(
                                                    onPressed: () =>
                                                        Navigator.pop(
                                                            context, false),
                                                    child: const Text('Cancel'),
                                                  ),
                                                  ElevatedButton(
                                                    onPressed: () =>
                                                        Navigator.pop(
                                                            context, true),
                                                    style: ElevatedButton
                                                        .styleFrom(
                                                            backgroundColor:
                                                                Colors.green),
                                                    child: const Text(
                                                        'Reactivate'),
                                                  ),
                                                ],
                                              ),
                                            );

                                            if (confirm == true) {
                                              try {
                                                await FirebaseFirestore.instance
                                                    .collection('users')
                                                    .doc(doc.id)
                                                    .update({
                                                  'isActive': true,
                                                  'reactivatedAt': FieldValue
                                                      .serverTimestamp(),
                                                  'reactivatedBy': FirebaseAuth
                                                      .instance
                                                      .currentUser
                                                      ?.uid,
                                                });
                                                Fluttertoast.showToast(
                                                    msg:
                                                        'User "$name" has been reactivated');
                                              } catch (e) {
                                                Fluttertoast.showToast(
                                                    msg:
                                                        'Failed to reactivate: $e');
                                              }
                                            }
                                          },
                                          icon: const Icon(Icons.check_circle,
                                              size: 18),
                                          label: const Text('Reactivate User'),
                                          style: ElevatedButton.styleFrom(
                                            backgroundColor: Colors.green,
                                            foregroundColor: Colors.white,
                                          ),
                                        ),
                                      ],
                                    ],
                                  ),
                                ],
                              ),
                            ),
                          ],
                        ),
                      );
                    },
                  ),
                ),
              ],
            );
          },
        ),
      ),
    );
  }

  Widget _buildFieldChip(String field, String label) {
    final isSelected = _selectedFields.contains(field);

    IconData icon;
    switch (field) {
      case 'name':
        icon = Icons.person;
        break;
      case 'registrationId':
        icon = Icons.badge;
        break;
      case 'department':
        icon = Icons.business;
        break;
      case 'bloodGroup':
        icon = Icons.water_drop;
        break;
      case 'mobile':
        icon = Icons.phone;
        break;
      case 'email':
        icon = Icons.email;
        break;
      default:
        icon = Icons.check_box_outline_blank;
    }

    return FilterChip(
      label: Row(
        mainAxisSize: MainAxisSize.min,
        children: [
          Icon(icon, size: 16),
          const SizedBox(width: 6),
          Text(label),
        ],
      ),
      selected: isSelected,
      onSelected: (selected) {
        setState(() {
          if (selected) {
            _selectedFields.add(field);
          } else {
            _selectedFields.remove(field);
          }
        });
      },
      selectedColor: Colors.blue.shade100,
      checkmarkColor: Colors.blue.shade700,
      backgroundColor: Colors.grey.shade100,
      side: BorderSide(
        color: isSelected ? Colors.blue.shade700 : Colors.grey.shade300,
        width: 1.5,
      ),
      shape: RoundedRectangleBorder(
        borderRadius: BorderRadius.circular(20),
      ),
      padding: const EdgeInsets.symmetric(horizontal: 8, vertical: 4),
    );
  }

  Widget _buildInfoRow(String label, String value) {
    IconData icon;
    switch (label) {
      case 'ID':
        icon = Icons.badge;
        break;
      case 'Department':
        icon = Icons.business;
        break;
      case 'Blood Group':
        icon = Icons.water_drop;
        break;
      case 'Mobile':
        icon = Icons.phone;
        break;
      case 'Email':
        icon = Icons.email;
        break;
      default:
        icon = Icons.info;
    }

    return Container(
      margin: const EdgeInsets.only(bottom: 8),
      padding: const EdgeInsets.all(12),
      decoration: BoxDecoration(
        gradient: LinearGradient(
          colors: [
            neonCyan.withOpacity(0.1),
            electricPurple.withOpacity(0.1),
          ],
        ),
        borderRadius: BorderRadius.circular(8),
        border: Border.all(
          color: neonCyan.withOpacity(0.2),
          width: 1,
        ),
      ),
      child: Row(
        children: [
          Icon(icon, size: 20, color: neonCyan),
          const SizedBox(width: 12),
          Expanded(
            child: Column(
              crossAxisAlignment: CrossAxisAlignment.start,
              children: [
                Text(
                  label,
                  style: GoogleFonts.outfit(
                    fontSize: 11,
                    fontWeight: FontWeight.w600,
                    color: Colors.white.withOpacity(0.7),
                  ),
                ),
                const SizedBox(height: 2),
                Text(
                  value,
                  style: GoogleFonts.outfit(
                    fontSize: 14,
                    fontWeight: FontWeight.w500,
                    color: Colors.white,
                  ),
                ),
              ],
            ),
          ),
        ],
      ),
    );
  }

  Widget _buildStatCard(String label, String value, IconData icon,
      Color bgColor, Color textColor) {
    return Container(
      padding: const EdgeInsets.all(12),
      decoration: BoxDecoration(
        color: bgColor,
        borderRadius: BorderRadius.circular(12),
        boxShadow: [
          BoxShadow(
            color: Colors.black.withOpacity(0.1),
            blurRadius: 4,
            offset: const Offset(0, 2),
          ),
        ],
      ),
      child: Column(
        children: [
          Icon(icon, color: textColor, size: 28),
          const SizedBox(height: 8),
          Text(
            value,
            style: TextStyle(
              fontSize: 24,
              fontWeight: FontWeight.bold,
              color: textColor,
            ),
          ),
          Text(
            label,
            style: TextStyle(
              fontSize: 12,
              color: textColor.withOpacity(0.8),
            ),
          ),
        ],
      ),
    );
  }

  // PDF helper for stat chips in export layout
  pw.Widget _pdfStatChip(String label, String value, PdfColor color) {
    return pw.Container(
      padding: const pw.EdgeInsets.symmetric(horizontal: 10, vertical: 6),
      decoration: pw.BoxDecoration(
        border: pw.Border.all(color: color, width: 0.6),
        borderRadius: const pw.BorderRadius.all(pw.Radius.circular(16)),
        color: PdfColors.white,
      ),
      child: pw.Row(
        mainAxisSize: pw.MainAxisSize.min,
        children: [
          pw.Container(
            width: 6,
            height: 6,
            decoration: pw.BoxDecoration(
              color: color,
              borderRadius: const pw.BorderRadius.all(pw.Radius.circular(3)),
            ),
          ),
          pw.SizedBox(width: 6),
          pw.Text(
            '$label: ',
            style: pw.TextStyle(
                fontSize: 9, fontWeight: pw.FontWeight.bold, color: color),
          ),
          pw.Text(
            value,
            style: const pw.TextStyle(fontSize: 9, color: PdfColors.grey800),
          ),
        ],
      ),
    );
  }
}
